<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>CNC GCode Viewer v0.3.0</title><style>:root[data-theme="light"]{--bg-color:#ffffff;--text-color:#333333;--border-color:#cccccc;--panel-bg:#f5f5f5;--button-bg:#e0e0e0;--button-hover:#d0d0d0;--canvas-bg:#fafafa;--rapid-color:#999999;--cut-color:#0066cc;--grid-color:#e0e0e0;--gcode-comment:#808080;--gcode-g-code:#0066aa;--gcode-m-code:#8b3e8e;--gcode-t-code:#b5640f;--gcode-s-code:#008577;--gcode-f-code:#a65e3e;--gcode-coordinate:#6a8759;--gcode-system:#cc7000;--gcode-x-axis:#1976d2;--gcode-y-axis:#388e3c;--gcode-z-axis:#7b1fa2;}:root[data-theme="dark"]{--bg-color:#1e1e1e;--text-color:#e0e0e0;--border-color:#444444;--panel-bg:#2d2d2d;--button-bg:#3d3d3d;--button-hover:#4d4d4d;--canvas-bg:#252525;--rapid-color:#ff9933;--cut-color:#00ccff;--grid-color:#3a3a3a;--gcode-comment:#999999;--gcode-g-code:#4fc3ff;--gcode-m-code:#e1aaff;--gcode-t-code:#ffd180;--gcode-s-code:#80cbc4;--gcode-f-code:#ffab91;--gcode-coordinate:#8fd6a3;--gcode-system:#ffb84d;--gcode-x-axis:#42a5f5;--gcode-y-axis:#66bb6a;--gcode-z-axis:#ba68c8;}:root[data-theme="dark"] *::-webkit-scrollbar{width:16px;height:16px;}:root[data-theme="dark"] *::-webkit-scrollbar-track{background:#2a2a2a;}:root[data-theme="dark"] *::-webkit-scrollbar-thumb{background:#555555;border-radius:8px;border:3px solid #2a2a2a;}:root[data-theme="dark"] *::-webkit-scrollbar-thumb:hover{background:#666666;}:root[data-theme="dark"] *{scrollbar-width:auto;scrollbar-color:#555555 #2a2a2a;}*{margin:0;padding:0;box-sizing:border-box;}body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,sans-serif;background-color:var(--bg-color);color:var(--text-color);overflow:hidden;height:100vh;}.container{display:grid;grid-template-columns:400px 1fr 360px;grid-template-rows:60px 1fr 40px;height:100vh;gap:0;}header{grid-column:1 / -1;grid-row:1;background-color:var(--panel-bg);border-bottom:1px solid var(--border-color);display:flex;align-items:center;justify-content:space-between;padding:0 20px;}header h1{font-size:1.5rem;font-weight:600;}.header-controls{display:flex;gap:10px;align-items:center;}.header-controls a{text-decoration:none;color:var(--text-color);padding:8px 16px;background-color:var(--button-bg);border:1px solid var(--border-color);border-radius:4px;font-size:0.9rem;transition:background-color 0.2s;display:inline-flex;align-items:center;justify-content:center;box-sizing:border-box;line-height:1;min-height:38px;}.header-controls a:hover{background-color:var(--button-hover);}button{background-color:var(--button-bg);color:var(--text-color);border:1px solid var(--border-color);padding:8px 16px;border-radius:4px;cursor:pointer;font-size:14px;transition:background-color 0.2s;}button:hover{background-color:var(--button-hover);}button:active{transform:translateY(1px);}button:disabled{opacity:0.5;cursor:not-allowed;}.canvas-container{position:relative;background-color:var(--canvas-bg);overflow:hidden;grid-column:2;grid-row:2;}.canvas-overlay-controls{position:absolute;top:10px;right:10px;display:flex;gap:10px;z-index:10;}.canvas-overlay-controls button{padding:8px 16px;background-color:rgba(0,0,0,0.7);color:white;border:1px solid rgba(255,255,255,0.3);border-radius:4px;cursor:pointer;font-size:14px;backdrop-filter:blur(5px);}.canvas-overlay-controls button:hover{background-color:rgba(0,0,0,0.85);}.canvas-overlay-controls button:disabled{opacity:0.5;cursor:not-allowed;}canvas{display:block;width:100%;height:100%;cursor:grab;}canvas:active{cursor:grabbing;}#canvas2d,#canvas3d{position:absolute;top:0;left:0;}#canvas3d-overlay{position:absolute;top:0;left:0;pointer-events:none;}.hidden{display:none !important;}.sidebar{background-color:var(--panel-bg);border-left:1px solid var(--border-color);overflow-y:auto;padding:20px;grid-column:3;grid-row:2;}.left-sidebar{background-color:var(--panel-bg);border-right:1px solid var(--border-color);padding:0;display:flex;flex-direction:column;overflow:hidden;grid-column:1;grid-row:2;min-height:0;height:100%;}#gcode-panel{display:flex !important;flex:1;flex-direction:column;overflow:hidden;min-height:0;height:100%;padding:10px;margin:20px;}#gcode-panel h3{margin:10px 0 10px 0;flex-shrink:0;}#gcode-panel{display:flex !important;flex:1;flex-direction:column;overflow:hidden;min-height:0;}#gcode-container{flex:1;overflow-y:auto;overflow-x:auto;background-color:var(--canvas-bg);border:none;font-family:'Consolas','Monaco',monospace;font-size:11px;line-height:17px;min-height:0;padding-bottom:10px;margin-bottom:5px;}#gcode-content{display:flex;}.gcode-line-numbers{color:var(--text-muted);text-align:right;padding:4px 8px 4px 4px;user-select:none;border-right:1px solid var(--border-color);min-width:30px;}.gcode-code{flex:1;padding:4px;white-space:pre;}.gcode-line{cursor:pointer;}.gcode-line:hover{background-color:rgba(255,255,255,0.05) !important;}.gcode-line.highlight{background-color:rgba(255,193,7,0.3) !important;}.gcode-line-numbers .gcode-line.highlight{border-left:3px solid rgba(255,193,7,0.8) !important;padding-left:2px !important;}.gcode-comment{color:var(--gcode-comment);}.gcode-g-code{color:var(--gcode-g-code);font-weight:bold;}.gcode-m-code{color:var(--gcode-m-code);font-weight:bold;}.gcode-t-code{color:var(--gcode-t-code);font-weight:bold;}.gcode-s-code{color:var(--gcode-s-code);}.gcode-f-code{color:var(--gcode-f-code);}.gcode-coordinate{color:var(--gcode-coordinate);}.gcode-system{color:var(--gcode-system);font-weight:bold;}.gcode-x-axis{color:var(--gcode-x-axis);font-weight:500;}.gcode-y-axis{color:var(--gcode-y-axis);font-weight:500;}.gcode-z-axis{color:var(--gcode-z-axis);font-weight:500;}.gcode-hidden{display:none !important;}.panel{background-color:var(--bg-color);border:1px solid var(--border-color);border-radius:4px;padding:15px;margin-bottom:15px;}.panel h3{font-size:1rem;margin-bottom:10px;font-weight:600;}.file-upload-zone{border:2px dashed var(--border-color);border-radius:4px;padding:30px;text-align:center;cursor:pointer;transition:border-color 0.2s;}.file-upload-zone:hover{border-color:var(--cut-color);}.file-upload-zone.drag-over{border-color:var(--cut-color);background-color:var(--canvas-bg);}input[type="file"]{display:none;}select{width:100%;padding:8px;background-color:var(--button-bg);color:var(--text-color);border:1px solid var(--border-color);border-radius:4px;font-size:14px;cursor:pointer;margin-top:10px;}input[type="range"]{width:100%;margin-top:10px;}.stats-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px;}.stat-item{background-color:var(--panel-bg);padding:8px;border-radius:4px;}.stat-label{font-size:11px;opacity:0.7;text-transform:uppercase;}.stat-value{font-size:16px;font-weight:600;margin-top:2px;}.progress-bar{width:100%;height:4px;background-color:var(--border-color);border-radius:2px;overflow:hidden;margin-top:10px;position:relative;}.progress-bar.indeterminate .progress-fill{width:30% !important;animation:indeterminate 1.5s ease-in-out infinite;}@keyframes indeterminate{0%{transform:translateX(-100%);}50%{transform:translateX(350%);}100%{transform:translateX(-100%);}}.progress-fill{height:100%;background-color:var(--cut-color);width:0%;transition:width 0.3s;}.animation-controls{margin-top:15px;}.controls-row{display:flex;gap:5px;margin-bottom:10px;}.controls-row button{flex:1;padding:6px;font-size:12px;}.layer-controls{margin-top:10px;}.layer-inputs{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px;}.layer-inputs > div{display:flex;flex-direction:column;}.layer-inputs input{width:100%;padding:6px;background-color:var(--button-bg);color:var(--text-color);border:1px solid var(--border-color);border-radius:4px;font-size:14px;box-sizing:border-box;}footer{grid-column:1 / -1;grid-row:3;background-color:var(--panel-bg);border-top:1px solid var(--border-color);display:flex;align-items:center;justify-content:space-between;padding:0 20px;font-size:12px;}.coordinate-display{font-family:'Courier New',monospace;}.privacy-notice{font-size:11px;opacity:0.7;margin-top:15px;padding-top:15px;border-top:1px solid var(--border-color);text-align:center;}.mobile-tabs{display:none;background-color:var(--panel-bg);border-bottom:1px solid var(--border-color);overflow-x:auto;overflow-y:hidden;}.mobile-tabs-nav{display:flex;gap:0;min-width:100%;}.mobile-tab-button{flex:1;padding:12px 16px;background:none;border:none;border-bottom:3px solid transparent;cursor:pointer;font-size:14px;color:var(--text-color);transition:all 0.2s;white-space:nowrap;}.mobile-tab-button:hover{background-color:rgba(0,0,0,0.05);}.mobile-tab-button.active{border-bottom-color:#0066aa;font-weight:bold;}.mobile-tab-content{display:none;}.mobile-tab-content.active{display:block;}@media (min-width:969px){.mobile-tab-content{display:block !important;}}@media (max-width:1200px){.container{grid-template-columns:300px 1fr 300px;}}@media (max-width:968px){.container{grid-template-columns:1fr;grid-template-rows:auto 1fr;}body{overflow:hidden;height:100vh;height:100dvh;}header{position:absolute;width:0;height:0;overflow:hidden;visibility:hidden;}.mobile-tabs{display:block;grid-row:1;}.canvas-overlay-controls{top:5px;right:5px;gap:5px;}.canvas-overlay-controls button{padding:6px 10px;font-size:12px;}.header-controls button{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}#btn-play::before{content:'‚ñ∂Ô∏è ';}#btn-step-back::before{content:'‚èÆÔ∏è ';}#btn-step-forward::before{content:'‚è≠Ô∏è ';}#btn-reset-animation::before{content:'‚èπÔ∏è ';}.file-upload-zone::before{content:'üìÅ\A';white-space:pre;font-size:2em;display:block;margin-bottom:10px;}.left-sidebar{grid-row:2;grid-column:1;border-right:none;border-top:1px solid var(--border-color);overflow:hidden;padding:0;}#gcode-panel{display:flex !important;height:100%;flex-direction:column;}.canvas-container{grid-row:2;grid-column:1;width:100%;height:100%;position:relative;min-height:300px;}canvas{position:absolute;top:0;left:0;width:100% !important;height:100% !important;}.sidebar{grid-row:2;grid-column:1;border-left:none;border-top:1px solid var(--border-color);max-height:none;overflow-y:auto;overflow-y:auto;padding:10px;}.panel{margin-bottom:10px;padding:10px;}.stats-grid{grid-template-columns:repeat(2,1fr);}.slider-container{font-size:12px;}input[type="range"]{height:30px;}button{min-height:44px;font-size:14px;}footer{position:absolute;width:0;height:0;overflow:hidden;visibility:hidden;}}@media (max-width:480px){.header-controls{flex-wrap:wrap;}.header-controls button{flex:1 1 45%;margin:2px;}.stats-grid{grid-template-columns:1fr;}.panel h3{font-size:0.9rem;}.mobile-tab-button{padding:0px 12px;}#settings-tab .panel,#gcode-tab .panel,#gcode-panel{padding:6px;margin-bottom:6px;}#settings-tab .panel h3,#gcode-tab .panel h3,#gcode-panel h3{margin-bottom:4px;}#settings-tab .control-group,#gcode-tab .control-group{margin-bottom:6px;}#settings-tab .slider-container,#gcode-tab .slider-container{margin:4px 0;}#settings-tab label,#gcode-tab label{margin-bottom:2px;}#settings-tab input,#settings-tab select,#settings-tab button,#gcode-tab input,#gcode-tab select,#gcode-tab button{padding:6px 8px;}.container{padding:0 !important;}header{padding:0 4px;}.sidebar{padding:2px;}#gcode-panel{margin:6px;padding:4px;}#gcode-panel h3{margin:4px 0;}}@media (hover:none) and (pointer:coarse){button,input[type="checkbox"],input[type="color"]{min-height:44px;min-width:44px;}.slider-container input[type="range"]{height:44px;}.gcode-line{line-height:24px;height:24px;padding:2px 0;}}</style></head><body><div class="container"><header><h1>üìê CNC GCode Viewer</h1><div class="header-controls"><a href="https://github.com/jeyeager65/cnc-gcode-viewer" target="_blank"><svg width="20" height="20" viewBox="0 0 16 16" fill="currentColor" style="vertical-align: middle; margin-right: 6px;"><path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/></svg> GitHub </a></div></header><div class="mobile-tabs"><div class="mobile-tabs-nav"><button class="mobile-tab-button active" data-tab="settings">‚öôÔ∏è Settings</button><button class="mobile-tab-button" data-tab="display">üìä Display</button><button class="mobile-tab-button" data-tab="gcode">üìù GCode</button></div></div><aside class="left-sidebar mobile-tab-content gcode-hidden" data-tab-content="gcode"><div class="panel" id="gcode-panel" style="visibility: hidden; position: absolute;"><h3>GCode <span id="gcode-line-indicator" style="font-size: 12px; opacity: 0.7;"></span></h3><div id="gcode-container"><div id="gcode-content"><div class="gcode-line-numbers" id="gcode-line-numbers"></div><div class="gcode-code" id="gcode-display"></div></div></div></div><div class="panel" id="gcode-welcome" style="display: block; margin: 20px; padding: 20px;"><div style="margin-top: 0;"><h3>Getting Started</h3><ol style="font-size: 14px; line-height: 1.8; padding-left: 20px; opacity: 0.9;"><li>Drop a GCode file in the upload area or click to browse</li><li>Switch between 2D and 3D views using the toggle button</li><li>Use animation controls to step through execution</li><li>Adjust layer filtering to focus on specific Z-heights</li></ol></div><div style="margin-top: 20px;"><h3>Features</h3><ul style="font-size: 14px; line-height: 1.8; list-style: none; padding-left: 0; opacity: 0.9;"><li>‚úì Multi-tool support with color-coded paths</li><li>‚úì Animation with adjustable speed</li><li>‚úì Layer filtering by Z-height</li><li>‚úì Real-time statistics (time, dimensions, tool changes)</li><li>‚úì 2D and 3D visualization modes</li><li>‚úì Touch-friendly mobile interface</li></ul></div><div style="margin-top: 20px;"><h3>Navigation</h3><ul style="font-size: 14px; line-height: 1.8; list-style: circle; padding-left: 20px; opacity: 0.9;"><li><strong>2D View:</strong> Left or right click drag to pan, scroll to zoom</li><li><strong>3D View:</strong> Left click and drag to rotate, right click and drag to pan, scroll to zoom</li><li><strong>Mobile:</strong> One finger drag to rotate, two finger drag to pan, pinch to zoom</li><li><strong>Reset:</strong> Click "Reset View" to re-center</li></ul></div></div></aside><div class="canvas-container mobile-tab-content" data-tab-content="display"><div class="canvas-overlay-controls"><button id="btn-toggle-view">3D View</button><button id="btn-reset-view" disabled>Reset View</button></div><canvas id="canvas2d"></canvas><canvas id="canvas3d" class="hidden"></canvas><canvas id="canvas3d-overlay" class="hidden"></canvas></div><aside class="sidebar mobile-tab-content active" data-tab-content="settings"><div class="panel"><h3>Load File</h3><div class="file-upload-zone" id="upload-zone"><p>üìÅ Drop GCode file here<br>or click to browse</p><input type="file" id="file-input" accept=".nc,.gcode,.txt"></div><div class="progress-bar hidden" id="progress-bar"><div class="progress-fill" id="progress-fill"></div></div></div><div class="panel"><h3>Statistics</h3><div class="stats-grid"><div class="stat-item"><div class="stat-label">Segments</div><div class="stat-value" id="stat-lines">-</div></div><div class="stat-item"><div class="stat-label">Est. Time</div><div class="stat-value" id="stat-time">-</div></div><div class="stat-item"><div class="stat-label">X Range</div><div class="stat-value" id="stat-x">-</div></div><div class="stat-item"><div class="stat-label">Y Range</div><div class="stat-value" id="stat-y">-</div></div><div class="stat-item"><div class="stat-label">Z Range</div><div class="stat-value" id="stat-z">-</div></div></div></div><div class="panel" id="tool-panel" style="display: none;"><h3>Tools</h3><div id="tool-list" style="max-height: 400px; overflow-y: auto;"></div></div><div class="panel" id="rapid-moves-panel" style="display: none;"><h3>Rapid Moves (G0)</h3><div style="display: flex; align-items: center; gap: 8px; padding: 8px; background: var(--canvas-bg); border-radius: 4px;"><input type="checkbox" id="rapid-moves-visible" checked><input type="color" id="rapid-move-color" value="#999999" style="width: 32px; height: 24px; border: none; cursor: pointer;"><label for="rapid-moves-visible" style="flex: 1; font-size: 13px; cursor: pointer;">Show Travel Moves</label></div></div><div class="panel"><h3>View Controls</h3><div class="layer-controls"><div style="margin-bottom: 10px;"><label style="font-size: 12px; display: block; margin-bottom: 5px;">Theme</label><div style="display: flex; gap: 10px; margin-bottom: 15px;"><button id="theme-light" style="flex: 1; padding: 8px;">‚òÄÔ∏è Light</button><button id="theme-dark" style="flex: 1; padding: 8px;">üåô Dark</button></div></div><div style="margin-bottom: 10px;"><label style="font-size: 12px; display: block; margin-bottom: 5px;">Zoom</label><input type="range" id="zoom-slider" min="0.1" max="10" step="0.1" value="1" style="width: 100%;"><div style="text-align: center; font-size: 11px; margin-top: 5px;"><span id="zoom-value">100%</span></div></div></div></div><div class="panel" id="animation-panel" style="display: none;"><h3>Animation</h3><div class="animation-controls"><div class="controls-row"><button id="btn-play">Play</button><button id="btn-reset">Reset</button></div><div class="controls-row"><button id="btn-prev">‚óÄ Prev</button><button id="btn-next">Next ‚ñ∂</button></div><div><label>Speed: <span id="speed-label">1x</span></label><input type="range" id="speed-slider" min="-10" max="10" value="0" step="1"></div><div style="margin-top: 10px;"><label style="font-size: 12px; display: block; margin-bottom: 5px;">Segment: <span id="current-line">0</span> / <span id="total-lines">0</span></label><div style="font-size: 11px; opacity: 0.7; margin-bottom: 5px;">File Line: <span id="current-file-line">-</span></div><input type="range" id="line-slider" min="0" max="0" step="1" value="0" style="width: 100%;"></div></div></div><div class="panel"><h3>Layer Filter</h3><div class="layer-controls"><div class="layer-inputs"><div><label style="font-size: 12px;">Min Z</label><input type="number" id="layer-min" step="0.1" placeholder="Auto"></div><div><label style="font-size: 12px;">Max Z</label><input type="number" id="layer-max" step="0.1" placeholder="Auto"></div></div></div></div><div class="panel"><h3>3D Grid</h3><div class="layer-controls"><div style="margin-bottom: 10px;"><label style="display: flex; align-items: center; gap: 8px;"><input type="checkbox" id="grid-enabled" checked><span>Show Grid</span></label></div><div class="layer-inputs"><div><label style="font-size: 12px;">Width (X)</label><input type="number" id="grid-width" step="10" value="1200" min="0"></div><div><label style="font-size: 12px;">Height (Y)</label><input type="number" id="grid-height" step="10" value="2400" min="0"></div></div></div></div><div class="privacy-notice"> üîí All processing happens locally in your browser.<br>No data is transmitted. </div></aside><footer><div class="coordinate-display" id="coordinates">X: - Y: - Z: -</div><div>Version v0.3.0</div></footer></div><script>class GCodeParser{constructor(){this.reset()}reset(){this.position={x:0,y:0,z:0},this.units="mm",this.absolute=!0,this.plane="XY",this.feedRate=0,this.currentTool=1,this.toolNames=[],this.toolColors=[],this.parsingToolList=!1,this.inlineToolMap=new Map,this.inlineToolOccurrence=new Map,this.lastToolChangeType=null,this.segments=[],this.bounds={minX:1/0,maxX:-1/0,minY:1/0,maxY:-1/0,minZ:1/0,maxZ:-1/0}}async parseString(t,e){this.reset();const s=t.split("\n"),i=s.length;for(let t=0;t<i;t++)this.parseLine(s[t].trim(),t+1),e&&t%1e3==0&&e(Math.min(100,(t+1)/i*100));return e&&e(100),this.segments}async parseFile(t,e){this.reset();const s=await t.text();return this.parseString(s,e)}readChunk(t,e,s){return new Promise((i,n)=>{const a=new FileReader,o=t.slice(e,e+s);a.onload=t=>i(t.target.result),a.onerror=n,a.readAsText(o)})}parseLine(t,e){if(t.startsWith(";")||t.startsWith("(")){const e=t.replace(/^[;(]/,"").replace(/\)$/,"").trim(),s=e.match(/^Tool\s+(\d+)\s*:\s*(.+)$/i);if(s){0===this.toolNames.length&&(this.toolNames.push("No Tool"),this.toolColors.push(null),this.currentTool=0);const t=parseInt(s[1]),e=s[2].trim(),i=e.match(/#([0-9A-Fa-f]{6})\b/),n=i?e.replace(/#[0-9A-Fa-f]{6}\b/,"").trim():e,a=i?"#"+i[1]:null;this.inlineToolMap.has(t)||this.inlineToolMap.set(t,[]);const o=this.inlineToolMap.get(t),r=this.toolNames.length;return o.push(r),1===o.length?this.toolNames.push(`Tool ${t}: ${n}`):this.toolNames.push(`Tool ${t}: ${n} (${o.length})`),void this.toolColors.push(a)}if(/required tools?:/i.test(e))return void(this.parsingToolList=!0);if(this.parsingToolList){if(!e||0===e.length)return void(this.parsingToolList=!1);if(e.length>0&&!e.toLowerCase().includes("required")){const t=e.match(/#([0-9A-Fa-f]{6})\b/);if(t){this.toolColors.push("#"+t[1]);const s=e.replace(/#[0-9A-Fa-f]{6}\b/,"").trim();this.toolNames.push(s)}else this.toolColors.push(null),this.toolNames.push(e)}return}return}if(!t||t.startsWith("%"))return;const s=t,i=/M0\b/i.test(t),n=s.match(/[;(](.*)$/),a=n?n[1].toLowerCase():"";if(i&&a.includes("tool")&&(this.currentTool++,this.lastToolChangeType="M0"),!(t=t.replace(/\(.*?\)/g,"").replace(/;.*$/,"").trim()))return;const o=this.extractWords(t);if(0===o.length)return;let r=!1;for(const[t,s]of o)switch(t){case"G":r=this.processGCode(Math.floor(s),o,e)||r;break;case"M":this.processMCode(Math.floor(s),o,e);break;case"T":const t=Math.floor(s);if(this.inlineToolMap.size>0&&this.inlineToolMap.has(t)){const e=this.inlineToolMap.get(t),s=this.inlineToolOccurrence.get(t)||0,i=Math.min(s,e.length-1);this.currentTool=e[i],this.inlineToolOccurrence.set(t,s+1)}else this.currentTool=t;break;case"F":this.feedRate=s}}extractWords(t){const e=[],s=/([A-Z])([+-]?\d+\.?\d*)/gi;let i;for(;null!==(i=s.exec(t));)e.push([i[1].toUpperCase(),parseFloat(i[2])]);return e}processMCode(t,e,s){6===t&&(this.lastToolChangeType="M6")}processGCode(t,e,s){switch(t){case 0:return this.linearMove(e,"rapid",s);case 1:return this.linearMove(e,"cut",s);case 2:return this.arcMove(e,"cw",s);case 3:return this.arcMove(e,"ccw",s);case 17:return this.plane="XY",!1;case 18:return this.plane="ZX",!1;case 19:return this.plane="YZ",!1;case 20:return this.units="inches",!1;case 21:return this.units="mm",!1;case 90:return this.absolute=!0,!1;case 91:return this.absolute=!1,!1;default:return!1}}linearMove(t,e,s){const i=this.extractTarget(t);return(i.x!==this.position.x||i.y!==this.position.y||i.z!==this.position.z)&&(this.addSegment({type:e,start:{...this.position},end:{...i},feedRate:this.feedRate,tool:this.currentTool,toolChangeType:this.lastToolChangeType,lineNum:s}),this.lastToolChangeType=null,this.position=i,this.updateBounds(i),!0)}arcMove(t,e,s){const i=this.extractTarget(t),n=this.extractOffset(t);if(!n)return console.error(`Arc command at line ${s} missing I/J/K parameters`),!1;const a=this.tessellateArc(this.position,i,n,"cw"===e);for(const t of a)this.addSegment({type:"cut",start:t.start,end:t.end,feedRate:this.feedRate,tool:this.currentTool,lineNum:s}),this.updateBounds(t.end);return this.position=i,a.length>0}extractTarget(t){const e={...this.position};for(const[s,i]of t){const t=this.absolute?i:this.position[s.toLowerCase()]+i;switch(s){case"X":e.x=t;break;case"Y":e.y=t;break;case"Z":e.z=t}}return e}extractOffset(t){let e=null;for(const[s,i]of t)"I"!==s&&"J"!==s&&"K"!==s||(e||(e={i:0,j:0,k:0}),e[s.toLowerCase()]=i);return e}tessellateArc(t,e,s,i){let n,a,o,r,h,l;"XY"===this.plane?(n=t.x+s.i,a=t.y+s.j,o=t.x,r=t.y,h=e.x,l=e.y):"ZX"===this.plane?(n=t.z+s.k,a=t.x+s.i,o=t.z,r=t.x,h=e.z,l=e.x):(n=t.y+s.j,a=t.z+s.k,o=t.y,r=t.z,h=e.y,l=e.z);const c=Math.sqrt(Math.pow(o-n,2)+Math.pow(r-a,2)),d=Math.atan2(r-a,o-n);let m=Math.atan2(l-a,h-n)-d;i?m>=0&&(m-=2*Math.PI):m<=0&&(m+=2*Math.PI);const g=Math.max(8,Math.min(64,Math.floor(Math.sqrt(c)*Math.abs(m)*4))),u=[];let x={...t};for(let s=1;s<=g;s++){const i=s/g,o=d+m*i,r={...t};"XY"===this.plane?(r.x=n+c*Math.cos(o),r.y=a+c*Math.sin(o),r.z=t.z+(e.z-t.z)*i):"ZX"===this.plane?(r.z=n+c*Math.cos(o),r.x=a+c*Math.sin(o),r.y=t.y+(e.y-t.y)*i):(r.y=n+c*Math.cos(o),r.z=a+c*Math.sin(o),r.x=t.x+(e.x-t.x)*i),u.push({start:x,end:r}),x=r}return u}addSegment(t){this.segments.push(t)}updateBounds(t){isNaN(t.x)||isNaN(t.y)||isNaN(t.z)?console.error("Invalid point in updateBounds:",t):(this.bounds.minX=Math.min(this.bounds.minX,t.x),this.bounds.maxX=Math.max(this.bounds.maxX,t.x),this.bounds.minY=Math.min(this.bounds.minY,t.y),this.bounds.maxY=Math.max(this.bounds.maxY,t.y),this.bounds.minZ=Math.min(this.bounds.minZ,t.z),this.bounds.maxZ=Math.max(this.bounds.maxZ,t.z))}getBounds(){return this.bounds}getSegments(){return this.segments}getToolNames(){return this.toolNames}getToolColors(){return this.toolColors}get usingInlineToolFormat(){return this.inlineToolMap.size>0}}class Camera{constructor(){this.position={x:0,y:0,z:100},this.target={x:0,y:0,z:0},this.rotation={x:0,y:0,z:0,w:1},this.zoom=1,this.orthoScale=100,this.targetPosition={...this.position},this.targetTarget={...this.target},this.targetRotation={...this.rotation},this.targetZoom=this.zoom,this.pan2d={x:0,y:0},this.zoom2d=1,this.targetPan2d={...this.pan2d},this.targetZoom2d=this.zoom2d,this.initialZoom2d=1,this.initialOrthoScale=100}fitToBounds(t,e=.1,s=800,i=600){const n=(t.minX+t.maxX)/2,a=(t.minY+t.maxY)/2,o=(t.minZ+t.maxZ)/2;this.target={x:n,y:a,z:o},this.targetTarget={x:n,y:a,z:o};const r=t.maxX-t.minX,h=t.maxY-t.minY,l=t.maxZ-t.minZ,c=Math.max(r,h,l)||100;this.orthoScale=c*(.6+e/2);const d=s>0?s:800,m=i>0?i:600,g=d/Math.max(r*(1+.5*e),1),u=m/Math.max(h*(1+.5*e),1),x=Math.min(g,u);console.log("Camera fitToBounds:",{bounds:{width:r,height:h},canvas:{width:d,height:m},center:{x:n,y:a},scales:{x:g,y:u,chosen:x}}),this.pan2d={x:n,y:a},this.zoom2d=x,this.targetPan2d={...this.pan2d},this.targetZoom2d=this.zoom2d,this.initialZoom2d=x,this.initialOrthoScale=this.orthoScale,this.position={x:n+2*c,y:a,z:o},this.targetPosition={x:n,y:a,z:o+2*c},this.rotation={x:0,y:0,z:0,w:1},this.targetRotation={x:0,y:0,z:0,w:1}}update(t=16){const e=.15;this.pan2d.x+=(this.targetPan2d.x-this.pan2d.x)*e,this.pan2d.y+=(this.targetPan2d.y-this.pan2d.y)*e,this.zoom2d+=(this.targetZoom2d-this.zoom2d)*e,this.position.x+=(this.targetPosition.x-this.position.x)*e,this.position.y+=(this.targetPosition.y-this.position.y)*e,this.position.z+=(this.targetPosition.z-this.position.z)*e,this.target.x+=(this.targetTarget.x-this.target.x)*e,this.target.y+=(this.targetTarget.y-this.target.y)*e,this.target.z+=(this.targetTarget.z-this.target.z)*e,this.rotation=this.slerpQuaternion(this.rotation,this.targetRotation,e),this.zoom+=(this.targetZoom-this.zoom)*e}pan2D(t,e){this.targetPan2d.x-=t/this.zoom2d,this.targetPan2d.y+=e/this.zoom2d}zoom2D(t,e,s,i,n,a=!1){const o=1-t*(a?.015:.001),r=this.get2DTransform(i,n),h=(e-r.translateX)/r.scale,l=(s-r.translateY)/r.scale;this.targetZoom2d,this.targetZoom2d*=o;const c=.1*this.initialZoom2d,d=10*this.initialZoom2d;this.targetZoom2d=Math.max(c,Math.min(d,this.targetZoom2d));const m=e-h*this.targetZoom2d,g=s-l*this.targetZoom2d;this.targetPan2d.x=(i/2-m)/this.targetZoom2d,this.targetPan2d.y=-(n/2-g)/this.targetZoom2d}rotate(t,e){const s=this.position,i=this.target,n={x:i.x-s.x,y:i.y-s.y,z:i.z-s.z},a=Math.sqrt(n.x*n.x+n.y*n.y+n.z*n.z);n.x/=a,n.y/=a,n.z/=a;const o={x:1*n.z-0*n.y,y:0*n.x-0*n.z,z:0*n.y-1*n.x},r=Math.sqrt(o.x*o.x+o.y*o.y+o.z*o.z);o.x/=r,o.y/=r,o.z/=r;const h=n.y*o.z-n.z*o.y,l=n.z*o.x-n.x*o.z,c=n.x*o.y-n.y*o.x,d=s.x-i.x,m=s.y-i.y,g=s.z-i.z,u=.01*-t,x=Math.cos(u),p=Math.sin(u);let y=d*(x+h*h*(1-x))+m*(h*l*(1-x)-c*p)+g*(h*c*(1-x)+l*p),f=d*(l*h*(1-x)+c*p)+m*(x+l*l*(1-x))+g*(l*c*(1-x)-h*p),v=d*(c*h*(1-x)-l*p)+m*(c*l*(1-x)+h*p)+g*(x+c*c*(1-x));const M=.01*e,b=Math.cos(M),T=Math.sin(M),z=y*(b+o.x*o.x*(1-b))+f*(o.x*o.y*(1-b)-o.z*T)+v*(o.x*o.z*(1-b)+o.y*T),E=y*(o.y*o.x*(1-b)+o.z*T)+f*(b+o.y*o.y*(1-b))+v*(o.y*o.z*(1-b)-o.x*T),w=y*(o.z*o.x*(1-b)-o.y*T)+f*(o.z*o.y*(1-b)+o.x*T)+v*(b+o.z*o.z*(1-b)),C=E/Math.sqrt(z*z+E*E+w*w),S=Math.asin(-C),I=Math.PI/2-.09;Math.abs(S)>I?(this.targetPosition.x=i.x+y,this.targetPosition.y=i.y+f,this.targetPosition.z=i.z+v):(this.targetPosition.x=i.x+z,this.targetPosition.y=i.y+E,this.targetPosition.z=i.z+w)}pan3D(t,e){const s=.002*this.orthoScale,i=this.position,n=this.target,a={x:n.x-i.x,y:n.y-i.y,z:n.z-i.z},o=Math.sqrt(a.x*a.x+a.y*a.y+a.z*a.z);a.x/=o,a.y/=o,a.z/=o;const r={x:1*a.z-0*a.y,y:0*a.x-0*a.z,z:0*a.y-1*a.x},h=Math.sqrt(r.x*r.x+r.y*r.y+r.z*r.z);r.x/=h,r.y/=h,r.z/=h;const l={x:a.y*r.z-a.z*r.y,y:a.z*r.x-a.x*r.z,z:a.x*r.y-a.y*r.x},c=Math.sqrt(l.x*l.x+l.y*l.y+l.z*l.z);l.x/=c,l.y/=c,l.z/=c,this.targetPosition.x+=t*s*r.x+e*s*l.x,this.targetPosition.y+=t*s*r.y+e*s*l.y,this.targetPosition.z+=t*s*r.z+e*s*l.z,this.targetTarget.x+=t*s*r.x+e*s*l.x,this.targetTarget.y+=t*s*r.y+e*s*l.y,this.targetTarget.z+=t*s*r.z+e*s*l.z}zoom3D(t){const e=t*(Math.abs(t)>10?.001:1);this.orthoScale*=1+e;const s=.1*this.initialOrthoScale,i=10*this.initialOrthoScale;this.orthoScale=Math.max(s,Math.min(i,this.orthoScale))}get2DTransform(t,e){return{translateX:t/2-this.pan2d.x*this.zoom2d,translateY:e/2+this.pan2d.y*this.zoom2d,scale:this.zoom2d}}getProjectionMatrix(t){const e=this.orthoScale,s=-e*t,i=e*t,n=-e,a=i-s,o=e-n;return[2/a,0,0,0,0,2/o,0,0,0,0,-1e-4,0,-(i+s)/a,-(e+n)/o,-0,1]}getViewMatrix(){const t=this.position,e=this.target,s={x:t.x-e.x,y:t.y-e.y,z:t.z-e.z},i=Math.sqrt(s.x*s.x+s.y*s.y+s.z*s.z);s.x/=i,s.y/=i,s.z/=i;const n={x:1*s.z-0*s.y,y:0*s.x-0*s.z,z:0*s.y-1*s.x},a=Math.sqrt(n.x*n.x+n.y*n.y+n.z*n.z);n.x/=a,n.y/=a,n.z/=a;const o={x:s.y*n.z-s.z*n.y,y:s.z*n.x-s.x*n.z,z:s.x*n.y-s.y*n.x};return[n.x,o.x,s.x,0,n.y,o.y,s.y,0,n.z,o.z,s.z,0,-(n.x*t.x+n.y*t.y+n.z*t.z),-(o.x*t.x+o.y*t.y+o.z*t.z),-(s.x*t.x+s.y*t.y+s.z*t.z),1]}axisAngleToQuaternion(t,e){const s=e/2,i=Math.sin(s);return{x:t.x*i,y:t.y*i,z:t.z*i,w:Math.cos(s)}}multiplyQuaternion(t,e){return{x:t.w*e.x+t.x*e.w+t.y*e.z-t.z*e.y,y:t.w*e.y-t.x*e.z+t.y*e.w+t.z*e.x,z:t.w*e.z+t.x*e.y-t.y*e.x+t.z*e.w,w:t.w*e.w-t.x*e.x-t.y*e.y-t.z*e.z}}normalizeQuaternion(t){const e=Math.sqrt(t.x*t.x+t.y*t.y+t.z*t.z+t.w*t.w);return{x:t.x/e,y:t.y/e,z:t.z/e,w:t.w/e}}slerpQuaternion(t,e,s){let i=t.x*e.x+t.y*e.y+t.z*e.z+t.w*e.w;if(i<0&&(e={x:-e.x,y:-e.y,z:-e.z,w:-e.w},i=-i),i>.9995)return this.normalizeQuaternion({x:t.x+s*(e.x-t.x),y:t.y+s*(e.y-t.y),z:t.z+s*(e.z-t.z),w:t.w+s*(e.w-t.w)});const n=Math.acos(i),a=Math.sin(n),o=Math.sin((1-s)*n)/a,r=Math.sin(s*n)/a;return{x:t.x*o+e.x*r,y:t.y*o+e.y*r,z:t.z*o+e.z*r,w:t.w*o+e.w*r}}quaternionToMatrix(t){const e=t.x*t.x,s=t.y*t.y,i=t.z*t.z,n=t.x*t.y,a=t.x*t.z,o=t.y*t.z,r=t.w*t.x,h=t.w*t.y,l=t.w*t.z;return[1-2*(s+i),2*(n-l),2*(a+h),0,2*(n+l),1-2*(e+i),2*(o-r),0,2*(a-h),2*(o+r),1-2*(e+s),0,0,0,0,1]}multiplyMatrices(t,e){const s=new Array(16);for(let i=0;i<4;i++)for(let n=0;n<4;n++)s[4*i+n]=t[0+n]*e[4*i+0]+t[4+n]*e[4*i+1]+t[8+n]*e[4*i+2]+t[12+n]*e[4*i+3];return s}getMVPMatrix(t){const e=this.getProjectionMatrix(t),s=this.getViewMatrix();return this.multiplyMatrices(e,s)}}class Renderer2D{constructor(t,e){this.canvas=t,this.ctx=t.getContext("2d"),this.camera=e,this.segments=[],this.bounds=null,this.layerFilter={min:-1/0,max:1/0},this.hoveredPoint=null,this.maxSegmentIndex=1/0,this.toolStates=new Map,this.rapidMovesVisible=!0,this.rapidMoveColor="#999999",this.resizeCanvas()}resizeCanvas(){const t=this.canvas.getBoundingClientRect();this.canvas.width=t.width,this.canvas.height=t.height}setSegments(t,e){this.segments=t,this.bounds=e,this.maxSegmentIndex=t.length}setToolStates(t){this.toolStates=t}setRapidMoveSettings(t,e){this.rapidMovesVisible=t,this.rapidMoveColor=e}updateBuffers(){}setLayerFilter(t,e){this.layerFilter.min=t,this.layerFilter.max=e}setMaxSegmentIndex(t,e=1){this.maxSegmentIndex=t,this.segmentProgress=e}render(){if(this.resizeCanvas(),this.clear(),0===this.segments.length)return void this.drawWelcomeMessage();const t=this.camera.get2DTransform(this.canvas.width,this.canvas.height);this.ctx.save(),this.ctx.translate(t.translateX,t.translateY),this.ctx.scale(t.scale,-t.scale),this.drawGrid(t),this.drawSegments(),this.drawCurrentPositionMarker(),this.ctx.restore(),this.drawGridLabels(t),this.drawCoordinateAxes()}clear(){const t=document.documentElement.getAttribute("data-theme");this.ctx.fillStyle="dark"===t?"#252525":"#fafafa",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height)}drawWelcomeMessage(){this.ctx.save(),this.ctx.fillStyle=getComputedStyle(document.documentElement).getPropertyValue("--text-color"),this.ctx.font="16px sans-serif",this.ctx.textAlign="center",this.ctx.fillText("Load a GCode file to visualize",this.canvas.width/2,this.canvas.height/2),this.ctx.restore()}drawGrid(t){const e=document.documentElement.getAttribute("data-theme"),s="dark"===e?"#3a3a3a":"#e0e0e0",i=t.scale;let n=10;i<.5?n=100:i<2?n=50:i>10?n=1:i>5&&(n=5);const a=-t.translateX/i,o=(this.canvas.width-t.translateX)/i,r=t.translateY/i,h=(t.translateY-this.canvas.height)/i;this.ctx.strokeStyle=s,this.ctx.lineWidth=1/i;const l=Math.floor(a/n)*n,c=Math.ceil(o/n)*n;for(let t=l;t<=c;t+=n)this.ctx.beginPath(),this.ctx.moveTo(t,h),this.ctx.lineTo(t,r),this.ctx.stroke();const d=Math.floor(h/n)*n,m=Math.ceil(r/n)*n;for(let t=d;t<=m;t+=n)this.ctx.beginPath(),this.ctx.moveTo(a,t),this.ctx.lineTo(o,t),this.ctx.stroke();this.ctx.strokeStyle="dark"===e?"#666666":"#999999",this.ctx.lineWidth=2/i,this.ctx.beginPath(),this.ctx.moveTo(0,h),this.ctx.lineTo(0,r),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.moveTo(a,0),this.ctx.lineTo(o,0),this.ctx.stroke()}drawSegments(){const t=document.documentElement.getAttribute("data-theme"),e=["dark"===t?"#00ccff":"#0066cc","dark"===t?"#00ff88":"#00cc66","dark"===t?"#ff4dff":"#cc00cc","dark"===t?"#ffff00":"#cccc00","dark"===t?"#ff8800":"#ff6600","dark"===t?"#8888ff":"#4d4dff","dark"===t?"#ff0088":"#ff0066","dark"===t?"#00ffff":"#00b3b3"],s=this.camera.zoom2d,i=Math.max(.5,1.5/s),n=[],a={};let o=null;for(let t=0;t<Math.min(this.segments.length,this.maxSegmentIndex);t++){const e=this.segments[t];if(!(e.start.z<this.layerFilter.min||e.start.z>this.layerFilter.max))if("rapid"===e.type)this.rapidMovesVisible&&n.push(e);else{const t=e.tool||0;if(this.toolStates.has(t)&&!this.toolStates.get(t).visible)continue;a[t]||(a[t]=[]),a[t].push(e)}}if(this.maxSegmentIndex<this.segments.length&&this.segmentProgress>0&&this.segmentProgress<1){const t=this.segments[this.maxSegmentIndex];if("cut"===t.type&&t.start.z>=this.layerFilter.min&&t.start.z<=this.layerFilter.max){const e=t.tool||0;this.toolStates.has(e)&&!this.toolStates.get(e).visible||(o={seg:t,tool:e})}}this.rapidMovesVisible&&n.length>0&&(this.ctx.strokeStyle=this.rapidMoveColor,this.ctx.lineWidth=.7*i,this.ctx.setLineDash([5/s,5/s]),this.drawSegmentBatch(n)),this.ctx.lineWidth=i,this.ctx.setLineDash([]);for(const t in a){const s=parseInt(t);if(this.toolStates.has(s))this.ctx.strokeStyle=this.toolStates.get(s).color;else{const t=s%e.length;this.ctx.strokeStyle=e[t]}this.drawSegmentBatch(a[t])}if(o){const{seg:t,tool:s}=o;if(this.toolStates.has(s))this.ctx.strokeStyle=this.toolStates.get(s).color;else{const t=s%e.length;this.ctx.strokeStyle=e[t]}const i=t.start.x+(t.end.x-t.start.x)*this.segmentProgress,n=t.start.y+(t.end.y-t.start.y)*this.segmentProgress;t.start.z,t.end.z,t.start.z,this.segmentProgress,this.ctx.beginPath(),this.ctx.moveTo(t.start.x,t.start.y),this.ctx.lineTo(i,n),this.ctx.stroke()}}drawSegmentBatch(t){if(0!==t.length){this.ctx.beginPath();for(const e of t)this.ctx.moveTo(e.start.x,e.start.y),this.ctx.lineTo(e.end.x,e.end.y);this.ctx.stroke()}}drawCurrentPositionMarker(){if(this.maxSegmentIndex>=this.segments.length||this.maxSegmentIndex===1/0)return;const t=this.segments[this.maxSegmentIndex];if(!t)return;const e=this.segmentProgress,s={x:t.start.x+(t.end.x-t.start.x)*e,y:t.start.y+(t.end.y-t.start.y)*e,z:t.start.z+(t.end.z-t.start.z)*e},i=this.camera.zoom2d,n=5/i;this.ctx.save(),this.ctx.fillStyle="#ff0000",this.ctx.strokeStyle="#ffffff",this.ctx.lineWidth=2/i,this.ctx.beginPath(),this.ctx.arc(s.x,s.y,n,0,2*Math.PI),this.ctx.fill(),this.ctx.stroke(),this.ctx.restore()}drawGridLabels(t){const e=document.documentElement.getAttribute("data-theme"),s=t.scale;let i=10;s<.5?i=100:s<2?i=50:s>10?i=1:s>5&&(i=5);const n=Math.max(i,10),a=-t.translateX/s,o=(this.canvas.width-t.translateX)/s,r=t.translateY/s,h=(t.translateY-this.canvas.height)/s;this.ctx.save(),this.ctx.fillStyle="dark"===e?"#aaa":"#555",this.ctx.font="11px monospace",this.ctx.textAlign="center",this.ctx.textBaseline="middle";const l=e=>t.translateX+e*s,c=e=>t.translateY-e*s,d=Math.floor(a/n)*n,m=Math.ceil(o/n)*n;for(let t=d;t<=m;t+=n){const e=l(t),s=c(0);let i=s+15;s<0?i=15:s>this.canvas.height&&(i=this.canvas.height-5),e>=0&&e<=this.canvas.width&&this.ctx.fillText(t.toString(),e,i)}const g=Math.floor(h/n)*n,u=Math.ceil(r/n)*n;this.ctx.textAlign="right";for(let t=g;t<=u;t+=n){const e=l(0),s=c(t);let i=e-10;e<0?i=50:e>this.canvas.width&&(i=this.canvas.width-10),s>=0&&s<=this.canvas.height&&this.ctx.fillText(t.toString(),i,s)}this.ctx.restore()}drawCoordinateAxes(){const t=this.canvas.height-20-40;this.ctx.save(),this.ctx.translate(60,t),this.ctx.strokeStyle="#ff0000",this.ctx.lineWidth=2,this.ctx.beginPath(),this.ctx.moveTo(0,0),this.ctx.lineTo(40,0),this.ctx.stroke(),this.ctx.fillStyle="#ff0000",this.ctx.font="12px sans-serif",this.ctx.fillText("X",45,5),this.ctx.strokeStyle="#00ff00",this.ctx.beginPath(),this.ctx.moveTo(0,0),this.ctx.lineTo(0,-40),this.ctx.stroke(),this.ctx.fillStyle="#00ff00",this.ctx.fillText("Y",5,-45),this.ctx.restore()}canvasToWorld(t,e){const s=this.camera.get2DTransform(this.canvas.width,this.canvas.height);return{x:(t-s.translateX)/s.scale,y:-(e-s.translateY)/s.scale}}findNearestPoint(t,e,s=10){const i=this.canvasToWorld(t,e);let n=null,a=s/this.camera.zoom2d;for(let t=0;t<Math.min(this.segments.length,this.maxSegmentIndex);t++){const e=this.segments[t],s=Math.sqrt(Math.pow(e.start.x-i.x,2)+Math.pow(e.start.y-i.y,2));s<a&&(a=s,n={...e.start,lineNum:e.lineNum});const o=Math.sqrt(Math.pow(e.end.x-i.x,2)+Math.pow(e.end.y-i.y,2));o<a&&(a=o,n={...e.end,lineNum:e.lineNum})}return n}}class Renderer3D{constructor(t,e,s){this.canvas=t,this.camera=e,this.overlayCanvas=s,this.overlayCtx=s?s.getContext("2d"):null,this.gl=null,this.program=null,this.buffers={},this.segments=[],this.bounds=null,this.layerFilter={min:-1/0,max:1/0},this.maxSegmentIndex=1/0,this.toolStates=new Map,this.rapidMovesVisible=!0,this.rapidMoveColor="#999999",this.initWebGL(),this.resizeCanvas()}initWebGL(){if(this.gl=this.canvas.getContext("webgl",{alpha:!1,antialias:!0,preserveDrawingBuffer:!0})||this.canvas.getContext("experimental-webgl"),!this.gl)return void console.error("WebGL not supported");console.log("WebGL context created successfully");const t=this.gl,e=this.compileShader(t.VERTEX_SHADER,"\n attribute vec3 aPosition;\n attribute vec3 aColor;\n uniform mat4 uMVP;\n varying vec3 vColor;\n \n void main() {\n gl_Position = uMVP * vec4(aPosition, 1.0);\n gl_PointSize = 10.0;\n vColor = aColor;\n }\n "),s=this.compileShader(t.FRAGMENT_SHADER,"\n precision mediump float;\n varying vec3 vColor;\n \n void main() {\n gl_FragColor = vec4(vColor, 1.0);\n }\n ");this.program=t.createProgram(),t.attachShader(this.program,e),t.attachShader(this.program,s),t.linkProgram(this.program),t.getProgramParameter(this.program,t.LINK_STATUS)?(console.log("Shader program linked successfully"),this.locations={aPosition:t.getAttribLocation(this.program,"aPosition"),aColor:t.getAttribLocation(this.program,"aColor"),uMVP:t.getUniformLocation(this.program,"uMVP")},t.enable(t.DEPTH_TEST),t.depthFunc(t.LEQUAL),this.buffers.position=t.createBuffer(),this.buffers.color=t.createBuffer()):console.error("Program link error:",t.getProgramInfoLog(this.program))}compileShader(t,e){const s=this.gl,i=s.createShader(t);return s.shaderSource(i,e),s.compileShader(i),s.getShaderParameter(i,s.COMPILE_STATUS)?i:(console.error("Shader compile error:",s.getShaderInfoLog(i)),s.deleteShader(i),null)}resizeCanvas(){const t=this.canvas.getBoundingClientRect();this.canvas.width=t.width,this.canvas.height=t.height,this.overlayCanvas&&(this.overlayCanvas.width=t.width,this.overlayCanvas.height=t.height),this.gl&&this.gl.viewport(0,0,this.canvas.width,this.canvas.height)}setSegments(t,e){this.segments=t,this.bounds=e,this.maxSegmentIndex=t.length,this.updateBuffers()}setToolStates(t){this.toolStates=t}setRapidMoveSettings(t,e){this.rapidMovesVisible=t,this.rapidMoveColor=e}setLayerFilter(t,e){this.layerFilter.min=t,this.layerFilter.max=e,this.updateBuffers()}setMaxSegmentIndex(t,e=1){this.maxSegmentIndex=t,this.segmentProgress=e,this.updateBuffers()}updateBuffers(){if(!this.gl||0===this.segments.length)return;const t=this.gl,e=document.documentElement.getAttribute("data-theme"),s=this.hexToRgb(this.rapidMoveColor),i=["dark"===e?[0,.8,1]:[0,.4,.8],"dark"===e?[0,1,.5]:[0,.8,.4],"dark"===e?[1,.3,1]:[.8,0,.8],"dark"===e?[1,1,0]:[.8,.8,0],"dark"===e?[1,.5,0]:[1,.4,0],"dark"===e?[.5,.5,1]:[.3,.3,1],"dark"===e?[1,0,.5]:[1,0,.4],"dark"===e?[0,1,1]:[0,.7,.7]],n=[],a=[];for(let t=0;t<Math.min(this.segments.length,this.maxSegmentIndex);t++){const e=this.segments[t];if(e.start.z<this.layerFilter.min||e.start.z>this.layerFilter.max)continue;if("rapid"===e.type&&!this.rapidMovesVisible)continue;const o=e.tool||0;if("rapid"!==e.type&&this.toolStates.has(o)&&!this.toolStates.get(o).visible)continue;let r;if("rapid"===e.type)r=s;else if(this.toolStates.has(o)){const t=this.toolStates.get(o).color;r=this.hexToRgb(t)}else r=i[o%i.length];n.push(e.start.x,e.start.y,e.start.z),a.push(...r),n.push(e.end.x,e.end.y,e.end.z),a.push(...r)}if(this.maxSegmentIndex<this.segments.length&&this.segmentProgress>0&&this.segmentProgress<1){const t=this.segments[this.maxSegmentIndex];if(t.start.z>=this.layerFilter.min&&t.start.z<=this.layerFilter.max&&("rapid"!==t.type||this.rapidMovesVisible)){const e=t.tool||0;let o=!0;if("rapid"!==t.type&&this.toolStates.has(e)&&(o=this.toolStates.get(e).visible),o){let o;if("rapid"===t.type)o=s;else if(this.toolStates.has(e)){const t=this.toolStates.get(e).color;o=this.hexToRgb(t)}else o=i[e%i.length];const r=t.start.x+(t.end.x-t.start.x)*this.segmentProgress,h=t.start.y+(t.end.y-t.start.y)*this.segmentProgress,l=t.start.z+(t.end.z-t.start.z)*this.segmentProgress;n.push(t.start.x,t.start.y,t.start.z),a.push(...o),n.push(r,h,l),a.push(...o)}}}this.vertexCount=n.length/3,t.bindBuffer(t.ARRAY_BUFFER,this.buffers.position),t.bufferData(t.ARRAY_BUFFER,new Float32Array(n),t.STATIC_DRAW),t.bindBuffer(t.ARRAY_BUFFER,this.buffers.color),t.bufferData(t.ARRAY_BUFFER,new Float32Array(a),t.STATIC_DRAW)}hexToRgb(t){const e=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t);return e?[parseInt(e[1],16)/255,parseInt(e[2],16)/255,parseInt(e[3],16)/255]:[1,1,1]}render(){if(!this.gl)return void console.error("No WebGL context");this.resizeCanvas();const t=this.gl;if("dark"===document.documentElement.getAttribute("data-theme")?t.clearColor(.15,.15,.15,1):t.clearColor(.98,.98,.98,1),t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT),!this.vertexCount||0===this.vertexCount)return;t.useProgram(this.program);const e=this.canvas.width/this.canvas.height,s=this.camera.getMVPMatrix(e);t.uniformMatrix4fv(this.locations.uMVP,!1,s),t.bindBuffer(t.ARRAY_BUFFER,this.buffers.position),t.vertexAttribPointer(this.locations.aPosition,3,t.FLOAT,!1,0,0),t.enableVertexAttribArray(this.locations.aPosition),t.bindBuffer(t.ARRAY_BUFFER,this.buffers.color),t.vertexAttribPointer(this.locations.aColor,3,t.FLOAT,!1,0,0),t.enableVertexAttribArray(this.locations.aColor),t.drawArrays(t.LINES,0,this.vertexCount),this.drawGrid(s),this.drawAxes(s),this.drawCurrentPositionMarker(s),this.drawGridLabels(s)}drawGrid(t){const e=this.gl,s=document.getElementById("grid-enabled")?.checked;if(!s)return;const i=parseFloat(document.getElementById("grid-width")?.value||1e3),n=parseFloat(document.getElementById("grid-height")?.value||600);if(i<=0||n<=0)return;const a=document.documentElement.getAttribute("data-theme"),o="dark"===a?[.3,.3,.3]:[.85,.85,.85],r="dark"===a?[.5,.5,.5]:[.7,.7,.7],h="dark"===a?[.7,.7,.7]:[.5,.5,.5],l=[],c=[];for(let t=0;t<=i;t+=10)t%100!=0&&(l.push(t,0,0,t,n,0),c.push(...o,...o));for(let t=0;t<=n;t+=10)t%100!=0&&(l.push(0,t,0,i,t,0),c.push(...o,...o));for(let t=0;t<=i;t+=100)l.push(t,0,0,t,n,0),c.push(...r,...r);for(let t=0;t<=n;t+=100)l.push(0,t,0,i,t,0),c.push(...r,...r);l.push(0,0,0,i,0,0,i,0,0,i,n,0,i,n,0,0,n,0,0,n,0,0,0,0);for(let t=0;t<8;t++)c.push(...h);const d=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,d),e.bufferData(e.ARRAY_BUFFER,new Float32Array(l),e.STATIC_DRAW),e.vertexAttribPointer(this.locations.aPosition,3,e.FLOAT,!1,0,0);const m=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,m),e.bufferData(e.ARRAY_BUFFER,new Float32Array(c),e.STATIC_DRAW),e.vertexAttribPointer(this.locations.aColor,3,e.FLOAT,!1,0,0),e.drawArrays(e.LINES,0,l.length/3),e.deleteBuffer(d),e.deleteBuffer(m)}drawAxes(t){const e=this.gl;if(!this.bounds)return;const s=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,s),e.bufferData(e.ARRAY_BUFFER,new Float32Array([0,0,0,100,0,0,0,0,0,0,100,0,0,0,0,0,0,100]),e.STATIC_DRAW),e.vertexAttribPointer(this.locations.aPosition,3,e.FLOAT,!1,0,0);const i=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,i),e.bufferData(e.ARRAY_BUFFER,new Float32Array([1,0,0,1,0,0,0,1,0,0,1,0,0,0,1,0,0,1]),e.STATIC_DRAW),e.vertexAttribPointer(this.locations.aColor,3,e.FLOAT,!1,0,0),e.drawArrays(e.LINES,0,6),e.deleteBuffer(s),e.deleteBuffer(i)}drawCurrentPositionMarker(t){if(this.maxSegmentIndex>=this.segments.length||this.maxSegmentIndex===1/0)return;const e=this.segments[this.maxSegmentIndex];if(!e)return;const s=this.gl,i=this.segmentProgress,n=e.start.x+(e.end.x-e.start.x)*i,a=e.start.y+(e.end.y-e.start.y)*i,o=e.start.z+(e.end.z-e.start.z)*i,r=[],h=[],l=16;for(let t=0;t<=l;t++){const e=t*Math.PI/l,s=Math.sin(e),i=Math.cos(e);for(let t=0;t<=l;t++){const e=2*t*Math.PI/l,c=Math.sin(e),d=Math.cos(e)*s,m=c*s,g=i,u=n+1.5*d,x=a+1.5*m,p=o+1.5*g;r.push(u,x,p),h.push(d,m,g)}}const c=[];for(let t=0;t<l;t++)for(let e=0;e<l;e++){const s=17*t+e,i=s+l+1;c.push(s,i,s+1),c.push(i,i+1,s+1)}if(!this.sphereProgram){const t="\n attribute vec3 aPosition;\n attribute vec3 aNormal;\n uniform mat4 uMVP;\n varying vec3 vNormal;\n \n void main() {\n gl_Position = uMVP * vec4(aPosition, 1.0);\n vNormal = aNormal;\n }\n ",e="\n precision mediump float;\n varying vec3 vNormal;\n \n void main() {\n vec3 lightDir = normalize(vec3(0.5, 0.3, 1.0));\n float diffuse = max(dot(vNormal, lightDir), 0.0);\n float ambient = 0.3;\n float lighting = ambient + diffuse * 0.7;\n \n vec3 color = vec3(1.0, 0.0, 0.0) * lighting;\n gl_FragColor = vec4(color, 1.0);\n }\n ",i=this.compileShader(s.VERTEX_SHADER,t),n=this.compileShader(s.FRAGMENT_SHADER,e);this.sphereProgram=s.createProgram(),s.attachShader(this.sphereProgram,i),s.attachShader(this.sphereProgram,n),s.linkProgram(this.sphereProgram),this.sphereLocations={aPosition:s.getAttribLocation(this.sphereProgram,"aPosition"),aNormal:s.getAttribLocation(this.sphereProgram,"aNormal"),uMVP:s.getUniformLocation(this.sphereProgram,"uMVP")}}s.useProgram(this.sphereProgram),s.uniformMatrix4fv(this.sphereLocations.uMVP,!1,t);const d=s.createBuffer();s.bindBuffer(s.ARRAY_BUFFER,d),s.bufferData(s.ARRAY_BUFFER,new Float32Array(r),s.STATIC_DRAW),s.vertexAttribPointer(this.sphereLocations.aPosition,3,s.FLOAT,!1,0,0),s.enableVertexAttribArray(this.sphereLocations.aPosition);const m=s.createBuffer();s.bindBuffer(s.ARRAY_BUFFER,m),s.bufferData(s.ARRAY_BUFFER,new Float32Array(h),s.STATIC_DRAW),s.vertexAttribPointer(this.sphereLocations.aNormal,3,s.FLOAT,!1,0,0),s.enableVertexAttribArray(this.sphereLocations.aNormal);const g=s.createBuffer();s.bindBuffer(s.ELEMENT_ARRAY_BUFFER,g),s.bufferData(s.ELEMENT_ARRAY_BUFFER,new Uint16Array(c),s.STATIC_DRAW),s.drawElements(s.TRIANGLES,c.length,s.UNSIGNED_SHORT,0),s.deleteBuffer(d),s.deleteBuffer(m),s.deleteBuffer(g)}drawGridLabels(t){if(!this.overlayCtx)return;const e=this.overlayCtx,s=document.getElementById("grid-enabled")?.checked;if(!s)return;const i=parseFloat(document.getElementById("grid-width")?.value||1e3),n=parseFloat(document.getElementById("grid-height")?.value||600);if(i<=0||n<=0)return;e.clearRect(0,0,this.overlayCanvas.width,this.overlayCanvas.height);const a=document.documentElement.getAttribute("data-theme");e.fillStyle="dark"===a?"#aaa":"#555",e.font="11px monospace",e.textAlign="center",e.textBaseline="middle";const o=(e,s,i)=>{const n=[e,s,i,1],a=[0,0,0,0];for(let e=0;e<4;e++)for(let s=0;s<4;s++)a[e]+=t[4*s+e]*n[s];const o=a[3],r=a[0]/o,h=a[1]/o;return{x:.5*(r+1)*this.overlayCanvas.width,y:.5*(1-h)*this.overlayCanvas.height,visible:o>0}};for(let t=0;t<=i;t+=100){const s=o(t,0,0);s.visible&&s.x>=0&&s.x<=this.overlayCanvas.width&&s.y>=0&&s.y<=this.overlayCanvas.height&&e.fillText(t.toString(),s.x,s.y+15)}for(let t=0;t<=n;t+=100){const s=o(0,t,0);s.visible&&s.x>=0&&s.x<=this.overlayCanvas.width&&s.y>=0&&s.y<=this.overlayCanvas.height&&e.fillText(t.toString(),s.x-20,s.y)}}destroy(){if(!this.gl)return;const t=this.gl;t.deleteBuffer(this.buffers.position),t.deleteBuffer(this.buffers.color),t.deleteProgram(this.program)}}class Animator{constructor(){this.segments=[],this.currentIndex=0,this.segmentProgress=0,this.isPlaying=!1,this.speed=1,this.lastTime=0,this.accumulatedTime=0,this.estimatedTotalTime=0,this.toolTimes=new Map,this.rapidSpeed=3e3,this.maxRateX=3e3,this.maxRateY=3e3,this.maxRateZ=2e3,this.accelX=200,this.accelY=200,this.accelZ=80,this.manualToolChangeTime=30,this.autoToolChangeTime=10,this.onUpdate=null}setMotionParameters(t){void 0!==t.accelX&&(this.accelX=t.accelX),void 0!==t.accelY&&(this.accelY=t.accelY),void 0!==t.accelZ&&(this.accelZ=t.accelZ),void 0!==t.maxRateX&&(this.maxRateX=t.maxRateX),void 0!==t.maxRateY&&(this.maxRateY=t.maxRateY),void 0!==t.maxRateZ&&(this.maxRateZ=t.maxRateZ),console.log("[Animator] Motion parameters updated:",{accel:{X:this.accelX,Y:this.accelY,Z:this.accelZ},maxRate:{X:this.maxRateX,Y:this.maxRateY,Z:this.maxRateZ}})}setSegments(t){this.segments=t,this.currentIndex=0,this.segmentProgress=0,this.accumulatedTime=0,this.calculateTotalTime(),this.calculateDistances()}calculateDistances(){this.segmentDistances=[];let t=0;for(let e=0;e<this.segments.length;e++){const s=this.segments[e];if("cut"===s.type){const e=s.end.x-s.start.x,i=s.end.y-s.start.y,n=s.end.z-s.start.z;t+=Math.sqrt(e*e+i*i+n*n)}this.segmentDistances.push(t)}this.totalDistance=t}calculateTotalTime(){this.estimatedTotalTime=0,this.toolTimes.clear();for(let t=0;t<this.segments.length;t++){const e=this.segments[t],s=t>0?this.segments[t-1]:null,i=t<this.segments.length-1?this.segments[t+1]:null;let n=0;if("M0"===e.toolChangeType?n+=this.manualToolChangeTime:"M6"===e.toolChangeType&&(n+=this.autoToolChangeTime),"cut"===e.type&&e.feedRate>0){const t=e.feedRate,a=s&&"cut"===s.type?s.feedRate:0,o=i&&"cut"===i.type?i.feedRate:0,r=this.calculateJunctionVelocity(s,e,a,t),h=this.calculateJunctionVelocity(e,i,t,o);n+=this.calculateMoveTime(e,t,r,h)}else if("rapid"===e.type){const t=e.end.x-e.start.x,a=e.end.y-e.start.y,o=e.end.z-e.start.z,r=Math.sqrt(t*t+a*a+o*o);if(r>0){let h=1/0;if(Math.abs(t)>.001){const e=r/(Math.abs(t)/(this.maxRateX/60))*60;h=Math.min(h,e)}if(Math.abs(a)>.001){const t=r/(Math.abs(a)/(this.maxRateY/60))*60;h=Math.min(h,t)}if(Math.abs(o)>.001){const t=r/(Math.abs(o)/(this.maxRateZ/60))*60;h=Math.min(h,t)}h===1/0&&(h=this.rapidSpeed);const l=s&&"rapid"===s.type,c=i&&"rapid"===i.type,d=l?this.calculateJunctionVelocity(s,e,h,h):0,m=c?this.calculateJunctionVelocity(e,i,h,h):0;n+=this.calculateMoveTime(e,h,d,m)}}if(this.estimatedTotalTime+=n,"cut"===e.type){const t=e.tool||1,s=this.toolTimes.get(t)||0;this.toolTimes.set(t,s+n)}}}calculateMoveTime(t,e,s=0,i=0){const n=t.end.x-t.start.x,a=t.end.y-t.start.y,o=t.end.z-t.start.z,r=Math.sqrt(n*n+a*a+o*o);if(0===r)return 0;const h=e/60;let l=1/0;if(Math.abs(n)>.001){const t=this.accelX;l=Math.min(l,t)}if(Math.abs(a)>.001){const t=this.accelY;l=Math.min(l,t)}if(Math.abs(o)>.001){const t=this.accelZ;l=Math.min(l,t)}l===1/0&&(l=this.accelX);const c=(h*h-(s=Math.min(s,h))*s)/(2*l)+(h*h-(i=Math.min(i,h))*i)/(2*l);if(c>=r){const t=(s*s+i*i)/2+l*r,e=Math.sqrt(Math.max(0,t));return(e-s)/l+(e-i)/l}return(h-s)/l+(r-c)/h+(h-i)/l}calculateJunctionVelocity(t,e,s,i){if(!t||!e)return 0;if(t.tool!==e.tool||t.type!==e.type)return 0;const n=t.end.x-e.start.x,a=t.end.y-e.start.y,o=t.end.z-e.start.z;if(n*n+a*a+o*o>=1e-6)return 0;const r=t.end.x-t.start.x,h=t.end.y-t.start.y,l=t.end.z-t.start.z,c=r*r+h*h+l*l,d=e.end.x-e.start.x,m=e.end.y-e.start.y,g=e.end.z-e.start.z,u=d*d+m*m+g*g;if(0===c||0===u)return 0;const x=Math.sqrt(c),p=Math.sqrt(u),y=r/x*(d/p)+h/x*(m/p)+l/x*(g/p);if(y>.999)return Math.min(s,i)/60;const f=(1+y)/2;return Math.min(s,i)/60*f}formatDuration(t){if(0===t)return"-";const e=Math.floor(t),s=Math.floor(e/3600),i=Math.floor(e%3600/60),n=e%60;return s>0?`${s}h ${i}m ${n}s`:i>0?`${i}m ${n}s`:`${n}s`}getFormattedTime(){return this.formatDuration(this.estimatedTotalTime)}getToolTime(t){const e=this.toolTimes.get(t)||0;return this.formatDuration(e)}getToolTimes(){return this.toolTimes}play(){0!==this.segments.length&&(this.isPlaying=!0,this.lastTime=performance.now(),this.animate())}pause(){this.isPlaying=!1}reset(){this.currentIndex=0,this.accumulatedTime=0,this.isPlaying=!1,this.onUpdate&&this.onUpdate(this.currentIndex)}setSpeed(t){this.speed=Math.max(.1,Math.min(10,t))}static sliderToSpeed(t){return 0===t?1:t>0?1+t/10*9:1+t/10*.9}stepNext(){this.currentIndex<this.segments.length&&(this.currentIndex++,this.onUpdate&&this.onUpdate(this.currentIndex))}stepPrev(){this.currentIndex>0&&(this.currentIndex--,this.onUpdate&&this.onUpdate(this.currentIndex))}setCurrentLine(t){const e=Math.max(0,Math.min(t,this.segments.length));e!==this.currentIndex&&(this.currentIndex=e,this.isPlaying=!1,this.onUpdate&&this.onUpdate(this.currentIndex))}animate(){if(!this.isPlaying)return;const t=performance.now(),e=(t-this.lastTime)/1e3;if(this.lastTime=t,this.totalDistance>0){const t=100*this.speed*e;this.accumulatedTime+=t;const s=this.accumulatedTime;let i=0,n=0,a=this.segmentDistances.length-1;for(;n<a;){const t=Math.floor((n+a)/2);this.segmentDistances[t]<s?n=t+1:a=t}if(i=n,i<this.segments.length){const t=this.segments[i],e=i>0?this.segmentDistances[i-1]:0,n=this.segmentDistances[i]-e;if("cut"===t.type&&n>0){const t=s-e;this.segmentProgress=Math.min(1,Math.max(0,t/n))}else this.segmentProgress=1}else this.segmentProgress=1;if(this.currentIndex,this.currentIndex=i,this.onUpdate&&this.onUpdate(this.currentIndex,this.segmentProgress),this.accumulatedTime>=this.totalDistance)return this.currentIndex=this.segments.length,this.segmentProgress=1,this.isPlaying=!1,void(this.onUpdate&&this.onUpdate(this.currentIndex,1))}else if(this.estimatedTotalTime>0){this.accumulatedTime+=e*this.speed;const t=this.accumulatedTime/this.estimatedTotalTime,s=Math.floor(t*this.segments.length);if(s!==this.currentIndex&&s<=this.segments.length&&(this.currentIndex=s,this.segmentProgress=1,this.onUpdate&&this.onUpdate(this.currentIndex,1)),this.currentIndex>=this.segments.length)return this.currentIndex=this.segments.length,this.segmentProgress=1,this.isPlaying=!1,void(this.onUpdate&&this.onUpdate(this.currentIndex,1))}else{const t=100*this.speed*e;if(this.currentIndex+=t,this.segmentProgress=1,this.onUpdate&&this.onUpdate(Math.floor(this.currentIndex),1),this.currentIndex>=this.segments.length)return this.currentIndex=this.segments.length,this.segmentProgress=1,this.isPlaying=!1,void(this.onUpdate&&this.onUpdate(this.currentIndex,1))}requestAnimationFrame(()=>this.animate())}getProgress(){return 0===this.segments.length?0:this.currentIndex/this.segments.length*100}getCurrentIndex(){return Math.floor(this.currentIndex)}getTotalSegments(){return this.segments.length}getIsPlaying(){return this.isPlaying}}class Controller{constructor(){this.parser=new GCodeParser,this.camera=new Camera,this.animator=new Animator,this.canvas2d=document.getElementById("canvas2d"),this.canvas3d=document.getElementById("canvas3d"),this.canvas3dOverlay=document.getElementById("canvas3d-overlay"),this.renderer2d=new Renderer2D(this.canvas2d,this.camera),this.renderer3d=new Renderer3D(this.canvas3d,this.camera,this.canvas3dOverlay),this.currentView="2d",this.segments=[],this.bounds=null,this.isDragging=!1,this.lastMouseX=0,this.lastMouseY=0,this.isShiftPressed=!1,this.tools=new Map,this.toolColors=["#00ccff","#00ff88","#ff4dff","#ffff00","#ff8800","#8888ff","#ff0088","#00ffff"],this.rapidMovesVisible=!0,this.rapidMoveColor="#999999",this.spaceMouseConnected=!1,this.spaceMouseIndex=-1,this.touches=[],this.lastPinchDistance=0,this.lastTouchCenter=null,this.setupEventListeners(),this.setupAnimator(),this.setupSpaceMouse(),this.startRenderLoop()}setupSpaceMouse(){window.addEventListener("gamepadconnected",t=>{const e=t.gamepad;(e.id.toLowerCase().includes("3dconnexion")||e.id.toLowerCase().includes("spacemouse")||e.id.toLowerCase().includes("space"))&&(this.spaceMouseConnected=!0,this.spaceMouseIndex=e.index,console.log("SpaceMouse connected:",e.id))}),window.addEventListener("gamepaddisconnected",t=>{t.gamepad.index===this.spaceMouseIndex&&(this.spaceMouseConnected=!1,this.spaceMouseIndex=-1,console.log("SpaceMouse disconnected"))})}pollSpaceMouse(){if(!this.spaceMouseConnected||"3d"!==this.currentView)return;const t=navigator.getGamepads();if(!t||!t[this.spaceMouseIndex])return;const e=t[this.spaceMouseIndex],s=.05,i=[];for(let t=0;t<e.axes.length;t++)Math.abs(e.axes[t])>s&&i.push(`axis${t}=${e.axes[t].toFixed(2)}`);if(i.length>0&&console.log("Active axes:",i.join(", ")),e.axes.length>=3){const t=Math.abs(e.axes[0])>s?e.axes[0]:0,i=Math.abs(e.axes[2])>s?e.axes[2]:0;0===t&&0===i||this.camera.pan3D(.5*-t,.5*-i)}if(e.axes.length>=2){const t=Math.abs(e.axes[1])>s?e.axes[1]:0;0!==t&&(this.camera.zoom3D(.05*t),this.updateZoomSlider())}if(e.axes.length>=5){const t=Math.abs(e.axes[3])>s?e.axes[3]:0,i=Math.abs(e.axes[4])>s?e.axes[4]:0;0===t&&0===i||this.camera.rotate(15*i,15*-t)}e.axes.length>=6&&Math.abs(e.axes[5])>s&&e.axes[5]}setupEventListeners(){let t;document.querySelectorAll(".mobile-tab-button").forEach(t=>{t.addEventListener("click",()=>{const e=t.getAttribute("data-tab");this.switchMobileTab(e)})}),window.addEventListener("resize",()=>{clearTimeout(t),t=setTimeout(()=>{if(this.renderer2d.resizeCanvas(),this.renderer3d.resizeCanvas(),window.innerWidth>968)document.querySelectorAll(".mobile-tab-content").forEach(t=>{t.classList.add("active")});else{const t=document.querySelector(".mobile-tab-button.active");if(t){const e=t.getAttribute("data-tab");this.switchMobileTab(e)}}},100)});const e=document.getElementById("upload-zone"),s=document.getElementById("file-input");e&&s&&(e.addEventListener("click",()=>s.click()),e.addEventListener("dragover",t=>{t.preventDefault(),e.classList.add("drag-over")}),e.addEventListener("dragleave",()=>{e.classList.remove("drag-over")}),e.addEventListener("drop",t=>{t.preventDefault(),e.classList.remove("drag-over"),t.dataTransfer.files.length>0&&this.loadFile(t.dataTransfer.files[0])}),s.addEventListener("change",t=>{t.target.files.length>0&&this.loadFile(t.target.files[0])}));const i=document.getElementById("btn-toggle-view");i&&i.addEventListener("click",()=>{this.toggleView()});const n=document.getElementById("btn-reset-view");n&&n.addEventListener("click",()=>{this.segments.length>0&&(this.camera.fitToBounds(this.bounds,.1,this.canvas2d.width,this.canvas2d.height),this.updateZoomSlider())});const a=document.getElementById("btn-play");a&&a.addEventListener("click",()=>{this.togglePlayback()});const o=document.getElementById("btn-reset");o&&o.addEventListener("click",()=>{this.animator.reset()});const r=document.getElementById("btn-next");r&&r.addEventListener("click",()=>{this.animator.stepNext()});const h=document.getElementById("btn-prev");h&&h.addEventListener("click",()=>{this.animator.stepPrev()});const l=document.getElementById("speed-slider"),c=document.getElementById("speed-label");l&&c&&l.addEventListener("input",t=>{const e=Animator.sliderToSpeed(parseFloat(t.target.value));this.animator.setSpeed(e),c.textContent=e.toFixed(1)+"x"});const d=document.getElementById("line-slider");d&&d.addEventListener("input",t=>{const e=parseInt(t.target.value);this.animator.setCurrentLine(e)});const m=document.getElementById("layer-min"),g=document.getElementById("layer-max");m&&m.addEventListener("input",()=>{this.updateLayerFilter()}),g&&g.addEventListener("input",()=>{this.updateLayerFilter()});const u=document.getElementById("zoom-slider"),x=document.getElementById("zoom-value");u&&x&&u.addEventListener("input",t=>{const e=parseFloat(t.target.value);if("2d"===this.currentView){const t=e*this.camera.initialZoom2d;this.setZoom(t)}else{const t=this.camera.initialOrthoScale/e;this.camera.orthoScale=t,this.render()}x.textContent=Math.round(100*e)+"%"});const p=document.getElementById("theme-light"),y=document.getElementById("theme-dark");if(p&&y){const t=localStorage.getItem("theme")||"light";document.documentElement.setAttribute("data-theme",t),p.addEventListener("click",()=>{document.documentElement.setAttribute("data-theme","light"),localStorage.setItem("theme","light"),this.render()}),y.addEventListener("click",()=>{document.documentElement.setAttribute("data-theme","dark"),localStorage.setItem("theme","dark"),this.render()})}const f=document.getElementById("grid-enabled");f&&f.addEventListener("change",()=>{});const v=document.getElementById("grid-width");v&&v.addEventListener("input",()=>{});const M=document.getElementById("grid-height");M&&M.addEventListener("input",()=>{});const b=document.getElementById("rapid-moves-visible"),T=document.getElementById("rapid-move-color");b&&b.addEventListener("change",()=>{this.rapidMovesVisible=b.checked,this.updateRenderers()}),T&&T.addEventListener("input",()=>{this.rapidMoveColor=T.value,this.updateRenderers()}),this.setupCanvasEvents(),window.addEventListener("keydown",t=>{"Shift"===t.key&&(this.isShiftPressed=!0)}),window.addEventListener("keyup",t=>{"Shift"===t.key&&(this.isShiftPressed=!1)})}setupCanvasEvents(){const t=this.canvas2d,e=this.canvas3d,s=t=>{this.isDragging=!0,this.dragButton=t.button,this.lastMouseX=t.clientX,this.lastMouseY=t.clientY,2===t.button&&t.preventDefault()},i=e=>{if(this.isDragging){const t=e.clientX-this.lastMouseX,s=e.clientY-this.lastMouseY;"2d"===this.currentView?this.camera.pan2D(t,s):2===this.dragButton?this.camera.pan3D(t,s):this.camera.rotate(t,s),this.lastMouseX=e.clientX,this.lastMouseY=e.clientY}else if("2d"===this.currentView){const s=t.getBoundingClientRect(),i=e.clientX-s.left,n=e.clientY-s.top,a=this.renderer2d.canvasToWorld(i,n);this.updateCoordinateDisplay(a.x,a.y,0)}},n=()=>{this.isDragging=!1},a=e=>{if(e.preventDefault(),"2d"===this.currentView){const s=t.getBoundingClientRect(),i=e.clientX-s.left,n=e.clientY-s.top;this.camera.zoom2D(e.deltaY,i,n,t.width,t.height)}else this.camera.zoom3D(e.deltaY);this.updateZoomSlider()},o=()=>{this.bounds&&this.camera.fitToBounds(this.bounds)},r=t=>{t.preventDefault()};[t,e].forEach(t=>{t.addEventListener("mousedown",s),t.addEventListener("mousemove",i),t.addEventListener("mouseup",n),t.addEventListener("mouseleave",n),t.addEventListener("wheel",a,{passive:!1}),t.addEventListener("dblclick",o),t.addEventListener("contextmenu",r)});const h=t=>{t.preventDefault(),this.touches=Array.from(t.touches),1===this.touches.length?(this.isDragging=!0,this.lastMouseX=this.touches[0].clientX,this.lastMouseY=this.touches[0].clientY):2===this.touches.length&&(this.lastPinchDistance=this.getTouchDistance(this.touches[0],this.touches[1]),this.lastTouchCenter=this.getTouchCenter(this.touches[0],this.touches[1]))},l=e=>{if(e.preventDefault(),this.touches=Array.from(e.touches),1===this.touches.length&&this.isDragging){const t=this.touches[0].clientX-this.lastMouseX,e=this.touches[0].clientY-this.lastMouseY;"2d"===this.currentView?this.camera.pan2D(t,e):this.camera.rotate(1.5*t,1.5*e),this.lastMouseX=this.touches[0].clientX,this.lastMouseY=this.touches[0].clientY}else if(2===this.touches.length){const e=this.getTouchDistance(this.touches[0],this.touches[1]),s=this.getTouchCenter(this.touches[0],this.touches[1]),i=e-this.lastPinchDistance;if("2d"===this.currentView){if(Math.abs(i)<100&&Math.abs(i)>.5){const e=t.getBoundingClientRect(),n=s.x-e.left,a=s.y-e.top;this.renderer2d.canvasToWorld(n,a),this.camera.zoom2D(-i,n,a,e.width,e.height,!0)}}else{if(this.lastTouchCenter){const t=s.x-this.lastTouchCenter.x,e=s.y-this.lastTouchCenter.y;Math.sqrt(t*t+e*e)>2&&this.camera.pan3D(2*t,2*e)}Math.abs(i)>5&&this.camera.zoom3D(.003*-i)}this.lastPinchDistance=e,this.lastTouchCenter=s}},c=()=>{this.isDragging=!1,this.touches=[],this.lastTouchCenter=null};[t,e].forEach(t=>{t.addEventListener("touchstart",h,{passive:!1}),t.addEventListener("touchmove",l,{passive:!1}),t.addEventListener("touchend",c,{passive:!1})})}getTouchDistance(t,e){const s=e.clientX-t.clientX,i=e.clientY-t.clientY;return Math.sqrt(s*s+i*i)}getTouchCenter(t,e){return{x:(t.clientX+e.clientX)/2,y:(t.clientY+e.clientY)/2}}setupAnimator(){this.animator.onUpdate=(t,e=1)=>{if(this.renderer2d.setMaxSegmentIndex(t,e),this.renderer3d.setMaxSegmentIndex(t,e),document.getElementById("current-line").textContent=t,document.getElementById("line-slider").value=t,t<this.segments.length){const e=this.segments[t];this.currentPosition={x:e.x1,y:e.y1,z:e.z1},this.highlightGCodeLine(e.lineNum),document.getElementById("current-file-line").textContent=e.lineNum||"-"}else document.getElementById("current-file-line").textContent="-";document.getElementById("btn-play").textContent=this.animator.getIsPlaying()?"Pause":"Play"}}async loadFile(t){const e=document.getElementById("progress-bar"),s=document.getElementById("progress-fill");e.classList.remove("hidden"),s.style.width="0%";try{const i=await t.text();this.gcodeText=i;const n=await this.parser.parseFile(t,t=>{s.style.width=t+"%"});this.segments=n,this.bounds=this.parser.getBounds(),this.detectTools(n),this.renderer2d.setSegments(n,this.bounds),this.renderer3d.setSegments(n,this.bounds),this.updateRenderers(),this.animator.setSegments(n),this.camera.fitToBounds(this.bounds,.1,this.canvas2d.width,this.canvas2d.height),this.updateStatistics(),this.displayGCode(i),this.updateToolPanel();const a=document.getElementById("gcode-panel");a.style.visibility="visible",a.style.position="static",document.getElementById("animation-panel").style.display="block",document.getElementById("tool-panel").style.display="block";const o=document.getElementById("rapid-moves-panel");o&&(o.style.display="block"),document.getElementById("btn-reset-view").disabled=!1;const r=document.querySelector(".left-sidebar");r&&r.classList.remove("gcode-hidden");const h=document.getElementById("gcode-welcome");h&&(h.style.display="none");const l=document.getElementById("line-slider");l.max=n.length,l.value=0,document.getElementById("total-lines").textContent=n.length,setTimeout(()=>{e.classList.add("hidden")},500)}catch(t){console.error("Error loading file:",t),alert("Error loading GCode file. Please check the console for details."),e.classList.add("hidden")}}async loadGCodeFromString(t,e=""){const s=document.getElementById(`${e}progress-bar`),i=document.getElementById(`${e}progress-fill`),n=t.split("\n").filter(t=>/Y\d{5,}/.test(t));n.length>0?console.error(`CONTROLLER ERROR: String has ${n.length} bad lines:`,n.slice(0,2)):console.log("‚úì Controller OK: String is clean in loadGCodeFromString"),s&&(s.classList.remove("hidden"),i.style.width="0%");try{this.gcodeText=t;const n=await this.parser.parseString(t,t=>{i&&(i.style.width=t+"%")});this.segments=n,this.bounds=this.parser.getBounds(),this.detectTools(n),this.renderer2d.setSegments(n,this.bounds),this.renderer3d.setSegments(n,this.bounds),this.updateRenderers(),this.animator.setSegments(n),this.camera.fitToBounds(this.bounds,.1,this.canvas2d.width,this.canvas2d.height),this.updateStatistics(e),this.displayGCode(t,e),this.updateToolPanel(e);const a=document.getElementById(`${e}gcode-panel`);a&&(a.style.visibility="visible",a.style.position="static");const o=document.getElementById(`${e}animation-panel`);o&&(o.style.display="block");const r=document.getElementById(`${e}tool-panel`);r&&(r.style.display="block");const h=document.getElementById(`${e}rapid-moves-panel`);h&&(h.style.display="block");const l=document.getElementById(`${e}btn-reset-view`);l&&(l.disabled=!1);const c=document.querySelector(e?`.${e}left-sidebar`:".left-sidebar");c&&c.classList.remove("gcode-hidden");const d=document.getElementById(`${e}gcode-welcome`);d&&(d.style.display="none");const m=document.getElementById(`${e}line-slider`);m&&(m.max=n.length,m.value=0);const g=document.getElementById(`${e}total-lines`);g&&(g.textContent=n.length),this.is3DView?this.renderer3d.render():this.renderer2d.render(),s&&setTimeout(()=>{s.classList.add("hidden")},500)}catch(t){console.error("Error loading GCode:",t),alert("Error parsing GCode. Please check the console for details."),s&&s.classList.add("hidden")}}detectTools(t){const e=new Set;for(const s of t)"rapid"!==s.type&&e.add(s.tool||1);const s=this.parser.getToolNames(),i=this.parser.getToolColors(),n=this.parser.usingInlineToolFormat;this.tools.clear();const a=Array.from(e).sort((t,e)=>t-e);for(const t of a){const e=n?t:t-1,a=i[e],o=t%this.toolColors.length,r=this.toolColors[o];this.tools.set(t,{visible:!0,color:a||r,name:s[e]||`Tool ${t}`})}}updateToolPanel(t=""){const e=document.getElementById(`${t}tool-list`);if(e)if(e.innerHTML="",0!==this.tools.size)for(const[t,s]of this.tools){const i=document.createElement("div");i.style.cssText="display: flex; align-items: center; gap: 8px; margin-bottom: 8px; padding: 8px; background: var(--canvas-bg); border-radius: 4px;";const n=document.createElement("input");n.type="checkbox",n.checked=s.visible,n.onchange=()=>{s.visible=n.checked,this.updateRenderers()};const a=document.createElement("input");a.type="color",a.value=s.color,a.style.cssText="width: 32px; height: 24px; border: none; cursor: pointer;",a.onchange=()=>{s.color=a.value,this.updateRenderers()};const o=document.createElement("div");o.style.cssText="flex: 1; display: flex; flex-direction: column; gap: 2px;";const r=document.createElement("span"),h=s.name?`Tool ${t} - ${s.name}`:`Tool ${t}`;r.textContent=h,r.style.cssText="font-size: 13px;";const l=document.createElement("span"),c=this.animator.getToolTime(t);l.textContent=`Est. Time: ${c}`,l.style.cssText="font-size: 11px; opacity: 0.7;",o.appendChild(r),o.appendChild(l),i.appendChild(n),i.appendChild(a),i.appendChild(o),e.appendChild(i)}else e.innerHTML='<div style="padding: 10px; opacity: 0.7; font-size: 12px;">No tools detected</div>'}updateRenderers(){this.renderer2d.setToolStates(this.tools),this.renderer3d.setToolStates(this.tools),this.renderer2d.setRapidMoveSettings(this.rapidMovesVisible,this.rapidMoveColor),this.renderer3d.setRapidMoveSettings(this.rapidMovesVisible,this.rapidMoveColor),this.renderer2d.updateBuffers(),this.renderer3d.updateBuffers()}updateStatistics(t=""){const e=document.getElementById(`${t}stat-lines`),s=document.getElementById(`${t}stat-time`),i=document.getElementById(`${t}stat-x`),n=document.getElementById(`${t}stat-y`),a=document.getElementById(`${t}stat-z`),o=document.getElementById(`${t}total-lines`),r=document.getElementById(`${t}current-line`),h=document.getElementById(`${t}layer-min`),l=document.getElementById(`${t}layer-max`);e&&(e.textContent=this.segments.length),s&&(s.textContent=this.animator.getFormattedTime()),i&&(i.textContent=`${this.bounds.minX.toFixed(1)} to ${this.bounds.maxX.toFixed(1)}`),n&&(n.textContent=`${this.bounds.minY.toFixed(1)} to ${this.bounds.maxY.toFixed(1)}`),a&&(a.textContent=`${this.bounds.minZ.toFixed(1)} to ${this.bounds.maxZ.toFixed(1)}`),o&&(o.textContent=this.segments.length),r&&(r.textContent="0"),h&&(h.placeholder=this.bounds.minZ.toFixed(1)),l&&(l.placeholder=this.bounds.maxZ.toFixed(1))}updateCoordinateDisplay(t,e,s){const i=document.getElementById("coordinates");i&&(i.textContent=`X: ${t.toFixed(2)} Y: ${e.toFixed(2)} Z: ${s.toFixed(2)}`)}displayGCode(t,e=""){const s=document.getElementById(`${e}gcode-container`);if(!s)return;const i=t.split("\n"),n=i.length;this.gcodeLines=i,this.gcodeLineHeight=17,this.gcodeCurrentHighlight=null;const a=document.getElementById(`${e}gcode-line-indicator`);a&&(a.textContent=`(${n} lines)`),s.innerHTML=`\n <div style="min-height: ${(n+10)*this.gcodeLineHeight}px; position: relative; width: max-content; min-width: 100%;">\n <div id="${e}gcode-viewport" style="position: absolute; top: 0; left: 0; will-change: transform;">\n <div style="display: flex;">\n <div class="gcode-line-numbers" id="${e}gcode-line-numbers"></div>\n <div class="gcode-code" id="${e}gcode-display"></div>\n </div>\n </div>\n </div>\n `;const o=document.getElementById(`${e}gcode-viewport`),r=document.getElementById(`${e}gcode-display`),h=document.getElementById(`${e}gcode-line-numbers`);let l=-1;const c=(t=!1)=>{const e=s.scrollTop;let a=s.clientHeight;a&&0!==a||(a=s.offsetHeight||.5*window.innerHeight);const c=Math.max(0,Math.floor(e/this.gcodeLineHeight)-50),d=Math.min(n,c+Math.ceil(a/this.gcodeLineHeight)+150);if(!t&&c===l)return;l=c,o.style.transform=`translateY(${c*this.gcodeLineHeight}px)`;const m=[];for(let t=c;t<d;t++){const e=this.gcodeCurrentHighlight===t+1?" highlight":"";m.push(`<div class="gcode-line${e}" data-line="${t+1}">${t+1}</div>`)}h.innerHTML=m.join("");const g=[];for(let t=c;t<d;t++){const e=this.gcodeCurrentHighlight===t+1?" highlight":"",s=this.syntaxHighlightGCode(i[t]);g.push(`<div class="gcode-line${e}" data-line="${t+1}">${s||"&nbsp;"}</div>`)}r.innerHTML=g.join("")};this.gcodeRenderVisibleLines=c;let d=!1;s.addEventListener("scroll",()=>{d||(requestAnimationFrame(()=>{c(),d=!1}),d=!0)},{passive:!0}),c(!0),requestAnimationFrame(()=>c(!0)),setTimeout(()=>c(!0),100),s.addEventListener("click",t=>{const e=t.target.closest(".gcode-line");if(!e)return;const s=parseInt(e.dataset.line);if(!s)return;const i=this.segments.findIndex(t=>t.lineNum>=s);-1!==i&&(this.animator.currentIndex=i,this.animator.onUpdate(i),"2d"===this.currentView?this.renderer2d.render():this.renderer3d.render(),this.highlightGCodeLine(s))})}syntaxHighlightGCode(t){let e=t,s=[];const i=t.indexOf(";"),n=t.indexOf("("),a=t.indexOf(")");return-1!==n&&-1!==a&&a>n?(s.push({text:t.substring(0,n),isComment:!1}),s.push({text:t.substring(n,a+1),isComment:!0}),s.push({text:t.substring(a+1),isComment:!1})):-1!==i?(s.push({text:t.substring(0,i),isComment:!1}),s.push({text:t.substring(i),isComment:!0})):s.push({text:t,isComment:!1}),e=s.map(t=>{if(t.isComment)return`<span class="gcode-comment">${this.escapeHtml(t.text)}</span>`;let e=t.text;return e=e.replace(/\$([A-Za-z0-9\/=]+)/g,'<span class="gcode-system">$$1</span>'),e=e.replace(/\b([GM])(\d+(\.\d+)?)/gi,(t,e,s)=>`<span class="${"G"===e.toUpperCase()?"gcode-g-code":"gcode-m-code"}">${e}${s}</span>`),e=e.replace(/\b(T)(\d+)/gi,'<span class="gcode-t-code">$1$2</span>'),e=e.replace(/\b(S)(\d+(\.\d+)?)/gi,'<span class="gcode-s-code">$1$2</span>'),e=e.replace(/([X])([-+]?\d+(\.\d+)?)/gi,'<span class="gcode-x-axis">$1$2</span>'),e=e.replace(/([Y])([-+]?\d+(\.\d+)?)/gi,'<span class="gcode-y-axis">$1$2</span>'),e=e.replace(/([Z])([-+]?\d+(\.\d+)?)/gi,'<span class="gcode-z-axis">$1$2</span>'),e=e.replace(/([ABCIJK])([-+]?\d+(\.\d+)?)/gi,'<span class="gcode-coordinate">$1$2</span>'),e=e.replace(/([F])(\d+(\.\d+)?)/gi,'<span class="gcode-f-code">$1$2</span>'),e}).join(""),e}escapeHtml(t){const e=document.createElement("div");return e.textContent=t,e.innerHTML}highlightGCodeLine(t){const e=document.getElementById("gcode-container");if(t<1||!e)return;this.gcodeCurrentHighlight=t;const s=e.scrollTop,i=e.clientHeight||600,n=(t-1)*this.gcodeLineHeight,a=n+this.gcodeLineHeight,o=.2*i;if(n>=s+o&&a<=s+i-o&&this.gcodeRenderVisibleLines)this.gcodeRenderVisibleLines(!0);else{const t=n-i/2+this.gcodeLineHeight/2;e.scrollTop=Math.max(0,t)}}updateLayerFilter(){const t=document.getElementById("layer-min"),e=document.getElementById("layer-max"),s=t.value?parseFloat(t.value):-1/0,i=e.value?parseFloat(e.value):1/0;this.renderer2d.setLayerFilter(s,i),this.renderer3d.setLayerFilter(s,i)}setZoom(t){if("2d"===this.currentView)this.camera.zoom2d=t,this.camera.targetZoom2d=t;else{const e=100;this.camera.orthoScale=e/t}}toggleView(){"2d"===this.currentView?(this.currentView="3d",this.canvas2d.classList.add("hidden"),this.canvas3d.classList.remove("hidden"),this.canvas3dOverlay.classList.remove("hidden"),document.getElementById("btn-toggle-view").textContent="2D View"):(this.currentView="2d",this.canvas3d.classList.add("hidden"),this.canvas3dOverlay.classList.add("hidden"),this.canvas2d.classList.remove("hidden"),document.getElementById("btn-toggle-view").textContent="3D View"),this.updateZoomSlider()}updateZoomSlider(){const t=document.getElementById("zoom-slider"),e=document.getElementById("zoom-value");let s;s="2d"===this.currentView?this.camera.zoom2d/this.camera.initialZoom2d:this.camera.initialOrthoScale/this.camera.orthoScale,t.value=s,e.textContent=Math.round(100*s)+"%"}togglePlayback(){this.animator.getIsPlaying()?this.animator.pause():this.animator.play()}switchMobileTab(t){document.querySelectorAll(".mobile-tab-button").forEach(e=>{e.classList.toggle("active",e.getAttribute("data-tab")===t)}),document.querySelectorAll(".mobile-tab-content").forEach(e=>{e.classList.toggle("active",e.getAttribute("data-tab-content")===t)})}startRenderLoop(){const t=()=>{this.pollSpaceMouse(),this.camera.update(),"2d"===this.currentView?this.renderer2d.render():this.renderer3d.render(),requestAnimationFrame(t)};t()}}window.addEventListener("DOMContentLoaded",()=>{document.getElementById("text-to-gcode")||new Controller});</script></body></html>

