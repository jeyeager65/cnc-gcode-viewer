<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"><title>GCode Font Creator</title><style>:root[data-theme="light"]{--bg-color:#ffffff;--text-color:#333333;--border-color:#cccccc;--panel-bg:#f5f5f5;--button-bg:#e0e0e0;--button-hover:#d0d0d0;--canvas-bg:#fafafa;--rapid-color:#999999;--cut-color:#0066cc;--grid-color:#e0e0e0;--gcode-comment:#808080;--gcode-g-code:#0066aa;--gcode-m-code:#8b3e8e;--gcode-t-code:#b5640f;--gcode-s-code:#008577;--gcode-f-code:#a65e3e;--gcode-coordinate:#6a8759;--gcode-system:#cc7000;--gcode-x-axis:#1976d2;--gcode-y-axis:#388e3c;--gcode-z-axis:#7b1fa2;}:root[data-theme="dark"]{--bg-color:#1e1e1e;--text-color:#e0e0e0;--border-color:#444444;--panel-bg:#2d2d2d;--button-bg:#3d3d3d;--button-hover:#4d4d4d;--canvas-bg:#252525;--rapid-color:#ff9933;--cut-color:#00ccff;--grid-color:#3a3a3a;--gcode-comment:#999999;--gcode-g-code:#4fc3ff;--gcode-m-code:#e1aaff;--gcode-t-code:#ffd180;--gcode-s-code:#80cbc4;--gcode-f-code:#ffab91;--gcode-coordinate:#8fd6a3;--gcode-system:#ffb84d;--gcode-x-axis:#42a5f5;--gcode-y-axis:#66bb6a;--gcode-z-axis:#ba68c8;}:root[data-theme="dark"] *::-webkit-scrollbar{width:16px;height:16px;}:root[data-theme="dark"] *::-webkit-scrollbar-track{background:#2a2a2a;}:root[data-theme="dark"] *::-webkit-scrollbar-thumb{background:#555555;border-radius:8px;border:3px solid #2a2a2a;}:root[data-theme="dark"] *::-webkit-scrollbar-thumb:hover{background:#666666;}:root[data-theme="dark"] *{scrollbar-width:auto;scrollbar-color:#555555 #2a2a2a;}*{margin:0;padding:0;box-sizing:border-box;}body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,sans-serif;background-color:var(--bg-color);color:var(--text-color);overflow:hidden;height:100vh;}.container{display:grid;grid-template-columns:400px 1fr 360px;grid-template-rows:60px 1fr 40px;height:100vh;gap:0;}header{grid-column:1 / -1;grid-row:1;background-color:var(--panel-bg);border-bottom:1px solid var(--border-color);display:flex;align-items:center;justify-content:space-between;padding:0 20px;}header h1{font-size:1.5rem;font-weight:600;}.header-controls{display:flex;gap:10px;align-items:center;}.header-controls a{text-decoration:none;color:var(--text-color);padding:8px 16px;background-color:var(--button-bg);border:1px solid var(--border-color);border-radius:4px;font-size:0.9rem;transition:background-color 0.2s;display:inline-flex;align-items:center;justify-content:center;box-sizing:border-box;line-height:1;min-height:38px;}.header-controls a:hover{background-color:var(--button-hover);}button{background-color:var(--button-bg);color:var(--text-color);border:1px solid var(--border-color);padding:8px 16px;border-radius:4px;cursor:pointer;font-size:14px;transition:background-color 0.2s;}button:hover{background-color:var(--button-hover);}button:active{transform:translateY(1px);}button:disabled{opacity:0.5;cursor:not-allowed;}.canvas-container{position:relative;background-color:var(--canvas-bg);overflow:hidden;grid-column:2;grid-row:2;}.canvas-overlay-controls{position:absolute;top:10px;right:10px;display:flex;gap:10px;z-index:10;}.canvas-overlay-controls button{padding:8px 16px;background-color:rgba(0,0,0,0.7);color:white;border:1px solid rgba(255,255,255,0.3);border-radius:4px;cursor:pointer;font-size:14px;backdrop-filter:blur(5px);}.canvas-overlay-controls button:hover{background-color:rgba(0,0,0,0.85);}.canvas-overlay-controls button:disabled{opacity:0.5;cursor:not-allowed;}canvas{display:block;width:100%;height:100%;cursor:grab;}canvas:active{cursor:grabbing;}#canvas2d,#canvas3d{position:absolute;top:0;left:0;}#canvas3d-overlay{position:absolute;top:0;left:0;pointer-events:none;}.hidden{display:none !important;}.sidebar{background-color:var(--panel-bg);border-left:1px solid var(--border-color);overflow-y:auto;padding:20px;grid-column:3;grid-row:2;}.left-sidebar{background-color:var(--panel-bg);border-right:1px solid var(--border-color);padding:0;display:flex;flex-direction:column;overflow:hidden;grid-column:1;grid-row:2;min-height:0;height:100%;}#gcode-panel{display:flex !important;flex:1;flex-direction:column;overflow:hidden;min-height:0;height:100%;padding:10px;margin:20px;}#gcode-panel h3{margin:10px 0 10px 0;flex-shrink:0;}#gcode-panel{display:flex !important;flex:1;flex-direction:column;overflow:hidden;min-height:0;}#gcode-container{flex:1;overflow-y:auto;overflow-x:auto;background-color:var(--canvas-bg);border:none;font-family:'Consolas','Monaco',monospace;font-size:11px;line-height:17px;min-height:0;padding-bottom:10px;margin-bottom:5px;}#gcode-content{display:flex;}.gcode-line-numbers{color:var(--text-muted);text-align:right;padding:4px 8px 4px 4px;user-select:none;border-right:1px solid var(--border-color);min-width:30px;}.gcode-code{flex:1;padding:4px;white-space:pre;}.gcode-line{cursor:pointer;}.gcode-line:hover{background-color:rgba(255,255,255,0.05) !important;}.gcode-line.highlight{background-color:rgba(255,193,7,0.3) !important;}.gcode-line-numbers .gcode-line.highlight{border-left:3px solid rgba(255,193,7,0.8) !important;padding-left:2px !important;}.gcode-comment{color:var(--gcode-comment);}.gcode-g-code{color:var(--gcode-g-code);font-weight:bold;}.gcode-m-code{color:var(--gcode-m-code);font-weight:bold;}.gcode-t-code{color:var(--gcode-t-code);font-weight:bold;}.gcode-s-code{color:var(--gcode-s-code);}.gcode-f-code{color:var(--gcode-f-code);}.gcode-coordinate{color:var(--gcode-coordinate);}.gcode-system{color:var(--gcode-system);font-weight:bold;}.gcode-x-axis{color:var(--gcode-x-axis);font-weight:500;}.gcode-y-axis{color:var(--gcode-y-axis);font-weight:500;}.gcode-z-axis{color:var(--gcode-z-axis);font-weight:500;}.gcode-hidden{display:none !important;}.panel{background-color:var(--bg-color);border:1px solid var(--border-color);border-radius:4px;padding:15px;margin-bottom:15px;}.panel h3{font-size:1rem;margin-bottom:10px;font-weight:600;}.file-upload-zone{border:2px dashed var(--border-color);border-radius:4px;padding:30px;text-align:center;cursor:pointer;transition:border-color 0.2s;}.file-upload-zone:hover{border-color:var(--cut-color);}.file-upload-zone.drag-over{border-color:var(--cut-color);background-color:var(--canvas-bg);}input[type="file"]{display:none;}select{width:100%;padding:8px;background-color:var(--button-bg);color:var(--text-color);border:1px solid var(--border-color);border-radius:4px;font-size:14px;cursor:pointer;margin-top:10px;}input[type="range"]{width:100%;margin-top:10px;}.stats-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px;}.stat-item{background-color:var(--panel-bg);padding:8px;border-radius:4px;}.stat-label{font-size:11px;opacity:0.7;text-transform:uppercase;}.stat-value{font-size:16px;font-weight:600;margin-top:2px;}.progress-bar{width:100%;height:4px;background-color:var(--border-color);border-radius:2px;overflow:hidden;margin-top:10px;position:relative;}.progress-bar.indeterminate .progress-fill{width:30% !important;animation:indeterminate 1.5s ease-in-out infinite;}@keyframes indeterminate{0%{transform:translateX(-100%);}50%{transform:translateX(350%);}100%{transform:translateX(-100%);}}.progress-fill{height:100%;background-color:var(--cut-color);width:0%;transition:width 0.3s;}.animation-controls{margin-top:15px;}.controls-row{display:flex;gap:5px;margin-bottom:10px;}.controls-row button{flex:1;padding:6px;font-size:12px;}.layer-controls{margin-top:10px;}.layer-inputs{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px;}.layer-inputs > div{display:flex;flex-direction:column;}.layer-inputs input{width:100%;padding:6px;background-color:var(--button-bg);color:var(--text-color);border:1px solid var(--border-color);border-radius:4px;font-size:14px;box-sizing:border-box;}footer{grid-column:1 / -1;grid-row:3;background-color:var(--panel-bg);border-top:1px solid var(--border-color);display:flex;align-items:center;justify-content:space-between;padding:0 20px;font-size:12px;}.coordinate-display{font-family:'Courier New',monospace;}.privacy-notice{font-size:11px;opacity:0.7;margin-top:15px;padding-top:15px;border-top:1px solid var(--border-color);text-align:center;}.mobile-tabs{display:none;background-color:var(--panel-bg);border-bottom:1px solid var(--border-color);overflow-x:auto;overflow-y:hidden;}.mobile-tabs-nav{display:flex;gap:0;min-width:100%;}.mobile-tab-button{flex:1;padding:12px 16px;background:none;border:none;border-bottom:3px solid transparent;cursor:pointer;font-size:14px;color:var(--text-color);transition:all 0.2s;white-space:nowrap;}.mobile-tab-button:hover{background-color:rgba(0,0,0,0.05);}.mobile-tab-button.active{border-bottom-color:#0066aa;font-weight:bold;}.mobile-tab-content{display:none;}.mobile-tab-content.active{display:block;}@media (min-width:969px){.mobile-tab-content{display:block !important;}}@media (max-width:1200px){.container{grid-template-columns:300px 1fr 300px;}}@media (max-width:968px){.container{grid-template-columns:1fr;grid-template-rows:auto 1fr;}body{overflow:hidden;height:100vh;height:100dvh;}header{position:absolute;width:0;height:0;overflow:hidden;visibility:hidden;}.mobile-tabs{display:block;grid-row:1;}.canvas-overlay-controls{top:5px;right:5px;gap:5px;}.canvas-overlay-controls button{padding:6px 10px;font-size:12px;}.header-controls button{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}#btn-play::before{content:'‚ñ∂Ô∏è ';}#btn-step-back::before{content:'‚èÆÔ∏è ';}#btn-step-forward::before{content:'‚è≠Ô∏è ';}#btn-reset-animation::before{content:'‚èπÔ∏è ';}.file-upload-zone::before{content:'üìÅ\A';white-space:pre;font-size:2em;display:block;margin-bottom:10px;}.left-sidebar{grid-row:2;grid-column:1;border-right:none;border-top:1px solid var(--border-color);overflow:hidden;padding:0;}#gcode-panel{display:flex !important;height:100%;flex-direction:column;}.canvas-container{grid-row:2;grid-column:1;width:100%;height:100%;position:relative;min-height:300px;}canvas{position:absolute;top:0;left:0;width:100% !important;height:100% !important;}.sidebar{grid-row:2;grid-column:1;border-left:none;border-top:1px solid var(--border-color);max-height:none;overflow-y:auto;overflow-y:auto;padding:10px;}.panel{margin-bottom:10px;padding:10px;}.stats-grid{grid-template-columns:repeat(2,1fr);}.slider-container{font-size:12px;}input[type="range"]{height:30px;}button{min-height:44px;font-size:14px;}footer{position:absolute;width:0;height:0;overflow:hidden;visibility:hidden;}}@media (max-width:480px){.header-controls{flex-wrap:wrap;}.header-controls button{flex:1 1 45%;margin:2px;}.stats-grid{grid-template-columns:1fr;}.panel h3{font-size:0.9rem;}.mobile-tab-button{padding:0px 12px;}#settings-tab .panel,#gcode-tab .panel,#gcode-panel{padding:6px;margin-bottom:6px;}#settings-tab .panel h3,#gcode-tab .panel h3,#gcode-panel h3{margin-bottom:4px;}#settings-tab .control-group,#gcode-tab .control-group{margin-bottom:6px;}#settings-tab .slider-container,#gcode-tab .slider-container{margin:4px 0;}#settings-tab label,#gcode-tab label{margin-bottom:2px;}#settings-tab input,#settings-tab select,#settings-tab button,#gcode-tab input,#gcode-tab select,#gcode-tab button{padding:6px 8px;}.container{padding:0 !important;}header{padding:0 4px;}.sidebar{padding:2px;}#gcode-panel{margin:6px;padding:4px;}#gcode-panel h3{margin:4px 0;}}@media (hover:none) and (pointer:coarse){button,input[type="checkbox"],input[type="color"]{min-height:44px;min-width:44px;}.slider-container input[type="range"]{height:44px;}.gcode-line{line-height:24px;height:24px;padding:2px 0;}}</style><style> body{height:100vh;display:flex;flex-direction:column;overflow:hidden;}header{padding:15px;background-color:var(--panel-bg);border-bottom:1px solid var(--border-color);display:flex;justify-content:space-between;align-items:center;flex-shrink:0;}header h1{font-size:20px;font-weight:600;margin:0;}input[type="text"],input[type="number"],textarea,select{width:100%;padding:8px 12px;background-color:var(--button-bg);color:var(--text-color);border:1px solid var(--border-color);border-radius:4px;font-size:14px;font-family:inherit;box-sizing:border-box;transition:border-color 0.2s;}input[type="text"]:focus,input[type="number"]:focus,textarea:focus,select:focus{outline:none;border-color:var(--button-active);}textarea{resize:vertical;font-family:inherit;}.input-group{margin-bottom:15px;}.input-group label{display:block;font-size:13px;font-weight:500;margin-bottom:5px;color:var(--text-color);}button{background-color:var(--button-bg);color:var(--text-color);border:1px solid var(--border-color);padding:8px 16px;border-radius:4px;cursor:pointer;font-size:14px;transition:background-color 0.2s;}button:hover{background-color:var(--button-hover);}button:active{transform:translateY(1px);}button.primary{background-color:var(--button-active);color:white;border-color:var(--button-active);}button.primary:hover{opacity:0.9;}.status{flex:1;font-size:13px;opacity:0.7;}.tab-nav{display:flex;background-color:var(--panel-bg);border-bottom:1px solid var(--border-color);padding:0 15px;gap:5px;}.tab-button{padding:12px 24px;background:none;border:none;border-bottom:3px solid transparent;color:var(--text-color);cursor:pointer;font-size:14px;font-weight:500;transition:all 0.2s;opacity:0.7;}.tab-button:hover{opacity:1;background-color:var(--button-hover);}.tab-button.active{opacity:1;border-bottom-color:var(--button-active);}.tab-content{display:none;flex:1;overflow:hidden;flex-direction:column;}.tab-content.active{display:flex;}.main-container{display:flex;flex:1;overflow:hidden;}.left-panel{width:300px;background-color:var(--panel-bg);border-right:1px solid var(--border-color);overflow-y:auto;padding:15px;flex-shrink:0;}.center-panel{flex:1;display:flex;flex-direction:column;overflow:hidden;}.canvas-container{flex:1;display:flex;align-items:center;justify-content:center;background-color:var(--canvas-bg);position:relative;overflow:hidden;}#drawing-canvas{border:2px solid var(--border-color);cursor:crosshair;touch-action:none;background-color:white;display:block;}.toolbar{padding:15px;background-color:var(--panel-bg);border-top:1px solid var(--border-color);display:flex;gap:10px;flex-wrap:wrap;align-items:center;}.section{margin-bottom:20px;}.section h3{font-size:14px;font-weight:600;margin-bottom:10px;color:var(--text-color);}.collapsible-header{cursor:pointer;user-select:none;display:flex;justify-content:space-between;align-items:center;padding:8px 10px;margin:-5px -5px 10px -5px;border-radius:4px;transition:background-color 0.2s,border-color 0.2s;background-color:var(--button-bg);border:1px solid var(--border-color);}.collapsible-header:hover{background-color:var(--button-hover);border-color:var(--text-color);}.collapse-icon{font-size:12px;transition:transform 0.2s;}.collapsible-header.collapsed .collapse-icon{transform:rotate(-90deg);}.collapsible-content{max-height:1000px;overflow:hidden;transition:max-height 0.3s ease-out,opacity 0.3s ease-out;opacity:1;}.collapsible-content.collapsed{max-height:0;opacity:0;}.char-grid{font-size:12px;transition:transform 0.2s;}.collapsible-header.collapsed .collapse-icon{transform:rotate(-90deg);}.collapsible-content{max-height:1000px;overflow:hidden;transition:max-height 0.3s ease-out,opacity 0.3s ease-out;opacity:1;}.collapsible-content.collapsed{max-height:0;opacity:0;}.char-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(40px,1fr));gap:5px;margin-top:10px;}.char-button{padding:8px;background-color:var(--button-bg);border:1px solid var(--border-color);border-radius:4px;cursor:pointer;font-size:16px;text-align:center;transition:all 0.2s;}.char-button:hover{background-color:var(--button-hover);}.char-button.active{background-color:var(--button-active);color:white;border-color:var(--button-active);}.char-button.defined{font-weight:bold;border-width:2px;}#gcode-preview .container{display:flex;height:100%;width:100%;gap:0;}#gcode-preview .left-sidebar{width:400px;flex-shrink:0;display:block !important;order:1;}#gcode-preview .canvas-container{flex:1;position:relative;background-color:var(--canvas-bg);overflow:hidden;order:2;min-width:0;}#gcode-preview .sidebar{width:360px;flex-shrink:0;order:3;}.tooltip-label{position:relative;cursor:help;}.tooltip-label .tooltip-icon{display:inline-block;margin-left:4px;opacity:0.6;}.tooltip-label .tooltip-text{visibility:hidden;opacity:0;position:absolute;z-index:1000;bottom:125%;left:50%;transform:translateX(-50%);background-color:#333333;color:#ffffff;text-align:left;padding:8px 12px;border-radius:6px;font-size:12px;line-height:1.4;white-space:normal;width:250px;box-shadow:0 2px 8px rgba(0,0,0,0.2);transition:opacity 0.2s,visibility 0.2s;pointer-events:none;}:root[data-theme="dark"] .tooltip-label .tooltip-text{background-color:#f5f5f5;color:#333333;}.tooltip-label .tooltip-text::after{content:"";position:absolute;top:100%;left:50%;transform:translateX(-50%);border-width:5px;border-style:solid;border-color:#333333 transparent transparent transparent;}:root[data-theme="dark"] .tooltip-label .tooltip-text::after{border-color:#f5f5f5 transparent transparent transparent;}.tooltip-label:hover .tooltip-text{visibility:visible;opacity:1;}</style></head><body><header><h1>‚úçÔ∏è GCode Font Creator</h1><div class="header-controls"><button id="theme-toggle" style="padding: 8px 16px;">üåì Theme</button></div></header><div class="tab-nav"><button class="tab-button active" data-tab="font-creator">‚úèÔ∏è Font Creator</button><button class="tab-button" data-tab="text-to-gcode">üìù Text To GCode</button><button class="tab-button" data-tab="gcode-preview">üé¨ GCode Preview</button></div><div class="tab-content active" id="font-creator"><div class="font-toolbar" style="display: flex; gap: 10px; padding: 6px 15px; background-color: var(--panel-bg); border-top: 1px solid var(--border-color); border-bottom: 1px solid var(--border-color); align-items: center; flex-wrap: wrap;"><label style="font-weight: 500;">Font:</label><select id="font-selector-editor" style="padding: 8px; border: 1px solid var(--border-color); border-radius: 4px; background: var(--bg-color); color: var(--text-color); width: 250px; margin-top: 0px;"><option value="">Select a font...</option></select><button id="new-font" style="padding: 8px 16px; white-space: nowrap;">‚ú® New</button><button id="save-font" class="primary" style="padding: 8px 16px; white-space: nowrap;">üíæ Save</button><button id="preview-font" style="padding: 8px 16px; white-space: nowrap;">üëÅÔ∏è Preview</button><button id="delete-font" style="padding: 8px 16px; white-space: nowrap; color: #d32f2f;">üóëÔ∏è Delete</button><button id="import-font-btn" style="padding: 8px 16px; white-space: nowrap;">üì• Import</button><button id="export-font" style="padding: 8px 16px; white-space: nowrap;">üì§ Export</button><input type="file" id="import-font" accept=".json" style="display: none;" /></div><div class="main-container"><aside class="left-panel"><div class="section"><h3 class="collapsible-header collapsed" id="font-settings-header">Font Settings <span class="collapse-icon">‚ñº</span></h3><div class="collapsible-content collapsed" id="font-settings-content"><div class="input-group"><label>Font Name</label><input type="text" id="font-name" value="Custom Font" /></div><div class="input-group"><label class="tooltip-label"> Simplification Tolerance <span class="tooltip-icon">‚ÑπÔ∏è</span><span class="tooltip-text">Maximum distance (in pixels) a point can be from the simplified line. Lower values keep more detail, higher values create smoother curves with fewer points.</span></label><input type="number" id="simplify-tolerance" value="2" step="0.5" min="0.5" /></div><div class="input-group"><label class="tooltip-label"> Arc Tolerance (mm) <span class="tooltip-icon">‚ÑπÔ∏è</span><span class="tooltip-text">Maximum deviation (in mm) allowed when converting curves to G-code arcs. Smaller values create more accurate arcs but may generate more arc commands.</span></label><input type="number" id="arc-tolerance" value="0.1" step="0.01" min="0.01" /></div></div></div><div class="section"><h3 class="collapsible-header collapsed" id="char-set-header">Character Set <span class="collapse-icon">‚ñº</span></h3><div id="char-grid" class="char-grid collapsible-content collapsed"></div></div><div class="section"><h3>Current Character</h3><div id="current-char" style="font-size: 48px; text-align: center; padding: 20px;">-</div></div><div class="section"><h3 class="collapsible-header collapsed" id="kerning-header">Kerning Pairs <span class="collapse-icon">‚ñº</span></h3><div class="collapsible-content collapsed" id="kerning-content"><div class="input-group"><label>Character Pair (e.g., AV)</label><input type="text" id="kerning-pair" maxlength="2" placeholder="AV" /></div><div class="input-group"><label>Adjustment (mm)</label><input type="number" id="kerning-value" value="-1" step="0.5" /></div><button id="add-kerning" style="width: 100%; margin-bottom: 10px;">‚ûï Add Kerning</button><div id="kerning-list" style="font-size: 12px; max-height: 150px; overflow-y: auto;"></div></div></div></aside><div class="center-panel"><div class="canvas-container"><canvas id="drawing-canvas" width="600" height="600"></canvas></div><div class="toolbar"><div style="margin-bottom: 10px;"><div class="status" id="status" style="margin-bottom: 5px; font-size: 16px; font-weight: 500;">Draw to create character</div><div style="display: flex; gap: 5px;"><button id="prev-char" style="flex: 1; white-space: nowrap;">‚óÄ Prev</button><button id="next-char" style="flex: 1; white-space: nowrap;">Next ‚ñ∂</button></div></div><div style="display: flex; flex-wrap: wrap; gap: 5px;"><button id="undo" style="flex: 1 1 120px; white-space: nowrap;">‚Ü∂ Undo</button><button id="redo" style="flex: 1 1 120px; white-space: nowrap;">‚Ü∑ Redo</button><button id="clear-char" style="flex: 1 1 120px; white-space: nowrap;">üóëÔ∏è Clear</button><button id="toggle-guides" style="flex: 1 1 120px; white-space: nowrap;">üìè Guides</button></div></div></div></div></div><div id="font-preview-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 10000; align-items: center; justify-content: center;"><div style="background: var(--bg-color); border-radius: 8px; padding: 20px; max-width: 90%; max-height: 90%; overflow: auto; box-shadow: 0 4px 20px rgba(0,0,0,0.3); display: flex; flex-direction: column;"><div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;"><h2 style="margin: 0;">Font Preview</h2><button id="close-preview" style="padding: 8px 16px; cursor: pointer;">‚úï Close</button></div><div style="overflow: auto; flex: 1;"><canvas id="preview-canvas" width="1200" height="1200" style="border: 1px solid var(--border-color); display: block;"></canvas></div></div></div><div class="tab-content" id="text-to-gcode"><div class="main-container" style="justify-content: center;"><div style="max-width: 800px; width: 100%; padding: 20px; overflow-y: auto;"><div class="section"><h3>Font Selection</h3><div class="input-group"><label>Font</label><select id="font-selector" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 4px; background: var(--bg-color); color: var(--text-color);"><option value="">Select a font...</option></select></div></div><div class="section"><h3>Text to Engrave</h3><div class="input-group"><label>Text</label><textarea id="text-input" placeholder="Enter text..." style="min-height: 100px;">HELLO WORLD</textarea></div></div><div class="section"><h3>Output Settings</h3><div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;"><div class="input-group"><label>Output Size (mm)</label><input type="number" id="output-size" value="10" step="0.1" min="0.5" /></div><div class="input-group"><label>Character Spacing (mm)</label><input type="number" id="char-spacing" value="2" step="0.1" min="0" /></div><div class="input-group"><label>Space Width (mm)</label><input type="number" id="space-width" value="3" step="0.1" min="0" /></div><div class="input-group"><label>Line Gap (mm)</label><input type="number" id="line-spacing" value="2" step="0.1" min="0" /></div><div class="input-group"><label>Max Width (mm, 0=none)</label><input type="number" id="max-width" value="0" step="10" min="0" /></div><div class="input-group"><label>Max Height (mm, 0=none)</label><input type="number" id="max-height" value="0" step="10" min="0" /></div><div class="input-group"><label>Max Text Size (mm)</label><input type="number" id="max-text-size" value="100" step="1" min="1" /></div><div class="input-group" style="grid-column: 1 / -1;"><label style="display: flex; align-items: center; cursor: pointer;"><input type="checkbox" id="auto-fit" style="margin-right: 8px;" /> Auto-fit to Max Width/Height (scales output size to maximize within constraints) </label></div><div class="input-group"><label>Feed Rate (mm/min)</label><input type="number" id="feed-rate" value="500" step="50" min="10" /></div><div class="input-group"><label>Plunge Rate (mm/min)</label><input type="number" id="plunge-rate" value="200" step="50" min="10" /></div><div class="input-group"><label>Safe Z (mm)</label><input type="number" id="safe-z" value="5" step="0.5" /></div><div class="input-group"><label>Engrave Depth (mm)</label><input type="number" id="engrave-depth" value="-0.1" step="0.05" /></div></div></div><div class="section"><button id="preview-gcode-btn" class="primary" style="width: 100%; font-size: 16px; padding: 12px;">üé¨ Preview GCode</button></div></div></div></div><div class="tab-content" id="gcode-preview"><div class="container" style="height: 100%;"><aside class="left-sidebar" id="preview-gcode-sidebar"><div class="panel" id="gcode-panel"><h3>GCode <span id="gcode-line-indicator" style="font-size: 12px; opacity: 0.7;"></span></h3><div id="gcode-container"><div id="gcode-content"><div class="gcode-line-numbers" id="gcode-line-numbers"></div><div class="gcode-code" id="gcode-display"></div></div></div></div><div class="panel" id="gcode-welcome" style="display: none;"><div style="margin-top: 0;"><h3>GCode Preview</h3><p style="font-size: 14px; line-height: 1.6; opacity: 0.9;"> Click "Preview GCode" in the "Text To GCode" tab to generate and visualize your toolpath here. </p><p style="font-size: 14px; line-height: 1.6; opacity: 0.9; margin-top: 10px;"> This viewer uses the same rendering engine as the standalone GCode viewer, supporting 2D/3D views, animation, and all advanced features. </p></div><div style="margin-top: 20px;"><h3>Navigation</h3><ul style="font-size: 14px; line-height: 1.8; list-style: circle; padding-left: 20px; opacity: 0.9;"><li><strong>2D View:</strong> Left or right click drag to pan, scroll to zoom</li><li><strong>3D View:</strong> Left click and drag to rotate, right click and drag to pan, scroll to zoom</li><li><strong>Mobile:</strong> One finger drag to rotate, two finger drag to pan, pinch to zoom</li><li><strong>Reset:</strong> Click "Reset View" to re-center</li></ul></div></div></aside><div class="canvas-container"><div class="canvas-overlay-controls"><button id="btn-toggle-view">3D View</button><button id="btn-reset-view" disabled>Reset View</button></div><canvas id="canvas2d"></canvas><canvas id="canvas3d" class="hidden"></canvas><canvas id="canvas3d-overlay" class="hidden"></canvas></div><aside class="sidebar" id="preview-sidebar"><div class="panel"><h3>Export</h3><button id="download-gcode" style="width: 100%; font-size: 14px; padding: 10px; margin-bottom: 8px;">üíæ Download GCode</button><button id="export-image" style="width: 100%; font-size: 14px; padding: 10px;">üñºÔ∏è Export Image</button></div><div class="panel"><h3>Statistics</h3><div class="stats-grid"><div class="stat-item"><div class="stat-label">Segments</div><div class="stat-value" id="stat-lines">-</div></div><div class="stat-item"><div class="stat-label">Est. Time</div><div class="stat-value" id="stat-time">-</div></div><div class="stat-item"><div class="stat-label">X Range</div><div class="stat-value" id="stat-x">-</div></div><div class="stat-item"><div class="stat-label">Y Range</div><div class="stat-value" id="stat-y">-</div></div><div class="stat-item"><div class="stat-label">Z Range</div><div class="stat-value" id="stat-z">-</div></div></div></div><div class="panel" id="tool-panel" style="display: none;"><h3>Tools</h3><div id="tool-list" style="max-height: 400px; overflow-y: auto;"></div></div><div class="panel" id="rapid-moves-panel" style="display: none;"><h3>Rapid Moves (G0)</h3><div style="display: flex; align-items: center; gap: 8px; padding: 8px; background: var(--canvas-bg); border-radius: 4px;"><input type="checkbox" id="rapid-moves-visible" checked><input type="color" id="rapid-move-color" value="#999999" style="width: 32px; height: 24px; border: none; cursor: pointer;"><label for="rapid-moves-visible" style="flex: 1; font-size: 13px; cursor: pointer;">Show Travel Moves</label></div></div><div class="panel"><h3>View Controls</h3><div class="layer-controls"><div style="margin-bottom: 10px;"><label style="font-size: 12px; display: block; margin-bottom: 5px;">Zoom</label><input type="range" id="zoom-slider" min="0.1" max="10" step="0.1" value="1" style="width: 100%;"><div style="text-align: center; font-size: 11px; margin-top: 5px;"><span id="zoom-value">100%</span></div></div></div></div><div class="panel" id="animation-panel" style="display: none;"><h3>Animation</h3><div class="animation-controls"><div class="controls-row"><button id="btn-play">Play</button><button id="btn-reset">Reset</button></div><div class="controls-row"><button id="btn-prev">‚óÄ Prev</button><button id="btn-next">Next ‚ñ∂</button></div><div><label>Speed: <span id="speed-label">1x</span></label><input type="range" id="speed-slider" min="-10" max="10" value="0" step="1"></div><div style="margin-top: 10px;"><label style="font-size: 12px; display: block; margin-bottom: 5px;">Segment: <span id="current-line">0</span> / <span id="total-lines">0</span></label><div style="font-size: 11px; opacity: 0.7; margin-bottom: 5px;">File Line: <span id="current-file-line">-</span></div><input type="range" id="line-slider" min="0" max="0" step="1" value="0" style="width: 100%;"></div></div></div><div class="panel"><h3>Layer Filter</h3><div class="layer-controls"><div class="layer-inputs"><div><label style="font-size: 12px;">Min Z</label><input type="number" id="layer-min" step="0.1" placeholder="Auto"></div><div><label style="font-size: 12px;">Max Z</label><input type="number" id="layer-max" step="0.1" placeholder="Auto"></div></div></div></div><div class="panel"><h3>3D Grid</h3><div class="layer-controls"><div style="margin-bottom: 10px;"><label style="display: flex; align-items: center; gap: 8px;"><input type="checkbox" id="grid-enabled" checked><span>Show Grid</span></label></div><div class="layer-inputs"><div><label style="font-size: 12px;">Width (X)</label><input type="number" id="grid-width" step="10" value="200" min="0"></div><div><label style="font-size: 12px;">Height (Y)</label><input type="number" id="grid-height" step="10" value="200" min="0"></div></div></div></div><div class="privacy-notice"> üîí All processing happens locally in your browser.<br>No data is transmitted. </div></aside></div></div><script>class GCodeParser{constructor(){this.reset()}reset(){this.position={x:0,y:0,z:0},this.units="mm",this.absolute=!0,this.plane="XY",this.feedRate=0,this.currentTool=1,this.toolNames=[],this.toolColors=[],this.parsingToolList=!1,this.inlineToolMap=new Map,this.inlineToolOccurrence=new Map,this.lastToolChangeType=null,this.segments=[],this.bounds={minX:1/0,maxX:-1/0,minY:1/0,maxY:-1/0,minZ:1/0,maxZ:-1/0}}async parseString(t,e){this.reset();const s=t.split("\n"),n=s.length;for(let t=0;t<n;t++)this.parseLine(s[t].trim(),t+1),e&&t%1e3==0&&e(Math.min(100,(t+1)/n*100));return e&&e(100),this.segments}async parseFile(t,e){this.reset();const s=await t.text();return this.parseString(s,e)}readChunk(t,e,s){return new Promise((n,i)=>{const o=new FileReader,a=t.slice(e,e+s);o.onload=t=>n(t.target.result),o.onerror=i,o.readAsText(a)})}parseLine(t,e){if(t.startsWith(";")||t.startsWith("(")){const e=t.replace(/^[;(]/,"").replace(/\)$/,"").trim(),s=e.match(/^Tool\s+(\d+)\s*:\s*(.+)$/i);if(s){0===this.toolNames.length&&(this.toolNames.push("No Tool"),this.toolColors.push(null),this.currentTool=0);const t=parseInt(s[1]),e=s[2].trim(),n=e.match(/#([0-9A-Fa-f]{6})\b/),i=n?e.replace(/#[0-9A-Fa-f]{6}\b/,"").trim():e,o=n?"#"+n[1]:null;this.inlineToolMap.has(t)||this.inlineToolMap.set(t,[]);const a=this.inlineToolMap.get(t),r=this.toolNames.length;return a.push(r),1===a.length?this.toolNames.push(`Tool ${t}: ${i}`):this.toolNames.push(`Tool ${t}: ${i} (${a.length})`),void this.toolColors.push(o)}if(/required tools?:/i.test(e))return void(this.parsingToolList=!0);if(this.parsingToolList){if(!e||0===e.length)return void(this.parsingToolList=!1);if(e.length>0&&!e.toLowerCase().includes("required")){const t=e.match(/#([0-9A-Fa-f]{6})\b/);if(t){this.toolColors.push("#"+t[1]);const s=e.replace(/#[0-9A-Fa-f]{6}\b/,"").trim();this.toolNames.push(s)}else this.toolColors.push(null),this.toolNames.push(e)}return}return}if(!t||t.startsWith("%"))return;const s=t,n=/M0\b/i.test(t),i=s.match(/[;(](.*)$/),o=i?i[1].toLowerCase():"";if(n&&o.includes("tool")&&(this.currentTool++,this.lastToolChangeType="M0"),!(t=t.replace(/\(.*?\)/g,"").replace(/;.*$/,"").trim()))return;const a=this.extractWords(t);if(0===a.length)return;let r=!1;for(const[t,s]of a)switch(t){case"G":r=this.processGCode(Math.floor(s),a,e)||r;break;case"M":this.processMCode(Math.floor(s),a,e);break;case"T":const t=Math.floor(s);if(this.inlineToolMap.size>0&&this.inlineToolMap.has(t)){const e=this.inlineToolMap.get(t),s=this.inlineToolOccurrence.get(t)||0,n=Math.min(s,e.length-1);this.currentTool=e[n],this.inlineToolOccurrence.set(t,s+1)}else this.currentTool=t;break;case"F":this.feedRate=s}}extractWords(t){const e=[],s=/([A-Z])([+-]?\d+\.?\d*)/gi;let n;for(;null!==(n=s.exec(t));)e.push([n[1].toUpperCase(),parseFloat(n[2])]);return e}processMCode(t,e,s){6===t&&(this.lastToolChangeType="M6")}processGCode(t,e,s){switch(t){case 0:return this.linearMove(e,"rapid",s);case 1:return this.linearMove(e,"cut",s);case 2:return this.arcMove(e,"cw",s);case 3:return this.arcMove(e,"ccw",s);case 17:return this.plane="XY",!1;case 18:return this.plane="ZX",!1;case 19:return this.plane="YZ",!1;case 20:return this.units="inches",!1;case 21:return this.units="mm",!1;case 90:return this.absolute=!0,!1;case 91:return this.absolute=!1,!1;default:return!1}}linearMove(t,e,s){const n=this.extractTarget(t);return(n.x!==this.position.x||n.y!==this.position.y||n.z!==this.position.z)&&(this.addSegment({type:e,start:{...this.position},end:{...n},feedRate:this.feedRate,tool:this.currentTool,toolChangeType:this.lastToolChangeType,lineNum:s}),this.lastToolChangeType=null,this.position=n,this.updateBounds(n),!0)}arcMove(t,e,s){const n=this.extractTarget(t),i=this.extractOffset(t);if(!i)return console.error(`Arc command at line ${s} missing I/J/K parameters`),!1;const o=this.tessellateArc(this.position,n,i,"cw"===e);for(const t of o)this.addSegment({type:"cut",start:t.start,end:t.end,feedRate:this.feedRate,tool:this.currentTool,lineNum:s}),this.updateBounds(t.end);return this.position=n,o.length>0}extractTarget(t){const e={...this.position};for(const[s,n]of t){const t=this.absolute?n:this.position[s.toLowerCase()]+n;switch(s){case"X":e.x=t;break;case"Y":e.y=t;break;case"Z":e.z=t}}return e}extractOffset(t){let e=null;for(const[s,n]of t)"I"!==s&&"J"!==s&&"K"!==s||(e||(e={i:0,j:0,k:0}),e[s.toLowerCase()]=n);return e}tessellateArc(t,e,s,n){let i,o,a,r,h,l;"XY"===this.plane?(i=t.x+s.i,o=t.y+s.j,a=t.x,r=t.y,h=e.x,l=e.y):"ZX"===this.plane?(i=t.z+s.k,o=t.x+s.i,a=t.z,r=t.x,h=e.z,l=e.x):(i=t.y+s.j,o=t.z+s.k,a=t.y,r=t.z,h=e.y,l=e.z);const c=Math.sqrt(Math.pow(a-i,2)+Math.pow(r-o,2)),d=Math.atan2(r-o,a-i);let u=Math.atan2(l-o,h-i)-d;n?u>=0&&(u-=2*Math.PI):u<=0&&(u+=2*Math.PI);const m=Math.max(8,Math.min(64,Math.floor(Math.sqrt(c)*Math.abs(u)*4))),g=[];let x={...t};for(let s=1;s<=m;s++){const n=s/m,a=d+u*n,r={...t};"XY"===this.plane?(r.x=i+c*Math.cos(a),r.y=o+c*Math.sin(a),r.z=t.z+(e.z-t.z)*n):"ZX"===this.plane?(r.z=i+c*Math.cos(a),r.x=o+c*Math.sin(a),r.y=t.y+(e.y-t.y)*n):(r.y=i+c*Math.cos(a),r.z=o+c*Math.sin(a),r.x=t.x+(e.x-t.x)*n),g.push({start:x,end:r}),x=r}return g}addSegment(t){this.segments.push(t)}updateBounds(t){isNaN(t.x)||isNaN(t.y)||isNaN(t.z)?console.error("Invalid point in updateBounds:",t):(this.bounds.minX=Math.min(this.bounds.minX,t.x),this.bounds.maxX=Math.max(this.bounds.maxX,t.x),this.bounds.minY=Math.min(this.bounds.minY,t.y),this.bounds.maxY=Math.max(this.bounds.maxY,t.y),this.bounds.minZ=Math.min(this.bounds.minZ,t.z),this.bounds.maxZ=Math.max(this.bounds.maxZ,t.z))}getBounds(){return this.bounds}getSegments(){return this.segments}getToolNames(){return this.toolNames}getToolColors(){return this.toolColors}get usingInlineToolFormat(){return this.inlineToolMap.size>0}}class Camera{constructor(){this.position={x:0,y:0,z:100},this.target={x:0,y:0,z:0},this.rotation={x:0,y:0,z:0,w:1},this.zoom=1,this.orthoScale=100,this.targetPosition={...this.position},this.targetTarget={...this.target},this.targetRotation={...this.rotation},this.targetZoom=this.zoom,this.pan2d={x:0,y:0},this.zoom2d=1,this.targetPan2d={...this.pan2d},this.targetZoom2d=this.zoom2d,this.initialZoom2d=1,this.initialOrthoScale=100}fitToBounds(t,e=.1,s=800,n=600){const i=(t.minX+t.maxX)/2,o=(t.minY+t.maxY)/2,a=(t.minZ+t.maxZ)/2;this.target={x:i,y:o,z:a},this.targetTarget={x:i,y:o,z:a};const r=t.maxX-t.minX,h=t.maxY-t.minY,l=t.maxZ-t.minZ,c=Math.max(r,h,l)||100;this.orthoScale=c*(.6+e/2);const d=s>0?s:800,u=n>0?n:600,m=d/Math.max(r*(1+.5*e),1),g=u/Math.max(h*(1+.5*e),1),x=Math.min(m,g);console.log("Camera fitToBounds:",{bounds:{width:r,height:h},canvas:{width:d,height:u},center:{x:i,y:o},scales:{x:m,y:g,chosen:x}}),this.pan2d={x:i,y:o},this.zoom2d=x,this.targetPan2d={...this.pan2d},this.targetZoom2d=this.zoom2d,this.initialZoom2d=x,this.initialOrthoScale=this.orthoScale,this.position={x:i+2*c,y:o,z:a},this.targetPosition={x:i,y:o,z:a+2*c},this.rotation={x:0,y:0,z:0,w:1},this.targetRotation={x:0,y:0,z:0,w:1}}update(t=16){const e=.15;this.pan2d.x+=(this.targetPan2d.x-this.pan2d.x)*e,this.pan2d.y+=(this.targetPan2d.y-this.pan2d.y)*e,this.zoom2d+=(this.targetZoom2d-this.zoom2d)*e,this.position.x+=(this.targetPosition.x-this.position.x)*e,this.position.y+=(this.targetPosition.y-this.position.y)*e,this.position.z+=(this.targetPosition.z-this.position.z)*e,this.target.x+=(this.targetTarget.x-this.target.x)*e,this.target.y+=(this.targetTarget.y-this.target.y)*e,this.target.z+=(this.targetTarget.z-this.target.z)*e,this.rotation=this.slerpQuaternion(this.rotation,this.targetRotation,e),this.zoom+=(this.targetZoom-this.zoom)*e}pan2D(t,e){this.targetPan2d.x-=t/this.zoom2d,this.targetPan2d.y+=e/this.zoom2d}zoom2D(t,e,s,n,i,o=!1){const a=1-t*(o?.015:.001),r=this.get2DTransform(n,i),h=(e-r.translateX)/r.scale,l=(s-r.translateY)/r.scale;this.targetZoom2d,this.targetZoom2d*=a;const c=.1*this.initialZoom2d,d=10*this.initialZoom2d;this.targetZoom2d=Math.max(c,Math.min(d,this.targetZoom2d));const u=e-h*this.targetZoom2d,m=s-l*this.targetZoom2d;this.targetPan2d.x=(n/2-u)/this.targetZoom2d,this.targetPan2d.y=-(i/2-m)/this.targetZoom2d}rotate(t,e){const s=this.position,n=this.target,i={x:n.x-s.x,y:n.y-s.y,z:n.z-s.z},o=Math.sqrt(i.x*i.x+i.y*i.y+i.z*i.z);i.x/=o,i.y/=o,i.z/=o;const a={x:1*i.z-0*i.y,y:0*i.x-0*i.z,z:0*i.y-1*i.x},r=Math.sqrt(a.x*a.x+a.y*a.y+a.z*a.z);a.x/=r,a.y/=r,a.z/=r;const h=i.y*a.z-i.z*a.y,l=i.z*a.x-i.x*a.z,c=i.x*a.y-i.y*a.x,d=s.x-n.x,u=s.y-n.y,m=s.z-n.z,g=.01*-t,x=Math.cos(g),p=Math.sin(g);let f=d*(x+h*h*(1-x))+u*(h*l*(1-x)-c*p)+m*(h*c*(1-x)+l*p),y=d*(l*h*(1-x)+c*p)+u*(x+l*l*(1-x))+m*(l*c*(1-x)-h*p),v=d*(c*h*(1-x)-l*p)+u*(c*l*(1-x)+h*p)+m*(x+c*c*(1-x));const b=.01*e,C=Math.cos(b),E=Math.sin(b),I=f*(C+a.x*a.x*(1-C))+y*(a.x*a.y*(1-C)-a.z*E)+v*(a.x*a.z*(1-C)+a.y*E),S=f*(a.y*a.x*(1-C)+a.z*E)+y*(C+a.y*a.y*(1-C))+v*(a.y*a.z*(1-C)-a.x*E),M=f*(a.z*a.x*(1-C)-a.y*E)+y*(a.z*a.y*(1-C)+a.x*E)+v*(C+a.z*a.z*(1-C)),w=S/Math.sqrt(I*I+S*S+M*M),T=Math.asin(-w),F=Math.PI/2-.09;Math.abs(T)>F?(this.targetPosition.x=n.x+f,this.targetPosition.y=n.y+y,this.targetPosition.z=n.z+v):(this.targetPosition.x=n.x+I,this.targetPosition.y=n.y+S,this.targetPosition.z=n.z+M)}pan3D(t,e){const s=.002*this.orthoScale,n=this.position,i=this.target,o={x:i.x-n.x,y:i.y-n.y,z:i.z-n.z},a=Math.sqrt(o.x*o.x+o.y*o.y+o.z*o.z);o.x/=a,o.y/=a,o.z/=a;const r={x:1*o.z-0*o.y,y:0*o.x-0*o.z,z:0*o.y-1*o.x},h=Math.sqrt(r.x*r.x+r.y*r.y+r.z*r.z);r.x/=h,r.y/=h,r.z/=h;const l={x:o.y*r.z-o.z*r.y,y:o.z*r.x-o.x*r.z,z:o.x*r.y-o.y*r.x},c=Math.sqrt(l.x*l.x+l.y*l.y+l.z*l.z);l.x/=c,l.y/=c,l.z/=c,this.targetPosition.x+=t*s*r.x+e*s*l.x,this.targetPosition.y+=t*s*r.y+e*s*l.y,this.targetPosition.z+=t*s*r.z+e*s*l.z,this.targetTarget.x+=t*s*r.x+e*s*l.x,this.targetTarget.y+=t*s*r.y+e*s*l.y,this.targetTarget.z+=t*s*r.z+e*s*l.z}zoom3D(t){const e=t*(Math.abs(t)>10?.001:1);this.orthoScale*=1+e;const s=.1*this.initialOrthoScale,n=10*this.initialOrthoScale;this.orthoScale=Math.max(s,Math.min(n,this.orthoScale))}get2DTransform(t,e){return{translateX:t/2-this.pan2d.x*this.zoom2d,translateY:e/2+this.pan2d.y*this.zoom2d,scale:this.zoom2d}}getProjectionMatrix(t){const e=this.orthoScale,s=-e*t,n=e*t,i=-e,o=n-s,a=e-i;return[2/o,0,0,0,0,2/a,0,0,0,0,-1e-4,0,-(n+s)/o,-(e+i)/a,-0,1]}getViewMatrix(){const t=this.position,e=this.target,s={x:t.x-e.x,y:t.y-e.y,z:t.z-e.z},n=Math.sqrt(s.x*s.x+s.y*s.y+s.z*s.z);s.x/=n,s.y/=n,s.z/=n;const i={x:1*s.z-0*s.y,y:0*s.x-0*s.z,z:0*s.y-1*s.x},o=Math.sqrt(i.x*i.x+i.y*i.y+i.z*i.z);i.x/=o,i.y/=o,i.z/=o;const a={x:s.y*i.z-s.z*i.y,y:s.z*i.x-s.x*i.z,z:s.x*i.y-s.y*i.x};return[i.x,a.x,s.x,0,i.y,a.y,s.y,0,i.z,a.z,s.z,0,-(i.x*t.x+i.y*t.y+i.z*t.z),-(a.x*t.x+a.y*t.y+a.z*t.z),-(s.x*t.x+s.y*t.y+s.z*t.z),1]}axisAngleToQuaternion(t,e){const s=e/2,n=Math.sin(s);return{x:t.x*n,y:t.y*n,z:t.z*n,w:Math.cos(s)}}multiplyQuaternion(t,e){return{x:t.w*e.x+t.x*e.w+t.y*e.z-t.z*e.y,y:t.w*e.y-t.x*e.z+t.y*e.w+t.z*e.x,z:t.w*e.z+t.x*e.y-t.y*e.x+t.z*e.w,w:t.w*e.w-t.x*e.x-t.y*e.y-t.z*e.z}}normalizeQuaternion(t){const e=Math.sqrt(t.x*t.x+t.y*t.y+t.z*t.z+t.w*t.w);return{x:t.x/e,y:t.y/e,z:t.z/e,w:t.w/e}}slerpQuaternion(t,e,s){let n=t.x*e.x+t.y*e.y+t.z*e.z+t.w*e.w;if(n<0&&(e={x:-e.x,y:-e.y,z:-e.z,w:-e.w},n=-n),n>.9995)return this.normalizeQuaternion({x:t.x+s*(e.x-t.x),y:t.y+s*(e.y-t.y),z:t.z+s*(e.z-t.z),w:t.w+s*(e.w-t.w)});const i=Math.acos(n),o=Math.sin(i),a=Math.sin((1-s)*i)/o,r=Math.sin(s*i)/o;return{x:t.x*a+e.x*r,y:t.y*a+e.y*r,z:t.z*a+e.z*r,w:t.w*a+e.w*r}}quaternionToMatrix(t){const e=t.x*t.x,s=t.y*t.y,n=t.z*t.z,i=t.x*t.y,o=t.x*t.z,a=t.y*t.z,r=t.w*t.x,h=t.w*t.y,l=t.w*t.z;return[1-2*(s+n),2*(i-l),2*(o+h),0,2*(i+l),1-2*(e+n),2*(a-r),0,2*(o-h),2*(a+r),1-2*(e+s),0,0,0,0,1]}multiplyMatrices(t,e){const s=new Array(16);for(let n=0;n<4;n++)for(let i=0;i<4;i++)s[4*n+i]=t[0+i]*e[4*n+0]+t[4+i]*e[4*n+1]+t[8+i]*e[4*n+2]+t[12+i]*e[4*n+3];return s}getMVPMatrix(t){const e=this.getProjectionMatrix(t),s=this.getViewMatrix();return this.multiplyMatrices(e,s)}}class Renderer2D{constructor(t,e){this.canvas=t,this.ctx=t.getContext("2d"),this.camera=e,this.segments=[],this.bounds=null,this.layerFilter={min:-1/0,max:1/0},this.hoveredPoint=null,this.maxSegmentIndex=1/0,this.toolStates=new Map,this.rapidMovesVisible=!0,this.rapidMoveColor="#999999",this.resizeCanvas()}resizeCanvas(){const t=this.canvas.getBoundingClientRect();this.canvas.width=t.width,this.canvas.height=t.height}setSegments(t,e){this.segments=t,this.bounds=e,this.maxSegmentIndex=t.length}setToolStates(t){this.toolStates=t}setRapidMoveSettings(t,e){this.rapidMovesVisible=t,this.rapidMoveColor=e}updateBuffers(){}setLayerFilter(t,e){this.layerFilter.min=t,this.layerFilter.max=e}setMaxSegmentIndex(t,e=1){this.maxSegmentIndex=t,this.segmentProgress=e}render(){if(this.resizeCanvas(),this.clear(),0===this.segments.length)return void this.drawWelcomeMessage();const t=this.camera.get2DTransform(this.canvas.width,this.canvas.height);this.ctx.save(),this.ctx.translate(t.translateX,t.translateY),this.ctx.scale(t.scale,-t.scale),this.drawGrid(t),this.drawSegments(),this.drawCurrentPositionMarker(),this.ctx.restore(),this.drawGridLabels(t),this.drawCoordinateAxes()}clear(){const t=document.documentElement.getAttribute("data-theme");this.ctx.fillStyle="dark"===t?"#252525":"#fafafa",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height)}drawWelcomeMessage(){this.ctx.save(),this.ctx.fillStyle=getComputedStyle(document.documentElement).getPropertyValue("--text-color"),this.ctx.font="16px sans-serif",this.ctx.textAlign="center",this.ctx.fillText("Load a GCode file to visualize",this.canvas.width/2,this.canvas.height/2),this.ctx.restore()}drawGrid(t){const e=document.documentElement.getAttribute("data-theme"),s="dark"===e?"#3a3a3a":"#e0e0e0",n=t.scale;let i=10;n<.5?i=100:n<2?i=50:n>10?i=1:n>5&&(i=5);const o=-t.translateX/n,a=(this.canvas.width-t.translateX)/n,r=t.translateY/n,h=(t.translateY-this.canvas.height)/n;this.ctx.strokeStyle=s,this.ctx.lineWidth=1/n;const l=Math.floor(o/i)*i,c=Math.ceil(a/i)*i;for(let t=l;t<=c;t+=i)this.ctx.beginPath(),this.ctx.moveTo(t,h),this.ctx.lineTo(t,r),this.ctx.stroke();const d=Math.floor(h/i)*i,u=Math.ceil(r/i)*i;for(let t=d;t<=u;t+=i)this.ctx.beginPath(),this.ctx.moveTo(o,t),this.ctx.lineTo(a,t),this.ctx.stroke();this.ctx.strokeStyle="dark"===e?"#666666":"#999999",this.ctx.lineWidth=2/n,this.ctx.beginPath(),this.ctx.moveTo(0,h),this.ctx.lineTo(0,r),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.moveTo(o,0),this.ctx.lineTo(a,0),this.ctx.stroke()}drawSegments(){const t=document.documentElement.getAttribute("data-theme"),e=["dark"===t?"#00ccff":"#0066cc","dark"===t?"#00ff88":"#00cc66","dark"===t?"#ff4dff":"#cc00cc","dark"===t?"#ffff00":"#cccc00","dark"===t?"#ff8800":"#ff6600","dark"===t?"#8888ff":"#4d4dff","dark"===t?"#ff0088":"#ff0066","dark"===t?"#00ffff":"#00b3b3"],s=this.camera.zoom2d,n=Math.max(.5,1.5/s),i=[],o={};let a=null;for(let t=0;t<Math.min(this.segments.length,this.maxSegmentIndex);t++){const e=this.segments[t];if(!(e.start.z<this.layerFilter.min||e.start.z>this.layerFilter.max))if("rapid"===e.type)this.rapidMovesVisible&&i.push(e);else{const t=e.tool||0;if(this.toolStates.has(t)&&!this.toolStates.get(t).visible)continue;o[t]||(o[t]=[]),o[t].push(e)}}if(this.maxSegmentIndex<this.segments.length&&this.segmentProgress>0&&this.segmentProgress<1){const t=this.segments[this.maxSegmentIndex];if("cut"===t.type&&t.start.z>=this.layerFilter.min&&t.start.z<=this.layerFilter.max){const e=t.tool||0;this.toolStates.has(e)&&!this.toolStates.get(e).visible||(a={seg:t,tool:e})}}this.rapidMovesVisible&&i.length>0&&(this.ctx.strokeStyle=this.rapidMoveColor,this.ctx.lineWidth=.7*n,this.ctx.setLineDash([5/s,5/s]),this.drawSegmentBatch(i)),this.ctx.lineWidth=n,this.ctx.setLineDash([]);for(const t in o){const s=parseInt(t);if(this.toolStates.has(s))this.ctx.strokeStyle=this.toolStates.get(s).color;else{const t=s%e.length;this.ctx.strokeStyle=e[t]}this.drawSegmentBatch(o[t])}if(a){const{seg:t,tool:s}=a;if(this.toolStates.has(s))this.ctx.strokeStyle=this.toolStates.get(s).color;else{const t=s%e.length;this.ctx.strokeStyle=e[t]}const n=t.start.x+(t.end.x-t.start.x)*this.segmentProgress,i=t.start.y+(t.end.y-t.start.y)*this.segmentProgress;t.start.z,t.end.z,t.start.z,this.segmentProgress,this.ctx.beginPath(),this.ctx.moveTo(t.start.x,t.start.y),this.ctx.lineTo(n,i),this.ctx.stroke()}}drawSegmentBatch(t){if(0!==t.length){this.ctx.beginPath();for(const e of t)this.ctx.moveTo(e.start.x,e.start.y),this.ctx.lineTo(e.end.x,e.end.y);this.ctx.stroke()}}drawCurrentPositionMarker(){if(this.maxSegmentIndex>=this.segments.length||this.maxSegmentIndex===1/0)return;const t=this.segments[this.maxSegmentIndex];if(!t)return;const e=this.segmentProgress,s={x:t.start.x+(t.end.x-t.start.x)*e,y:t.start.y+(t.end.y-t.start.y)*e,z:t.start.z+(t.end.z-t.start.z)*e},n=this.camera.zoom2d,i=5/n;this.ctx.save(),this.ctx.fillStyle="#ff0000",this.ctx.strokeStyle="#ffffff",this.ctx.lineWidth=2/n,this.ctx.beginPath(),this.ctx.arc(s.x,s.y,i,0,2*Math.PI),this.ctx.fill(),this.ctx.stroke(),this.ctx.restore()}drawGridLabels(t){const e=document.documentElement.getAttribute("data-theme"),s=t.scale;let n=10;s<.5?n=100:s<2?n=50:s>10?n=1:s>5&&(n=5);const i=Math.max(n,10),o=-t.translateX/s,a=(this.canvas.width-t.translateX)/s,r=t.translateY/s,h=(t.translateY-this.canvas.height)/s;this.ctx.save(),this.ctx.fillStyle="dark"===e?"#aaa":"#555",this.ctx.font="11px monospace",this.ctx.textAlign="center",this.ctx.textBaseline="middle";const l=e=>t.translateX+e*s,c=e=>t.translateY-e*s,d=Math.floor(o/i)*i,u=Math.ceil(a/i)*i;for(let t=d;t<=u;t+=i){const e=l(t),s=c(0);let n=s+15;s<0?n=15:s>this.canvas.height&&(n=this.canvas.height-5),e>=0&&e<=this.canvas.width&&this.ctx.fillText(t.toString(),e,n)}const m=Math.floor(h/i)*i,g=Math.ceil(r/i)*i;this.ctx.textAlign="right";for(let t=m;t<=g;t+=i){const e=l(0),s=c(t);let n=e-10;e<0?n=50:e>this.canvas.width&&(n=this.canvas.width-10),s>=0&&s<=this.canvas.height&&this.ctx.fillText(t.toString(),n,s)}this.ctx.restore()}drawCoordinateAxes(){const t=this.canvas.height-20-40;this.ctx.save(),this.ctx.translate(60,t),this.ctx.strokeStyle="#ff0000",this.ctx.lineWidth=2,this.ctx.beginPath(),this.ctx.moveTo(0,0),this.ctx.lineTo(40,0),this.ctx.stroke(),this.ctx.fillStyle="#ff0000",this.ctx.font="12px sans-serif",this.ctx.fillText("X",45,5),this.ctx.strokeStyle="#00ff00",this.ctx.beginPath(),this.ctx.moveTo(0,0),this.ctx.lineTo(0,-40),this.ctx.stroke(),this.ctx.fillStyle="#00ff00",this.ctx.fillText("Y",5,-45),this.ctx.restore()}canvasToWorld(t,e){const s=this.camera.get2DTransform(this.canvas.width,this.canvas.height);return{x:(t-s.translateX)/s.scale,y:-(e-s.translateY)/s.scale}}findNearestPoint(t,e,s=10){const n=this.canvasToWorld(t,e);let i=null,o=s/this.camera.zoom2d;for(let t=0;t<Math.min(this.segments.length,this.maxSegmentIndex);t++){const e=this.segments[t],s=Math.sqrt(Math.pow(e.start.x-n.x,2)+Math.pow(e.start.y-n.y,2));s<o&&(o=s,i={...e.start,lineNum:e.lineNum});const a=Math.sqrt(Math.pow(e.end.x-n.x,2)+Math.pow(e.end.y-n.y,2));a<o&&(o=a,i={...e.end,lineNum:e.lineNum})}return i}}class Renderer3D{constructor(t,e,s){this.canvas=t,this.camera=e,this.overlayCanvas=s,this.overlayCtx=s?s.getContext("2d"):null,this.gl=null,this.program=null,this.buffers={},this.segments=[],this.bounds=null,this.layerFilter={min:-1/0,max:1/0},this.maxSegmentIndex=1/0,this.toolStates=new Map,this.rapidMovesVisible=!0,this.rapidMoveColor="#999999",this.initWebGL(),this.resizeCanvas()}initWebGL(){if(this.gl=this.canvas.getContext("webgl",{alpha:!1,antialias:!0,preserveDrawingBuffer:!0})||this.canvas.getContext("experimental-webgl"),!this.gl)return void console.error("WebGL not supported");console.log("WebGL context created successfully");const t=this.gl,e=this.compileShader(t.VERTEX_SHADER,"\n attribute vec3 aPosition;\n attribute vec3 aColor;\n uniform mat4 uMVP;\n varying vec3 vColor;\n \n void main() {\n gl_Position = uMVP * vec4(aPosition, 1.0);\n gl_PointSize = 10.0;\n vColor = aColor;\n }\n "),s=this.compileShader(t.FRAGMENT_SHADER,"\n precision mediump float;\n varying vec3 vColor;\n \n void main() {\n gl_FragColor = vec4(vColor, 1.0);\n }\n ");this.program=t.createProgram(),t.attachShader(this.program,e),t.attachShader(this.program,s),t.linkProgram(this.program),t.getProgramParameter(this.program,t.LINK_STATUS)?(console.log("Shader program linked successfully"),this.locations={aPosition:t.getAttribLocation(this.program,"aPosition"),aColor:t.getAttribLocation(this.program,"aColor"),uMVP:t.getUniformLocation(this.program,"uMVP")},t.enable(t.DEPTH_TEST),t.depthFunc(t.LEQUAL),this.buffers.position=t.createBuffer(),this.buffers.color=t.createBuffer()):console.error("Program link error:",t.getProgramInfoLog(this.program))}compileShader(t,e){const s=this.gl,n=s.createShader(t);return s.shaderSource(n,e),s.compileShader(n),s.getShaderParameter(n,s.COMPILE_STATUS)?n:(console.error("Shader compile error:",s.getShaderInfoLog(n)),s.deleteShader(n),null)}resizeCanvas(){const t=this.canvas.getBoundingClientRect();this.canvas.width=t.width,this.canvas.height=t.height,this.overlayCanvas&&(this.overlayCanvas.width=t.width,this.overlayCanvas.height=t.height),this.gl&&this.gl.viewport(0,0,this.canvas.width,this.canvas.height)}setSegments(t,e){this.segments=t,this.bounds=e,this.maxSegmentIndex=t.length,this.updateBuffers()}setToolStates(t){this.toolStates=t}setRapidMoveSettings(t,e){this.rapidMovesVisible=t,this.rapidMoveColor=e}setLayerFilter(t,e){this.layerFilter.min=t,this.layerFilter.max=e,this.updateBuffers()}setMaxSegmentIndex(t,e=1){this.maxSegmentIndex=t,this.segmentProgress=e,this.updateBuffers()}updateBuffers(){if(!this.gl||0===this.segments.length)return;const t=this.gl,e=document.documentElement.getAttribute("data-theme"),s=this.hexToRgb(this.rapidMoveColor),n=["dark"===e?[0,.8,1]:[0,.4,.8],"dark"===e?[0,1,.5]:[0,.8,.4],"dark"===e?[1,.3,1]:[.8,0,.8],"dark"===e?[1,1,0]:[.8,.8,0],"dark"===e?[1,.5,0]:[1,.4,0],"dark"===e?[.5,.5,1]:[.3,.3,1],"dark"===e?[1,0,.5]:[1,0,.4],"dark"===e?[0,1,1]:[0,.7,.7]],i=[],o=[];for(let t=0;t<Math.min(this.segments.length,this.maxSegmentIndex);t++){const e=this.segments[t];if(e.start.z<this.layerFilter.min||e.start.z>this.layerFilter.max)continue;if("rapid"===e.type&&!this.rapidMovesVisible)continue;const a=e.tool||0;if("rapid"!==e.type&&this.toolStates.has(a)&&!this.toolStates.get(a).visible)continue;let r;if("rapid"===e.type)r=s;else if(this.toolStates.has(a)){const t=this.toolStates.get(a).color;r=this.hexToRgb(t)}else r=n[a%n.length];i.push(e.start.x,e.start.y,e.start.z),o.push(...r),i.push(e.end.x,e.end.y,e.end.z),o.push(...r)}if(this.maxSegmentIndex<this.segments.length&&this.segmentProgress>0&&this.segmentProgress<1){const t=this.segments[this.maxSegmentIndex];if(t.start.z>=this.layerFilter.min&&t.start.z<=this.layerFilter.max&&("rapid"!==t.type||this.rapidMovesVisible)){const e=t.tool||0;let a=!0;if("rapid"!==t.type&&this.toolStates.has(e)&&(a=this.toolStates.get(e).visible),a){let a;if("rapid"===t.type)a=s;else if(this.toolStates.has(e)){const t=this.toolStates.get(e).color;a=this.hexToRgb(t)}else a=n[e%n.length];const r=t.start.x+(t.end.x-t.start.x)*this.segmentProgress,h=t.start.y+(t.end.y-t.start.y)*this.segmentProgress,l=t.start.z+(t.end.z-t.start.z)*this.segmentProgress;i.push(t.start.x,t.start.y,t.start.z),o.push(...a),i.push(r,h,l),o.push(...a)}}}this.vertexCount=i.length/3,t.bindBuffer(t.ARRAY_BUFFER,this.buffers.position),t.bufferData(t.ARRAY_BUFFER,new Float32Array(i),t.STATIC_DRAW),t.bindBuffer(t.ARRAY_BUFFER,this.buffers.color),t.bufferData(t.ARRAY_BUFFER,new Float32Array(o),t.STATIC_DRAW)}hexToRgb(t){const e=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t);return e?[parseInt(e[1],16)/255,parseInt(e[2],16)/255,parseInt(e[3],16)/255]:[1,1,1]}render(){if(!this.gl)return void console.error("No WebGL context");this.resizeCanvas();const t=this.gl;if("dark"===document.documentElement.getAttribute("data-theme")?t.clearColor(.15,.15,.15,1):t.clearColor(.98,.98,.98,1),t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT),!this.vertexCount||0===this.vertexCount)return;t.useProgram(this.program);const e=this.canvas.width/this.canvas.height,s=this.camera.getMVPMatrix(e);t.uniformMatrix4fv(this.locations.uMVP,!1,s),t.bindBuffer(t.ARRAY_BUFFER,this.buffers.position),t.vertexAttribPointer(this.locations.aPosition,3,t.FLOAT,!1,0,0),t.enableVertexAttribArray(this.locations.aPosition),t.bindBuffer(t.ARRAY_BUFFER,this.buffers.color),t.vertexAttribPointer(this.locations.aColor,3,t.FLOAT,!1,0,0),t.enableVertexAttribArray(this.locations.aColor),t.drawArrays(t.LINES,0,this.vertexCount),this.drawGrid(s),this.drawAxes(s),this.drawCurrentPositionMarker(s),this.drawGridLabels(s)}drawGrid(t){const e=this.gl,s=document.getElementById("grid-enabled")?.checked;if(!s)return;const n=parseFloat(document.getElementById("grid-width")?.value||1e3),i=parseFloat(document.getElementById("grid-height")?.value||600);if(n<=0||i<=0)return;const o=document.documentElement.getAttribute("data-theme"),a="dark"===o?[.3,.3,.3]:[.85,.85,.85],r="dark"===o?[.5,.5,.5]:[.7,.7,.7],h="dark"===o?[.7,.7,.7]:[.5,.5,.5],l=[],c=[];for(let t=0;t<=n;t+=10)t%100!=0&&(l.push(t,0,0,t,i,0),c.push(...a,...a));for(let t=0;t<=i;t+=10)t%100!=0&&(l.push(0,t,0,n,t,0),c.push(...a,...a));for(let t=0;t<=n;t+=100)l.push(t,0,0,t,i,0),c.push(...r,...r);for(let t=0;t<=i;t+=100)l.push(0,t,0,n,t,0),c.push(...r,...r);l.push(0,0,0,n,0,0,n,0,0,n,i,0,n,i,0,0,i,0,0,i,0,0,0,0);for(let t=0;t<8;t++)c.push(...h);const d=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,d),e.bufferData(e.ARRAY_BUFFER,new Float32Array(l),e.STATIC_DRAW),e.vertexAttribPointer(this.locations.aPosition,3,e.FLOAT,!1,0,0);const u=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,u),e.bufferData(e.ARRAY_BUFFER,new Float32Array(c),e.STATIC_DRAW),e.vertexAttribPointer(this.locations.aColor,3,e.FLOAT,!1,0,0),e.drawArrays(e.LINES,0,l.length/3),e.deleteBuffer(d),e.deleteBuffer(u)}drawAxes(t){const e=this.gl;if(!this.bounds)return;const s=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,s),e.bufferData(e.ARRAY_BUFFER,new Float32Array([0,0,0,100,0,0,0,0,0,0,100,0,0,0,0,0,0,100]),e.STATIC_DRAW),e.vertexAttribPointer(this.locations.aPosition,3,e.FLOAT,!1,0,0);const n=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,n),e.bufferData(e.ARRAY_BUFFER,new Float32Array([1,0,0,1,0,0,0,1,0,0,1,0,0,0,1,0,0,1]),e.STATIC_DRAW),e.vertexAttribPointer(this.locations.aColor,3,e.FLOAT,!1,0,0),e.drawArrays(e.LINES,0,6),e.deleteBuffer(s),e.deleteBuffer(n)}drawCurrentPositionMarker(t){if(this.maxSegmentIndex>=this.segments.length||this.maxSegmentIndex===1/0)return;const e=this.segments[this.maxSegmentIndex];if(!e)return;const s=this.gl,n=this.segmentProgress,i=e.start.x+(e.end.x-e.start.x)*n,o=e.start.y+(e.end.y-e.start.y)*n,a=e.start.z+(e.end.z-e.start.z)*n,r=[],h=[],l=16;for(let t=0;t<=l;t++){const e=t*Math.PI/l,s=Math.sin(e),n=Math.cos(e);for(let t=0;t<=l;t++){const e=2*t*Math.PI/l,c=Math.sin(e),d=Math.cos(e)*s,u=c*s,m=n,g=i+1.5*d,x=o+1.5*u,p=a+1.5*m;r.push(g,x,p),h.push(d,u,m)}}const c=[];for(let t=0;t<l;t++)for(let e=0;e<l;e++){const s=17*t+e,n=s+l+1;c.push(s,n,s+1),c.push(n,n+1,s+1)}if(!this.sphereProgram){const t="\n attribute vec3 aPosition;\n attribute vec3 aNormal;\n uniform mat4 uMVP;\n varying vec3 vNormal;\n \n void main() {\n gl_Position = uMVP * vec4(aPosition, 1.0);\n vNormal = aNormal;\n }\n ",e="\n precision mediump float;\n varying vec3 vNormal;\n \n void main() {\n vec3 lightDir = normalize(vec3(0.5, 0.3, 1.0));\n float diffuse = max(dot(vNormal, lightDir), 0.0);\n float ambient = 0.3;\n float lighting = ambient + diffuse * 0.7;\n \n vec3 color = vec3(1.0, 0.0, 0.0) * lighting;\n gl_FragColor = vec4(color, 1.0);\n }\n ",n=this.compileShader(s.VERTEX_SHADER,t),i=this.compileShader(s.FRAGMENT_SHADER,e);this.sphereProgram=s.createProgram(),s.attachShader(this.sphereProgram,n),s.attachShader(this.sphereProgram,i),s.linkProgram(this.sphereProgram),this.sphereLocations={aPosition:s.getAttribLocation(this.sphereProgram,"aPosition"),aNormal:s.getAttribLocation(this.sphereProgram,"aNormal"),uMVP:s.getUniformLocation(this.sphereProgram,"uMVP")}}s.useProgram(this.sphereProgram),s.uniformMatrix4fv(this.sphereLocations.uMVP,!1,t);const d=s.createBuffer();s.bindBuffer(s.ARRAY_BUFFER,d),s.bufferData(s.ARRAY_BUFFER,new Float32Array(r),s.STATIC_DRAW),s.vertexAttribPointer(this.sphereLocations.aPosition,3,s.FLOAT,!1,0,0),s.enableVertexAttribArray(this.sphereLocations.aPosition);const u=s.createBuffer();s.bindBuffer(s.ARRAY_BUFFER,u),s.bufferData(s.ARRAY_BUFFER,new Float32Array(h),s.STATIC_DRAW),s.vertexAttribPointer(this.sphereLocations.aNormal,3,s.FLOAT,!1,0,0),s.enableVertexAttribArray(this.sphereLocations.aNormal);const m=s.createBuffer();s.bindBuffer(s.ELEMENT_ARRAY_BUFFER,m),s.bufferData(s.ELEMENT_ARRAY_BUFFER,new Uint16Array(c),s.STATIC_DRAW),s.drawElements(s.TRIANGLES,c.length,s.UNSIGNED_SHORT,0),s.deleteBuffer(d),s.deleteBuffer(u),s.deleteBuffer(m)}drawGridLabels(t){if(!this.overlayCtx)return;const e=this.overlayCtx,s=document.getElementById("grid-enabled")?.checked;if(!s)return;const n=parseFloat(document.getElementById("grid-width")?.value||1e3),i=parseFloat(document.getElementById("grid-height")?.value||600);if(n<=0||i<=0)return;e.clearRect(0,0,this.overlayCanvas.width,this.overlayCanvas.height);const o=document.documentElement.getAttribute("data-theme");e.fillStyle="dark"===o?"#aaa":"#555",e.font="11px monospace",e.textAlign="center",e.textBaseline="middle";const a=(e,s,n)=>{const i=[e,s,n,1],o=[0,0,0,0];for(let e=0;e<4;e++)for(let s=0;s<4;s++)o[e]+=t[4*s+e]*i[s];const a=o[3],r=o[0]/a,h=o[1]/a;return{x:.5*(r+1)*this.overlayCanvas.width,y:.5*(1-h)*this.overlayCanvas.height,visible:a>0}};for(let t=0;t<=n;t+=100){const s=a(t,0,0);s.visible&&s.x>=0&&s.x<=this.overlayCanvas.width&&s.y>=0&&s.y<=this.overlayCanvas.height&&e.fillText(t.toString(),s.x,s.y+15)}for(let t=0;t<=i;t+=100){const s=a(0,t,0);s.visible&&s.x>=0&&s.x<=this.overlayCanvas.width&&s.y>=0&&s.y<=this.overlayCanvas.height&&e.fillText(t.toString(),s.x-20,s.y)}}destroy(){if(!this.gl)return;const t=this.gl;t.deleteBuffer(this.buffers.position),t.deleteBuffer(this.buffers.color),t.deleteProgram(this.program)}}class Animator{constructor(){this.segments=[],this.currentIndex=0,this.segmentProgress=0,this.isPlaying=!1,this.speed=1,this.lastTime=0,this.accumulatedTime=0,this.estimatedTotalTime=0,this.toolTimes=new Map,this.rapidSpeed=3e3,this.maxRateX=3e3,this.maxRateY=3e3,this.maxRateZ=2e3,this.accelX=200,this.accelY=200,this.accelZ=80,this.manualToolChangeTime=30,this.autoToolChangeTime=10,this.onUpdate=null}setMotionParameters(t){void 0!==t.accelX&&(this.accelX=t.accelX),void 0!==t.accelY&&(this.accelY=t.accelY),void 0!==t.accelZ&&(this.accelZ=t.accelZ),void 0!==t.maxRateX&&(this.maxRateX=t.maxRateX),void 0!==t.maxRateY&&(this.maxRateY=t.maxRateY),void 0!==t.maxRateZ&&(this.maxRateZ=t.maxRateZ),console.log("[Animator] Motion parameters updated:",{accel:{X:this.accelX,Y:this.accelY,Z:this.accelZ},maxRate:{X:this.maxRateX,Y:this.maxRateY,Z:this.maxRateZ}})}setSegments(t){this.segments=t,this.currentIndex=0,this.segmentProgress=0,this.accumulatedTime=0,this.calculateTotalTime(),this.calculateDistances()}calculateDistances(){this.segmentDistances=[];let t=0;for(let e=0;e<this.segments.length;e++){const s=this.segments[e];if("cut"===s.type){const e=s.end.x-s.start.x,n=s.end.y-s.start.y,i=s.end.z-s.start.z;t+=Math.sqrt(e*e+n*n+i*i)}this.segmentDistances.push(t)}this.totalDistance=t}calculateTotalTime(){this.estimatedTotalTime=0,this.toolTimes.clear();for(let t=0;t<this.segments.length;t++){const e=this.segments[t],s=t>0?this.segments[t-1]:null,n=t<this.segments.length-1?this.segments[t+1]:null;let i=0;if("M0"===e.toolChangeType?i+=this.manualToolChangeTime:"M6"===e.toolChangeType&&(i+=this.autoToolChangeTime),"cut"===e.type&&e.feedRate>0){const t=e.feedRate,o=s&&"cut"===s.type?s.feedRate:0,a=n&&"cut"===n.type?n.feedRate:0,r=this.calculateJunctionVelocity(s,e,o,t),h=this.calculateJunctionVelocity(e,n,t,a);i+=this.calculateMoveTime(e,t,r,h)}else if("rapid"===e.type){const t=e.end.x-e.start.x,o=e.end.y-e.start.y,a=e.end.z-e.start.z,r=Math.sqrt(t*t+o*o+a*a);if(r>0){let h=1/0;if(Math.abs(t)>.001){const e=r/(Math.abs(t)/(this.maxRateX/60))*60;h=Math.min(h,e)}if(Math.abs(o)>.001){const t=r/(Math.abs(o)/(this.maxRateY/60))*60;h=Math.min(h,t)}if(Math.abs(a)>.001){const t=r/(Math.abs(a)/(this.maxRateZ/60))*60;h=Math.min(h,t)}h===1/0&&(h=this.rapidSpeed);const l=s&&"rapid"===s.type,c=n&&"rapid"===n.type,d=l?this.calculateJunctionVelocity(s,e,h,h):0,u=c?this.calculateJunctionVelocity(e,n,h,h):0;i+=this.calculateMoveTime(e,h,d,u)}}if(this.estimatedTotalTime+=i,"cut"===e.type){const t=e.tool||1,s=this.toolTimes.get(t)||0;this.toolTimes.set(t,s+i)}}}calculateMoveTime(t,e,s=0,n=0){const i=t.end.x-t.start.x,o=t.end.y-t.start.y,a=t.end.z-t.start.z,r=Math.sqrt(i*i+o*o+a*a);if(0===r)return 0;const h=e/60;let l=1/0;if(Math.abs(i)>.001){const t=this.accelX;l=Math.min(l,t)}if(Math.abs(o)>.001){const t=this.accelY;l=Math.min(l,t)}if(Math.abs(a)>.001){const t=this.accelZ;l=Math.min(l,t)}l===1/0&&(l=this.accelX);const c=(h*h-(s=Math.min(s,h))*s)/(2*l)+(h*h-(n=Math.min(n,h))*n)/(2*l);if(c>=r){const t=(s*s+n*n)/2+l*r,e=Math.sqrt(Math.max(0,t));return(e-s)/l+(e-n)/l}return(h-s)/l+(r-c)/h+(h-n)/l}calculateJunctionVelocity(t,e,s,n){if(!t||!e)return 0;if(t.tool!==e.tool||t.type!==e.type)return 0;const i=t.end.x-e.start.x,o=t.end.y-e.start.y,a=t.end.z-e.start.z;if(i*i+o*o+a*a>=1e-6)return 0;const r=t.end.x-t.start.x,h=t.end.y-t.start.y,l=t.end.z-t.start.z,c=r*r+h*h+l*l,d=e.end.x-e.start.x,u=e.end.y-e.start.y,m=e.end.z-e.start.z,g=d*d+u*u+m*m;if(0===c||0===g)return 0;const x=Math.sqrt(c),p=Math.sqrt(g),f=r/x*(d/p)+h/x*(u/p)+l/x*(m/p);if(f>.999)return Math.min(s,n)/60;const y=(1+f)/2;return Math.min(s,n)/60*y}formatDuration(t){if(0===t)return"-";const e=Math.floor(t),s=Math.floor(e/3600),n=Math.floor(e%3600/60),i=e%60;return s>0?`${s}h ${n}m ${i}s`:n>0?`${n}m ${i}s`:`${i}s`}getFormattedTime(){return this.formatDuration(this.estimatedTotalTime)}getToolTime(t){const e=this.toolTimes.get(t)||0;return this.formatDuration(e)}getToolTimes(){return this.toolTimes}play(){0!==this.segments.length&&(this.isPlaying=!0,this.lastTime=performance.now(),this.animate())}pause(){this.isPlaying=!1}reset(){this.currentIndex=0,this.accumulatedTime=0,this.isPlaying=!1,this.onUpdate&&this.onUpdate(this.currentIndex)}setSpeed(t){this.speed=Math.max(.1,Math.min(10,t))}static sliderToSpeed(t){return 0===t?1:t>0?1+t/10*9:1+t/10*.9}stepNext(){this.currentIndex<this.segments.length&&(this.currentIndex++,this.onUpdate&&this.onUpdate(this.currentIndex))}stepPrev(){this.currentIndex>0&&(this.currentIndex--,this.onUpdate&&this.onUpdate(this.currentIndex))}setCurrentLine(t){const e=Math.max(0,Math.min(t,this.segments.length));e!==this.currentIndex&&(this.currentIndex=e,this.isPlaying=!1,this.onUpdate&&this.onUpdate(this.currentIndex))}animate(){if(!this.isPlaying)return;const t=performance.now(),e=(t-this.lastTime)/1e3;if(this.lastTime=t,this.totalDistance>0){const t=100*this.speed*e;this.accumulatedTime+=t;const s=this.accumulatedTime;let n=0,i=0,o=this.segmentDistances.length-1;for(;i<o;){const t=Math.floor((i+o)/2);this.segmentDistances[t]<s?i=t+1:o=t}if(n=i,n<this.segments.length){const t=this.segments[n],e=n>0?this.segmentDistances[n-1]:0,i=this.segmentDistances[n]-e;if("cut"===t.type&&i>0){const t=s-e;this.segmentProgress=Math.min(1,Math.max(0,t/i))}else this.segmentProgress=1}else this.segmentProgress=1;if(this.currentIndex,this.currentIndex=n,this.onUpdate&&this.onUpdate(this.currentIndex,this.segmentProgress),this.accumulatedTime>=this.totalDistance)return this.currentIndex=this.segments.length,this.segmentProgress=1,this.isPlaying=!1,void(this.onUpdate&&this.onUpdate(this.currentIndex,1))}else if(this.estimatedTotalTime>0){this.accumulatedTime+=e*this.speed;const t=this.accumulatedTime/this.estimatedTotalTime,s=Math.floor(t*this.segments.length);if(s!==this.currentIndex&&s<=this.segments.length&&(this.currentIndex=s,this.segmentProgress=1,this.onUpdate&&this.onUpdate(this.currentIndex,1)),this.currentIndex>=this.segments.length)return this.currentIndex=this.segments.length,this.segmentProgress=1,this.isPlaying=!1,void(this.onUpdate&&this.onUpdate(this.currentIndex,1))}else{const t=100*this.speed*e;if(this.currentIndex+=t,this.segmentProgress=1,this.onUpdate&&this.onUpdate(Math.floor(this.currentIndex),1),this.currentIndex>=this.segments.length)return this.currentIndex=this.segments.length,this.segmentProgress=1,this.isPlaying=!1,void(this.onUpdate&&this.onUpdate(this.currentIndex,1))}requestAnimationFrame(()=>this.animate())}getProgress(){return 0===this.segments.length?0:this.currentIndex/this.segments.length*100}getCurrentIndex(){return Math.floor(this.currentIndex)}getTotalSegments(){return this.segments.length}getIsPlaying(){return this.isPlaying}}class Controller{constructor(){this.parser=new GCodeParser,this.camera=new Camera,this.animator=new Animator,this.canvas2d=document.getElementById("canvas2d"),this.canvas3d=document.getElementById("canvas3d"),this.canvas3dOverlay=document.getElementById("canvas3d-overlay"),this.renderer2d=new Renderer2D(this.canvas2d,this.camera),this.renderer3d=new Renderer3D(this.canvas3d,this.camera,this.canvas3dOverlay),this.currentView="2d",this.segments=[],this.bounds=null,this.isDragging=!1,this.lastMouseX=0,this.lastMouseY=0,this.isShiftPressed=!1,this.tools=new Map,this.toolColors=["#00ccff","#00ff88","#ff4dff","#ffff00","#ff8800","#8888ff","#ff0088","#00ffff"],this.rapidMovesVisible=!0,this.rapidMoveColor="#999999",this.spaceMouseConnected=!1,this.spaceMouseIndex=-1,this.touches=[],this.lastPinchDistance=0,this.lastTouchCenter=null,this.setupEventListeners(),this.setupAnimator(),this.setupSpaceMouse(),this.startRenderLoop()}setupSpaceMouse(){window.addEventListener("gamepadconnected",t=>{const e=t.gamepad;(e.id.toLowerCase().includes("3dconnexion")||e.id.toLowerCase().includes("spacemouse")||e.id.toLowerCase().includes("space"))&&(this.spaceMouseConnected=!0,this.spaceMouseIndex=e.index,console.log("SpaceMouse connected:",e.id))}),window.addEventListener("gamepaddisconnected",t=>{t.gamepad.index===this.spaceMouseIndex&&(this.spaceMouseConnected=!1,this.spaceMouseIndex=-1,console.log("SpaceMouse disconnected"))})}pollSpaceMouse(){if(!this.spaceMouseConnected||"3d"!==this.currentView)return;const t=navigator.getGamepads();if(!t||!t[this.spaceMouseIndex])return;const e=t[this.spaceMouseIndex],s=.05,n=[];for(let t=0;t<e.axes.length;t++)Math.abs(e.axes[t])>s&&n.push(`axis${t}=${e.axes[t].toFixed(2)}`);if(n.length>0&&console.log("Active axes:",n.join(", ")),e.axes.length>=3){const t=Math.abs(e.axes[0])>s?e.axes[0]:0,n=Math.abs(e.axes[2])>s?e.axes[2]:0;0===t&&0===n||this.camera.pan3D(.5*-t,.5*-n)}if(e.axes.length>=2){const t=Math.abs(e.axes[1])>s?e.axes[1]:0;0!==t&&(this.camera.zoom3D(.05*t),this.updateZoomSlider())}if(e.axes.length>=5){const t=Math.abs(e.axes[3])>s?e.axes[3]:0,n=Math.abs(e.axes[4])>s?e.axes[4]:0;0===t&&0===n||this.camera.rotate(15*n,15*-t)}e.axes.length>=6&&Math.abs(e.axes[5])>s&&e.axes[5]}setupEventListeners(){let t;document.querySelectorAll(".mobile-tab-button").forEach(t=>{t.addEventListener("click",()=>{const e=t.getAttribute("data-tab");this.switchMobileTab(e)})}),window.addEventListener("resize",()=>{clearTimeout(t),t=setTimeout(()=>{if(this.renderer2d.resizeCanvas(),this.renderer3d.resizeCanvas(),window.innerWidth>968)document.querySelectorAll(".mobile-tab-content").forEach(t=>{t.classList.add("active")});else{const t=document.querySelector(".mobile-tab-button.active");if(t){const e=t.getAttribute("data-tab");this.switchMobileTab(e)}}},100)});const e=document.getElementById("upload-zone"),s=document.getElementById("file-input");e&&s&&(e.addEventListener("click",()=>s.click()),e.addEventListener("dragover",t=>{t.preventDefault(),e.classList.add("drag-over")}),e.addEventListener("dragleave",()=>{e.classList.remove("drag-over")}),e.addEventListener("drop",t=>{t.preventDefault(),e.classList.remove("drag-over"),t.dataTransfer.files.length>0&&this.loadFile(t.dataTransfer.files[0])}),s.addEventListener("change",t=>{t.target.files.length>0&&this.loadFile(t.target.files[0])}));const n=document.getElementById("btn-toggle-view");n&&n.addEventListener("click",()=>{this.toggleView()});const i=document.getElementById("btn-reset-view");i&&i.addEventListener("click",()=>{this.segments.length>0&&(this.camera.fitToBounds(this.bounds,.1,this.canvas2d.width,this.canvas2d.height),this.updateZoomSlider())});const o=document.getElementById("btn-play");o&&o.addEventListener("click",()=>{this.togglePlayback()});const a=document.getElementById("btn-reset");a&&a.addEventListener("click",()=>{this.animator.reset()});const r=document.getElementById("btn-next");r&&r.addEventListener("click",()=>{this.animator.stepNext()});const h=document.getElementById("btn-prev");h&&h.addEventListener("click",()=>{this.animator.stepPrev()});const l=document.getElementById("speed-slider"),c=document.getElementById("speed-label");l&&c&&l.addEventListener("input",t=>{const e=Animator.sliderToSpeed(parseFloat(t.target.value));this.animator.setSpeed(e),c.textContent=e.toFixed(1)+"x"});const d=document.getElementById("line-slider");d&&d.addEventListener("input",t=>{const e=parseInt(t.target.value);this.animator.setCurrentLine(e)});const u=document.getElementById("layer-min"),m=document.getElementById("layer-max");u&&u.addEventListener("input",()=>{this.updateLayerFilter()}),m&&m.addEventListener("input",()=>{this.updateLayerFilter()});const g=document.getElementById("zoom-slider"),x=document.getElementById("zoom-value");g&&x&&g.addEventListener("input",t=>{const e=parseFloat(t.target.value);if("2d"===this.currentView){const t=e*this.camera.initialZoom2d;this.setZoom(t)}else{const t=this.camera.initialOrthoScale/e;this.camera.orthoScale=t,this.render()}x.textContent=Math.round(100*e)+"%"});const p=document.getElementById("theme-light"),f=document.getElementById("theme-dark");if(p&&f){const t=localStorage.getItem("theme")||"light";document.documentElement.setAttribute("data-theme",t),p.addEventListener("click",()=>{document.documentElement.setAttribute("data-theme","light"),localStorage.setItem("theme","light"),this.render()}),f.addEventListener("click",()=>{document.documentElement.setAttribute("data-theme","dark"),localStorage.setItem("theme","dark"),this.render()})}const y=document.getElementById("grid-enabled");y&&y.addEventListener("change",()=>{});const v=document.getElementById("grid-width");v&&v.addEventListener("input",()=>{});const b=document.getElementById("grid-height");b&&b.addEventListener("input",()=>{});const C=document.getElementById("rapid-moves-visible"),E=document.getElementById("rapid-move-color");C&&C.addEventListener("change",()=>{this.rapidMovesVisible=C.checked,this.updateRenderers()}),E&&E.addEventListener("input",()=>{this.rapidMoveColor=E.value,this.updateRenderers()}),this.setupCanvasEvents(),window.addEventListener("keydown",t=>{"Shift"===t.key&&(this.isShiftPressed=!0)}),window.addEventListener("keyup",t=>{"Shift"===t.key&&(this.isShiftPressed=!1)})}setupCanvasEvents(){const t=this.canvas2d,e=this.canvas3d,s=t=>{this.isDragging=!0,this.dragButton=t.button,this.lastMouseX=t.clientX,this.lastMouseY=t.clientY,2===t.button&&t.preventDefault()},n=e=>{if(this.isDragging){const t=e.clientX-this.lastMouseX,s=e.clientY-this.lastMouseY;"2d"===this.currentView?this.camera.pan2D(t,s):2===this.dragButton?this.camera.pan3D(t,s):this.camera.rotate(t,s),this.lastMouseX=e.clientX,this.lastMouseY=e.clientY}else if("2d"===this.currentView){const s=t.getBoundingClientRect(),n=e.clientX-s.left,i=e.clientY-s.top,o=this.renderer2d.canvasToWorld(n,i);this.updateCoordinateDisplay(o.x,o.y,0)}},i=()=>{this.isDragging=!1},o=e=>{if(e.preventDefault(),"2d"===this.currentView){const s=t.getBoundingClientRect(),n=e.clientX-s.left,i=e.clientY-s.top;this.camera.zoom2D(e.deltaY,n,i,t.width,t.height)}else this.camera.zoom3D(e.deltaY);this.updateZoomSlider()},a=()=>{this.bounds&&this.camera.fitToBounds(this.bounds)},r=t=>{t.preventDefault()};[t,e].forEach(t=>{t.addEventListener("mousedown",s),t.addEventListener("mousemove",n),t.addEventListener("mouseup",i),t.addEventListener("mouseleave",i),t.addEventListener("wheel",o,{passive:!1}),t.addEventListener("dblclick",a),t.addEventListener("contextmenu",r)});const h=t=>{t.preventDefault(),this.touches=Array.from(t.touches),1===this.touches.length?(this.isDragging=!0,this.lastMouseX=this.touches[0].clientX,this.lastMouseY=this.touches[0].clientY):2===this.touches.length&&(this.lastPinchDistance=this.getTouchDistance(this.touches[0],this.touches[1]),this.lastTouchCenter=this.getTouchCenter(this.touches[0],this.touches[1]))},l=e=>{if(e.preventDefault(),this.touches=Array.from(e.touches),1===this.touches.length&&this.isDragging){const t=this.touches[0].clientX-this.lastMouseX,e=this.touches[0].clientY-this.lastMouseY;"2d"===this.currentView?this.camera.pan2D(t,e):this.camera.rotate(1.5*t,1.5*e),this.lastMouseX=this.touches[0].clientX,this.lastMouseY=this.touches[0].clientY}else if(2===this.touches.length){const e=this.getTouchDistance(this.touches[0],this.touches[1]),s=this.getTouchCenter(this.touches[0],this.touches[1]),n=e-this.lastPinchDistance;if("2d"===this.currentView){if(Math.abs(n)<100&&Math.abs(n)>.5){const e=t.getBoundingClientRect(),i=s.x-e.left,o=s.y-e.top;this.renderer2d.canvasToWorld(i,o),this.camera.zoom2D(-n,i,o,e.width,e.height,!0)}}else{if(this.lastTouchCenter){const t=s.x-this.lastTouchCenter.x,e=s.y-this.lastTouchCenter.y;Math.sqrt(t*t+e*e)>2&&this.camera.pan3D(2*t,2*e)}Math.abs(n)>5&&this.camera.zoom3D(.003*-n)}this.lastPinchDistance=e,this.lastTouchCenter=s}},c=()=>{this.isDragging=!1,this.touches=[],this.lastTouchCenter=null};[t,e].forEach(t=>{t.addEventListener("touchstart",h,{passive:!1}),t.addEventListener("touchmove",l,{passive:!1}),t.addEventListener("touchend",c,{passive:!1})})}getTouchDistance(t,e){const s=e.clientX-t.clientX,n=e.clientY-t.clientY;return Math.sqrt(s*s+n*n)}getTouchCenter(t,e){return{x:(t.clientX+e.clientX)/2,y:(t.clientY+e.clientY)/2}}setupAnimator(){this.animator.onUpdate=(t,e=1)=>{if(this.renderer2d.setMaxSegmentIndex(t,e),this.renderer3d.setMaxSegmentIndex(t,e),document.getElementById("current-line").textContent=t,document.getElementById("line-slider").value=t,t<this.segments.length){const e=this.segments[t];this.currentPosition={x:e.x1,y:e.y1,z:e.z1},this.highlightGCodeLine(e.lineNum),document.getElementById("current-file-line").textContent=e.lineNum||"-"}else document.getElementById("current-file-line").textContent="-";document.getElementById("btn-play").textContent=this.animator.getIsPlaying()?"Pause":"Play"}}async loadFile(t){const e=document.getElementById("progress-bar"),s=document.getElementById("progress-fill");e.classList.remove("hidden"),s.style.width="0%";try{const n=await t.text();this.gcodeText=n;const i=await this.parser.parseFile(t,t=>{s.style.width=t+"%"});this.segments=i,this.bounds=this.parser.getBounds(),this.detectTools(i),this.renderer2d.setSegments(i,this.bounds),this.renderer3d.setSegments(i,this.bounds),this.updateRenderers(),this.animator.setSegments(i),this.camera.fitToBounds(this.bounds,.1,this.canvas2d.width,this.canvas2d.height),this.updateStatistics(),this.displayGCode(n),this.updateToolPanel();const o=document.getElementById("gcode-panel");o.style.visibility="visible",o.style.position="static",document.getElementById("animation-panel").style.display="block",document.getElementById("tool-panel").style.display="block";const a=document.getElementById("rapid-moves-panel");a&&(a.style.display="block"),document.getElementById("btn-reset-view").disabled=!1;const r=document.querySelector(".left-sidebar");r&&r.classList.remove("gcode-hidden");const h=document.getElementById("gcode-welcome");h&&(h.style.display="none");const l=document.getElementById("line-slider");l.max=i.length,l.value=0,document.getElementById("total-lines").textContent=i.length,setTimeout(()=>{e.classList.add("hidden")},500)}catch(t){console.error("Error loading file:",t),alert("Error loading GCode file. Please check the console for details."),e.classList.add("hidden")}}async loadGCodeFromString(t,e=""){const s=document.getElementById(`${e}progress-bar`),n=document.getElementById(`${e}progress-fill`),i=t.split("\n").filter(t=>/Y\d{5,}/.test(t));i.length>0?console.error(`CONTROLLER ERROR: String has ${i.length} bad lines:`,i.slice(0,2)):console.log("‚úì Controller OK: String is clean in loadGCodeFromString"),s&&(s.classList.remove("hidden"),n.style.width="0%");try{this.gcodeText=t;const i=await this.parser.parseString(t,t=>{n&&(n.style.width=t+"%")});this.segments=i,this.bounds=this.parser.getBounds(),this.detectTools(i),this.renderer2d.setSegments(i,this.bounds),this.renderer3d.setSegments(i,this.bounds),this.updateRenderers(),this.animator.setSegments(i),this.camera.fitToBounds(this.bounds,.1,this.canvas2d.width,this.canvas2d.height),this.updateStatistics(e),this.displayGCode(t,e),this.updateToolPanel(e);const o=document.getElementById(`${e}gcode-panel`);o&&(o.style.visibility="visible",o.style.position="static");const a=document.getElementById(`${e}animation-panel`);a&&(a.style.display="block");const r=document.getElementById(`${e}tool-panel`);r&&(r.style.display="block");const h=document.getElementById(`${e}rapid-moves-panel`);h&&(h.style.display="block");const l=document.getElementById(`${e}btn-reset-view`);l&&(l.disabled=!1);const c=document.querySelector(e?`.${e}left-sidebar`:".left-sidebar");c&&c.classList.remove("gcode-hidden");const d=document.getElementById(`${e}gcode-welcome`);d&&(d.style.display="none");const u=document.getElementById(`${e}line-slider`);u&&(u.max=i.length,u.value=0);const m=document.getElementById(`${e}total-lines`);m&&(m.textContent=i.length),this.is3DView?this.renderer3d.render():this.renderer2d.render(),s&&setTimeout(()=>{s.classList.add("hidden")},500)}catch(t){console.error("Error loading GCode:",t),alert("Error parsing GCode. Please check the console for details."),s&&s.classList.add("hidden")}}detectTools(t){const e=new Set;for(const s of t)"rapid"!==s.type&&e.add(s.tool||1);const s=this.parser.getToolNames(),n=this.parser.getToolColors(),i=this.parser.usingInlineToolFormat;this.tools.clear();const o=Array.from(e).sort((t,e)=>t-e);for(const t of o){const e=i?t:t-1,o=n[e],a=t%this.toolColors.length,r=this.toolColors[a];this.tools.set(t,{visible:!0,color:o||r,name:s[e]||`Tool ${t}`})}}updateToolPanel(t=""){const e=document.getElementById(`${t}tool-list`);if(e)if(e.innerHTML="",0!==this.tools.size)for(const[t,s]of this.tools){const n=document.createElement("div");n.style.cssText="display: flex; align-items: center; gap: 8px; margin-bottom: 8px; padding: 8px; background: var(--canvas-bg); border-radius: 4px;";const i=document.createElement("input");i.type="checkbox",i.checked=s.visible,i.onchange=()=>{s.visible=i.checked,this.updateRenderers()};const o=document.createElement("input");o.type="color",o.value=s.color,o.style.cssText="width: 32px; height: 24px; border: none; cursor: pointer;",o.onchange=()=>{s.color=o.value,this.updateRenderers()};const a=document.createElement("div");a.style.cssText="flex: 1; display: flex; flex-direction: column; gap: 2px;";const r=document.createElement("span"),h=s.name?`Tool ${t} - ${s.name}`:`Tool ${t}`;r.textContent=h,r.style.cssText="font-size: 13px;";const l=document.createElement("span"),c=this.animator.getToolTime(t);l.textContent=`Est. Time: ${c}`,l.style.cssText="font-size: 11px; opacity: 0.7;",a.appendChild(r),a.appendChild(l),n.appendChild(i),n.appendChild(o),n.appendChild(a),e.appendChild(n)}else e.innerHTML='<div style="padding: 10px; opacity: 0.7; font-size: 12px;">No tools detected</div>'}updateRenderers(){this.renderer2d.setToolStates(this.tools),this.renderer3d.setToolStates(this.tools),this.renderer2d.setRapidMoveSettings(this.rapidMovesVisible,this.rapidMoveColor),this.renderer3d.setRapidMoveSettings(this.rapidMovesVisible,this.rapidMoveColor),this.renderer2d.updateBuffers(),this.renderer3d.updateBuffers()}updateStatistics(t=""){const e=document.getElementById(`${t}stat-lines`),s=document.getElementById(`${t}stat-time`),n=document.getElementById(`${t}stat-x`),i=document.getElementById(`${t}stat-y`),o=document.getElementById(`${t}stat-z`),a=document.getElementById(`${t}total-lines`),r=document.getElementById(`${t}current-line`),h=document.getElementById(`${t}layer-min`),l=document.getElementById(`${t}layer-max`);e&&(e.textContent=this.segments.length),s&&(s.textContent=this.animator.getFormattedTime()),n&&(n.textContent=`${this.bounds.minX.toFixed(1)} to ${this.bounds.maxX.toFixed(1)}`),i&&(i.textContent=`${this.bounds.minY.toFixed(1)} to ${this.bounds.maxY.toFixed(1)}`),o&&(o.textContent=`${this.bounds.minZ.toFixed(1)} to ${this.bounds.maxZ.toFixed(1)}`),a&&(a.textContent=this.segments.length),r&&(r.textContent="0"),h&&(h.placeholder=this.bounds.minZ.toFixed(1)),l&&(l.placeholder=this.bounds.maxZ.toFixed(1))}updateCoordinateDisplay(t,e,s){const n=document.getElementById("coordinates");n&&(n.textContent=`X: ${t.toFixed(2)} Y: ${e.toFixed(2)} Z: ${s.toFixed(2)}`)}displayGCode(t,e=""){const s=document.getElementById(`${e}gcode-container`);if(!s)return;const n=t.split("\n"),i=n.length;this.gcodeLines=n,this.gcodeLineHeight=17,this.gcodeCurrentHighlight=null;const o=document.getElementById(`${e}gcode-line-indicator`);o&&(o.textContent=`(${i} lines)`),s.innerHTML=`\n <div style="min-height: ${(i+10)*this.gcodeLineHeight}px; position: relative; width: max-content; min-width: 100%;">\n <div id="${e}gcode-viewport" style="position: absolute; top: 0; left: 0; will-change: transform;">\n <div style="display: flex;">\n <div class="gcode-line-numbers" id="${e}gcode-line-numbers"></div>\n <div class="gcode-code" id="${e}gcode-display"></div>\n </div>\n </div>\n </div>\n `;const a=document.getElementById(`${e}gcode-viewport`),r=document.getElementById(`${e}gcode-display`),h=document.getElementById(`${e}gcode-line-numbers`);let l=-1;const c=(t=!1)=>{const e=s.scrollTop;let o=s.clientHeight;o&&0!==o||(o=s.offsetHeight||.5*window.innerHeight);const c=Math.max(0,Math.floor(e/this.gcodeLineHeight)-50),d=Math.min(i,c+Math.ceil(o/this.gcodeLineHeight)+150);if(!t&&c===l)return;l=c,a.style.transform=`translateY(${c*this.gcodeLineHeight}px)`;const u=[];for(let t=c;t<d;t++){const e=this.gcodeCurrentHighlight===t+1?" highlight":"";u.push(`<div class="gcode-line${e}" data-line="${t+1}">${t+1}</div>`)}h.innerHTML=u.join("");const m=[];for(let t=c;t<d;t++){const e=this.gcodeCurrentHighlight===t+1?" highlight":"",s=this.syntaxHighlightGCode(n[t]);m.push(`<div class="gcode-line${e}" data-line="${t+1}">${s||"&nbsp;"}</div>`)}r.innerHTML=m.join("")};this.gcodeRenderVisibleLines=c;let d=!1;s.addEventListener("scroll",()=>{d||(requestAnimationFrame(()=>{c(),d=!1}),d=!0)},{passive:!0}),c(!0),requestAnimationFrame(()=>c(!0)),setTimeout(()=>c(!0),100),s.addEventListener("click",t=>{const e=t.target.closest(".gcode-line");if(!e)return;const s=parseInt(e.dataset.line);if(!s)return;const n=this.segments.findIndex(t=>t.lineNum>=s);-1!==n&&(this.animator.currentIndex=n,this.animator.onUpdate(n),"2d"===this.currentView?this.renderer2d.render():this.renderer3d.render(),this.highlightGCodeLine(s))})}syntaxHighlightGCode(t){let e=t,s=[];const n=t.indexOf(";"),i=t.indexOf("("),o=t.indexOf(")");return-1!==i&&-1!==o&&o>i?(s.push({text:t.substring(0,i),isComment:!1}),s.push({text:t.substring(i,o+1),isComment:!0}),s.push({text:t.substring(o+1),isComment:!1})):-1!==n?(s.push({text:t.substring(0,n),isComment:!1}),s.push({text:t.substring(n),isComment:!0})):s.push({text:t,isComment:!1}),e=s.map(t=>{if(t.isComment)return`<span class="gcode-comment">${this.escapeHtml(t.text)}</span>`;let e=t.text;return e=e.replace(/\$([A-Za-z0-9\/=]+)/g,'<span class="gcode-system">$$1</span>'),e=e.replace(/\b([GM])(\d+(\.\d+)?)/gi,(t,e,s)=>`<span class="${"G"===e.toUpperCase()?"gcode-g-code":"gcode-m-code"}">${e}${s}</span>`),e=e.replace(/\b(T)(\d+)/gi,'<span class="gcode-t-code">$1$2</span>'),e=e.replace(/\b(S)(\d+(\.\d+)?)/gi,'<span class="gcode-s-code">$1$2</span>'),e=e.replace(/([X])([-+]?\d+(\.\d+)?)/gi,'<span class="gcode-x-axis">$1$2</span>'),e=e.replace(/([Y])([-+]?\d+(\.\d+)?)/gi,'<span class="gcode-y-axis">$1$2</span>'),e=e.replace(/([Z])([-+]?\d+(\.\d+)?)/gi,'<span class="gcode-z-axis">$1$2</span>'),e=e.replace(/([ABCIJK])([-+]?\d+(\.\d+)?)/gi,'<span class="gcode-coordinate">$1$2</span>'),e=e.replace(/([F])(\d+(\.\d+)?)/gi,'<span class="gcode-f-code">$1$2</span>'),e}).join(""),e}escapeHtml(t){const e=document.createElement("div");return e.textContent=t,e.innerHTML}highlightGCodeLine(t){const e=document.getElementById("gcode-container");if(t<1||!e)return;this.gcodeCurrentHighlight=t;const s=e.scrollTop,n=e.clientHeight||600,i=(t-1)*this.gcodeLineHeight,o=i+this.gcodeLineHeight,a=.2*n;if(i>=s+a&&o<=s+n-a&&this.gcodeRenderVisibleLines)this.gcodeRenderVisibleLines(!0);else{const t=i-n/2+this.gcodeLineHeight/2;e.scrollTop=Math.max(0,t)}}updateLayerFilter(){const t=document.getElementById("layer-min"),e=document.getElementById("layer-max"),s=t.value?parseFloat(t.value):-1/0,n=e.value?parseFloat(e.value):1/0;this.renderer2d.setLayerFilter(s,n),this.renderer3d.setLayerFilter(s,n)}setZoom(t){if("2d"===this.currentView)this.camera.zoom2d=t,this.camera.targetZoom2d=t;else{const e=100;this.camera.orthoScale=e/t}}toggleView(){"2d"===this.currentView?(this.currentView="3d",this.canvas2d.classList.add("hidden"),this.canvas3d.classList.remove("hidden"),this.canvas3dOverlay.classList.remove("hidden"),document.getElementById("btn-toggle-view").textContent="2D View"):(this.currentView="2d",this.canvas3d.classList.add("hidden"),this.canvas3dOverlay.classList.add("hidden"),this.canvas2d.classList.remove("hidden"),document.getElementById("btn-toggle-view").textContent="3D View"),this.updateZoomSlider()}updateZoomSlider(){const t=document.getElementById("zoom-slider"),e=document.getElementById("zoom-value");let s;s="2d"===this.currentView?this.camera.zoom2d/this.camera.initialZoom2d:this.camera.initialOrthoScale/this.camera.orthoScale,t.value=s,e.textContent=Math.round(100*s)+"%"}togglePlayback(){this.animator.getIsPlaying()?this.animator.pause():this.animator.play()}switchMobileTab(t){document.querySelectorAll(".mobile-tab-button").forEach(e=>{e.classList.toggle("active",e.getAttribute("data-tab")===t)}),document.querySelectorAll(".mobile-tab-content").forEach(e=>{e.classList.toggle("active",e.getAttribute("data-tab-content")===t)})}startRenderLoop(){const t=()=>{this.pollSpaceMouse(),this.camera.update(),"2d"===this.currentView?this.renderer2d.render():this.renderer3d.render(),requestAnimationFrame(t)};t()}}window.addEventListener("DOMContentLoaded",()=>{document.getElementById("text-to-gcode")||new Controller});class FontCreatorController{constructor(){this.canvas=null,this.ctx=null,this.font={},this.kerning={},this.currentChar=null,this.currentFontId=null,this.charArray="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789`~!@#$%^&*()-_=+[{]}\\|;:'\",<.>/? ‚Äò‚Äô‚Äú‚Äù‚Äî".split(""),this.strokes=[],this.showGuides=!0,this.currentStroke=null,this.isDrawing=!1,this.history=[],this.historyIndex=-1,this.generatedGCode="",this.gridSize=30}setupCanvas(){this.canvas=document.getElementById("drawing-canvas"),this.ctx=this.canvas.getContext("2d");const t=this.canvas.parentElement,e=t.clientWidth-40,s=t.clientHeight-40,n=Math.min(e,s,600);let i;this.canvas.width=n,this.canvas.height=n,this.canvas.style.width=n+"px",this.canvas.style.height=n+"px",this.gridSize=n/20,this.canvas.addEventListener("mousedown",t=>this.startDrawing(t)),this.canvas.addEventListener("mousemove",t=>this.draw(t)),this.canvas.addEventListener("mouseup",()=>this.stopDrawing()),this.canvas.addEventListener("mouseleave",()=>this.stopDrawing()),this.canvas.addEventListener("touchstart",t=>{t.preventDefault(),this.startDrawing(t.touches[0])},{passive:!1}),this.canvas.addEventListener("touchmove",t=>{t.preventDefault(),this.draw(t.touches[0])},{passive:!1}),this.canvas.addEventListener("touchend",t=>{t.preventDefault(),this.stopDrawing()},{passive:!1}),window.addEventListener("resize",()=>{clearTimeout(i),i=setTimeout(()=>{this.setupCanvas(),this.render()},100)})}setupCharacterSet(){const t=document.getElementById("char-grid");t.innerHTML="",this.charArray.forEach(e=>{const s=document.createElement("button");s.className="char-button",s.textContent=" "===e?"":e,s.dataset.char=e,s.onclick=()=>this.selectCharacter(e),t.appendChild(s)})}setupFontCreatorControls(){document.getElementById("clear-char").onclick=()=>this.clearCharacter(),document.getElementById("prev-char").onclick=()=>this.navigateCharacter(-1),document.getElementById("next-char").onclick=()=>this.navigateCharacter(1),document.getElementById("undo").onclick=()=>this.undo(),document.getElementById("redo").onclick=()=>this.redo(),document.getElementById("new-font").onclick=()=>this.newFont(),document.getElementById("save-font").onclick=()=>this.saveFont(),document.getElementById("preview-font").onclick=()=>this.previewFont(),document.getElementById("delete-font").onclick=()=>this.deleteFont(),document.getElementById("import-font-btn").onclick=()=>document.getElementById("import-font").click(),document.getElementById("export-font").onclick=()=>this.exportFont(),document.getElementById("char-set-header").onclick=()=>{const t=document.getElementById("char-set-header"),e=document.getElementById("char-grid");t.classList.toggle("collapsed"),e.classList.toggle("collapsed")},document.getElementById("font-settings-header").onclick=()=>{const t=document.getElementById("font-settings-header"),e=document.getElementById("font-settings-content");t.classList.toggle("collapsed"),e.classList.toggle("collapsed")},document.getElementById("kerning-header").onclick=()=>{const t=document.getElementById("kerning-header"),e=document.getElementById("kerning-content");t.classList.toggle("collapsed"),e.classList.toggle("collapsed")},document.getElementById("font-selector-editor").onchange=t=>{const e=t.target.value;if(!e)return;const s=JSON.parse(localStorage.getItem("gcodeFonts")||"{}")[e];if(s){const t=this.currentChar;this.strokes=[],this.history=[],this.historyIndex=-1,this.loadFontData(s),localStorage.setItem("currentFontId",e),t&&this.font[t]?(this.currentChar=t,this.strokes=this.font[t].strokes?JSON.parse(JSON.stringify(this.font[t].strokes)):[],this.history=[JSON.parse(JSON.stringify(this.strokes))],this.historyIndex=0,document.getElementById("current-char").textContent=" "===t?"(space)":t,document.querySelectorAll(".char-button").forEach(e=>{e.classList.toggle("active",e.dataset.char===t)}),this.render(),this.updateStatus(`Loaded font: ${s.name} - Drawing: ${" "===t?"SPACE":t}`)):t?(this.currentChar=t,this.render(),document.getElementById("current-char").textContent=t,document.querySelectorAll(".char-button").forEach(e=>{e.classList.toggle("active",e.dataset.char===t)}),this.updateStatus(`Loaded font: ${s.name} - Character '${t}' not defined in this font`)):(this.render(),this.updateStatus(`Loaded font: ${s.name}`))}},document.getElementById("import-font").onchange=t=>this.importFont(t),document.getElementById("toggle-guides").onclick=()=>this.toggleGuides(),document.getElementById("add-kerning").onclick=()=>this.addKerning(),document.getElementById("close-preview").onclick=()=>{document.getElementById("font-preview-modal").style.display="none"},document.getElementById("font-preview-modal").onclick=t=>{"font-preview-modal"===t.target.id&&(document.getElementById("font-preview-modal").style.display="none")}}setupTextToGCodeControls(){document.getElementById("preview-gcode-btn").onclick=()=>{this.generateGCode(),document.querySelector('.tab-button[data-tab="gcode-preview"]').click()},document.getElementById("export-image").onclick=()=>this.exportImage(),document.getElementById("font-selector").onchange=()=>this.loadSelectedFont()}getCanvasCoords(t){const e=this.canvas.getBoundingClientRect();return{x:t.clientX-e.left,y:t.clientY-e.top}}startDrawing(t){if(!this.currentChar)return void this.updateStatus("Please select a character first");this.isDrawing=!0;const e=this.getCanvasCoords(t);this.currentStroke=[{x:e.x,y:e.y}]}draw(t){if(!this.isDrawing||!this.currentStroke)return;const e=this.getCanvasCoords(t);this.currentStroke.push({x:e.x,y:e.y}),this.render(),this.ctx.strokeStyle="#4CAF50",this.ctx.lineWidth=2,this.ctx.lineCap="round",this.ctx.lineJoin="round",this.ctx.beginPath(),this.ctx.moveTo(this.currentStroke[0].x,this.currentStroke[0].y);for(let t=1;t<this.currentStroke.length;t++)this.ctx.lineTo(this.currentStroke[t].x,this.currentStroke[t].y);this.ctx.stroke()}stopDrawing(){if(this.isDrawing&&this.currentStroke){if(this.isDrawing=!1,this.currentStroke.length>1){const t=parseFloat(document.getElementById("simplify-tolerance").value);this.strokes.push(this.simplifyPath(this.currentStroke,t)),this.saveToHistory(),this.updateCharacterInFont()}this.currentStroke=null,this.render()}}simplifyPath(t,e){return t.length<3?t:this.douglasPeucker(t,e)}douglasPeucker(t,e){if(t.length<3)return t;let s=0,n=0;const i=t[0],o=t[t.length-1];for(let e=1;e<t.length-1;e++){const a=this.calculateDistanceToLine(t[e],i,o);a>s&&(s=a,n=e)}if(s>e){const s=this.douglasPeucker(t.slice(0,n+1),e),i=this.douglasPeucker(t.slice(n),e);return s.slice(0,-1).concat(i)}return[i,o]}calculateDistanceToLine(t,e,s){const n=s.x-e.x,i=s.y-e.y,o=Math.sqrt(n*n+i*i);if(0===o)return Math.sqrt((t.x-e.x)**2+(t.y-e.y)**2);const a=((t.x-e.x)*n+(t.y-e.y)*i)/(o*o),r=e.x+a*n,h=e.y+a*i;return Math.sqrt((t.x-r)**2+(t.y-h)**2)}detectArcs(t){if(t.length<5)return[{type:"line",points:t}];const e=[];let s=0;for(;s<t.length;){const n=this.fitArc(t,s);if(n&&n.endIndex-s>=3)e.push({type:"arc",start:t[s],end:t[n.endIndex],center:n.center,radius:n.radius,clockwise:n.clockwise}),s=n.endIndex;else{const n=Math.min(s+1,t.length-1);e.push({type:"line",points:t.slice(s,n+1)}),s=s===n?s+1:n}}return e}fitArc(t,e){const s=parseFloat(document.getElementById("arc-tolerance").value);for(let n=Math.min(e+20,t.length)-1;n>e+2;n--){const i=t.slice(e,n+1),o=this.fitCircle(i);if(!o)continue;if(o.r<.5||o.r>500)continue;let a=!0,r=0;for(const t of i){const e=Math.sqrt((t.x-o.cx)**2+(t.y-o.cy)**2),n=Math.abs(e-o.r);if(r=Math.max(r,n),n>s){a=!1;break}}if(a){const t=this.isClockwise(i,o);return console.log(`Arc fitted: radius=${o.r.toFixed(2)}, maxError=${r.toFixed(3)}, CW=${t}`),{endIndex:n,center:{x:o.cx,y:o.cy},radius:o.r,clockwise:t}}}return null}fitCircle(t){if(t.length<3)return null;let e=0,s=0,n=0,i=0,o=0,a=0,r=0,h=0,l=0;for(const c of t){const t=c.x,d=c.y,u=t*t,m=d*d;e+=t,s+=d,n+=u,i+=m,o+=t*d,a+=u*t,r+=m*d,h+=u*d,l+=t*m}const c=t.length,d=c*n-e*e,u=c*o-e*s,m=c*i-s*s,g=.5*(c*l-e*i+c*a-e*n),x=.5*(c*r-s*i+c*h-s*n),p=d*m-u*u;if(Math.abs(p)<1e-10)return null;const f=(g*m-u*x)/p,y=(d*x-u*g)/p;let v=0;for(const e of t)v+=Math.sqrt((e.x-f)**2+(e.y-y)**2);return{cx:f,cy:y,r:v/c}}isClockwise(t,e){if(t.length<2)return!1;const s=t[0],n=t[t.length-1],i=t[Math.floor(t.length/2)],o=Math.atan2(s.y-e.cy,s.x-e.cx);let a=Math.atan2(i.y-e.cy,i.x-e.cx)-o,r=Math.atan2(n.y-e.cy,n.x-e.cx)-o;for(;a>Math.PI;)a-=2*Math.PI;for(;a<-Math.PI;)a+=2*Math.PI;for(;r>Math.PI;)r-=2*Math.PI;for(;r<-Math.PI;)r+=2*Math.PI;return a<0}navigateCharacter(t){if(!this.currentChar)return void this.selectCharacter(this.charArray[0]);const e=this.charArray.indexOf(this.currentChar);if(-1===e)return;let s=e+t;s<0&&(s=this.charArray.length-1),s>=this.charArray.length&&(s=0),this.selectCharacter(this.charArray[s])}selectCharacter(t){this.currentChar&&this.strokes.length>0&&this.updateCharacterInFont(),this.currentChar=t,this.strokes=this.font[t]?.strokes?JSON.parse(JSON.stringify(this.font[t].strokes)):[],this.history=[JSON.parse(JSON.stringify(this.strokes))],this.historyIndex=0,document.getElementById("current-char").textContent=" "===t?"(space)":t,document.querySelectorAll(".char-button").forEach(e=>{e.classList.toggle("active",e.dataset.char===t)}),this.render(),this.updateStatus(`Drawing: ${" "===t?"SPACE":t}`)}updateCharacterInFont(){if(!this.currentChar)return;const t=this.calculateBounds(this.strokes);this.font[this.currentChar]={strokes:JSON.parse(JSON.stringify(this.strokes)),bounds:t};const e=Array.from(document.querySelectorAll(".char-button")).find(t=>t.dataset.char===this.currentChar);e&&e.classList.add("defined"),this.saveToLocalStorage()}calculateBounds(t){if(!t||0===t.length)return{minX:0,minY:0,maxX:0,maxY:0,width:0,height:0};let e=1/0,s=1/0,n=-1/0,i=-1/0;return t.forEach(t=>{t&&0!==t.length&&t.forEach(t=>{e=Math.min(e,t.x),s=Math.min(s,t.y),n=Math.max(n,t.x),i=Math.max(i,t.y)})}),e===1/0||s===1/0?{minX:0,minY:0,maxX:0,maxY:0,width:0,height:0}:{minX:e,minY:s,maxX:n,maxY:i,width:n-e,height:i-s}}render(){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.ctx.strokeStyle="#e0e0e0",this.ctx.lineWidth=1;for(let t=0;t<=20;t++){const e=t*this.gridSize;this.ctx.beginPath(),this.ctx.moveTo(e,0),this.ctx.lineTo(e,this.canvas.height),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.moveTo(0,e),this.ctx.lineTo(this.canvas.width,e),this.ctx.stroke()}if(this.showGuides){const t=.75*this.canvas.height,e=.25*this.canvas.height,s=.45*this.canvas.height,n=.85*this.canvas.height;this.ctx.strokeStyle="rgba(255, 0, 0, 0.5)",this.ctx.lineWidth=2,this.ctx.setLineDash([5,5]),this.ctx.beginPath(),this.ctx.moveTo(0,t),this.ctx.lineTo(this.canvas.width,t),this.ctx.stroke(),this.ctx.strokeStyle="rgba(0, 0, 255, 0.5)",this.ctx.beginPath(),this.ctx.moveTo(0,e),this.ctx.lineTo(this.canvas.width,e),this.ctx.stroke(),this.ctx.strokeStyle="rgba(0, 255, 0, 0.5)",this.ctx.beginPath(),this.ctx.moveTo(0,s),this.ctx.lineTo(this.canvas.width,s),this.ctx.stroke(),this.ctx.strokeStyle="rgba(255, 165, 0, 0.5)",this.ctx.beginPath(),this.ctx.moveTo(0,n),this.ctx.lineTo(this.canvas.width,n),this.ctx.stroke(),this.ctx.setLineDash([]),this.ctx.fillStyle="rgba(0, 0, 0, 0.7)",this.ctx.font="bold 14px sans-serif",this.ctx.fillText("Cap",5,e-5),this.ctx.fillText("X-height",5,s-5),this.ctx.fillText("Baseline",5,t-5),this.ctx.fillText("Descender",5,n+15)}this.ctx.strokeStyle="#333333",this.ctx.lineWidth=2,this.ctx.lineCap="round",this.ctx.lineJoin="round",this.strokes.forEach((t,e)=>{if(!(t.length<2)){this.ctx.beginPath(),this.ctx.moveTo(t[0].x,t[0].y);for(let e=1;e<t.length;e++)this.ctx.lineTo(t[e].x,t[e].y);this.ctx.stroke(),this.ctx.fillStyle="#4CAF50",this.ctx.beginPath(),this.ctx.arc(t[0].x,t[0].y,4,0,2*Math.PI),this.ctx.fill(),this.ctx.fillStyle="#4CAF50",this.ctx.font="12px sans-serif",this.ctx.fillText(e+1,t[0].x+8,t[0].y-8),this.ctx.fillStyle="#f44336",this.ctx.beginPath(),this.ctx.arc(t[t.length-1].x,t[t.length-1].y,3,0,2*Math.PI),this.ctx.fill()}})}clearCharacter(){if(this.strokes=[],this.history=[],this.historyIndex=-1,this.currentChar){delete this.font[this.currentChar];const t=Array.from(document.querySelectorAll(".char-button")).find(t=>t.dataset.char===this.currentChar);t&&t.classList.remove("defined")}this.render(),this.saveToLocalStorage()}clearCanvas(){this.strokes=[],this.saveToHistory(),this.render()}saveToHistory(){this.history=this.history.slice(0,this.historyIndex+1),this.history.push(JSON.parse(JSON.stringify(this.strokes))),this.historyIndex++,this.history.length>50&&(this.history.shift(),this.historyIndex--)}undo(){this.historyIndex>0&&(this.historyIndex--,this.strokes=JSON.parse(JSON.stringify(this.history[this.historyIndex])),this.updateCharacterInFont(),this.render())}redo(){this.historyIndex<this.history.length-1&&(this.historyIndex++,this.strokes=JSON.parse(JSON.stringify(this.history[this.historyIndex])),this.updateCharacterInFont(),this.render())}saveFont(){this.updateCharacterInFont(),this.saveToLocalStorage(),this.updateStatus("Font saved!"),setTimeout(()=>this.updateStatus("Ready"),2e3)}newFont(){Object.keys(this.font).length>0&&!confirm("Starting a new font will clear your current work. Continue?")||(this.font={},this.kerning={},this.currentFontId="font_"+Date.now(),document.getElementById("font-name").value="New Font",this.strokes=[],this.currentChar=null,this.history=[],this.historyIndex=-1,document.querySelectorAll(".char-button").forEach(t=>t.classList.remove("defined","active")),document.getElementById("current-char").textContent="-",this.updateKerningList(),this.render(),this.saveToLocalStorage(),this.updateFontSelector(),this.updateStatus("New font created"))}deleteFont(){if(!this.currentFontId)return void alert("No font to delete");const t=document.getElementById("font-name").value;if(!confirm(`Delete font "${t}"? This cannot be undone.`))return;const e=JSON.parse(localStorage.getItem("gcodeFonts")||"{}");if(delete e[this.currentFontId],localStorage.setItem("gcodeFonts",JSON.stringify(e)),Object.keys(e).length>0){const t=Object.values(e)[0];this.loadFontData(t),localStorage.setItem("currentFontId",t.id)}else this.newFont();this.updateFontSelector(),this.updateStatus(`Font "${t}" deleted`)}loadFontFromList(){const t=JSON.parse(localStorage.getItem("gcodeFonts")||"{}"),e=Object.values(t).sort((t,e)=>t.name.localeCompare(e.name));if(0===e.length)return void alert("No saved fonts found. Create a new font or import one.");let s="Select a font to load:\n\n";e.forEach((t,e)=>{s+=`${e+1}. ${t.name}\n`}),s+="\nEnter the number of the font to load:";const n=prompt(s);if(!n)return;const i=parseInt(n)-1;if(i>=0&&i<e.length){const t=e[i];this.loadFontData(t),localStorage.setItem("currentFontId",t.id),this.updateStatus(`Loaded font: ${t.name}`)}else alert("Invalid selection")}saveToLocalStorage(){const t=JSON.parse(localStorage.getItem("gcodeFonts")||"{}");this.currentFontId||(this.currentFontId="font_"+Date.now()),t[this.currentFontId]={id:this.currentFontId,name:document.getElementById("font-name").value,font:this.font,kerning:this.kerning,lastModified:(new Date).toISOString()},localStorage.setItem("gcodeFonts",JSON.stringify(t)),localStorage.setItem("currentFontId",this.currentFontId),this.updateFontSelector()}loadFromLocalStorage(){const t=localStorage.getItem("currentFontId"),e=JSON.parse(localStorage.getItem("gcodeFonts")||"{}");if(t&&e[t])this.loadFontData(e[t]);else if(Object.keys(e).length>0){const t=Object.values(e)[0];this.loadFontData(t)}else this.newFont();this.updateFontSelector()}loadFontData(t){this.currentFontId=t.id,this.font=t.font||{},this.kerning=t.kerning||{},document.getElementById("font-name").value=t.name||"Custom Font",document.querySelectorAll(".char-button").forEach(t=>t.classList.remove("defined")),Object.keys(this.font).forEach(t=>{const e=Array.from(document.querySelectorAll(".char-button")).find(e=>e.dataset.char===t);e&&e.classList.add("defined")}),this.updateKerningList()}updateFontSelector(){const t=document.getElementById("font-selector-editor"),e=document.getElementById("font-selector"),s=JSON.parse(localStorage.getItem("gcodeFonts")||"{}"),n=localStorage.getItem("currentFontId");t&&(t.innerHTML='<option value="">Select a font...</option>',Object.values(s).sort((t,e)=>t.name.localeCompare(e.name)).forEach(e=>{const s=document.createElement("option");s.value=e.id,s.textContent=e.name,e.id===n&&(s.selected=!0),t.appendChild(s)})),e&&(e.innerHTML='<option value="">Select a font...</option>',Object.values(s).sort((t,e)=>t.name.localeCompare(e.name)).forEach(t=>{const s=document.createElement("option");s.value=t.id,s.textContent=t.name,t.id===n&&(s.selected=!0),e.appendChild(s)}))}loadSelectedFont(){const t=document.getElementById("font-selector").value;if(!t)return void this.updateStatus("Please select a font");const e=JSON.parse(localStorage.getItem("gcodeFonts")||"{}");e[t]&&(this.loadFontData(e[t]),this.updateStatus(`Loaded font: ${e[t].name}`))}exportFont(){const t={name:document.getElementById("font-name").value,font:this.font,kerning:this.kerning,version:"1.1"},e=new Blob([JSON.stringify(t,null,2)],{type:"application/json"}),s=URL.createObjectURL(e),n=document.createElement("a");n.href=s,n.download=`${t.name.replace(/\s+/g,"_")}.json`,n.click(),URL.revokeObjectURL(s)}previewFont(){const t=document.getElementById("font-preview-modal"),e=document.getElementById("preview-canvas"),s=e.getContext("2d"),n=Object.keys(this.font).sort();if(0===n.length)return void alert("No characters defined in font");const i=Math.floor((e.width-40)/100),o=Math.ceil(n.length/i);e.height=Math.min(2400,Math.max(800,20+120*o+20)),s.fillStyle=getComputedStyle(document.documentElement).getPropertyValue("--bg-color"),s.fillRect(0,0,e.width,e.height),s.strokeStyle=getComputedStyle(document.documentElement).getPropertyValue("--text-color"),s.fillStyle=getComputedStyle(document.documentElement).getPropertyValue("--text-color"),s.lineWidth=2,s.lineCap="round",s.lineJoin="round",s.font="12px monospace",s.textAlign="center",n.forEach((t,e)=>{const n=e%i,o=Math.floor(e/i),a=20+100*n,r=20+120*o;s.fillText(t,a+40,r+80+15);const h=this.font[t];if(!h||!h.strokes)return;const l=80/this.canvas.height,c=80/this.canvas.height;h.strokes.forEach(t=>{t.length<2||(s.beginPath(),t.forEach((t,e)=>{const n=a+t.x*l,i=r+t.y*c;0===e?s.moveTo(n,i):s.lineTo(n,i)}),s.stroke())})}),t.style.display="flex"}importFont(t){const e=t.target.files[0];if(!e)return;const s=new FileReader;s.onload=t=>{try{const e=JSON.parse(t.target.result),s=JSON.parse(localStorage.getItem("gcodeFonts")||"{}"),n=e.id;if(n&&s[n]){const t=s[n].name,i=e.name||"Imported Font";confirm(`A font with ID "${n}" already exists (${t}).\n\nReplace it with "${i}"?`)?this.currentFontId=n:this.currentFontId="font_"+Date.now()}else this.currentFontId=n||"font_"+Date.now();this.font=e.font||{},this.kerning=e.kerning||{},document.getElementById("font-name").value=e.name||"Imported Font",document.querySelectorAll(".char-button").forEach(t=>t.classList.remove("defined")),Object.keys(this.font).forEach(t=>{const e=Array.from(document.querySelectorAll(".char-button")).find(e=>e.dataset.char===t);e&&e.classList.add("defined")}),this.updateKerningList(),this.saveToLocalStorage(),this.updateStatus(`Font loaded: ${e.name||"Imported Font"}`)}catch(t){alert("Error loading font: "+t.message)}},s.readAsText(e)}generateGCode(){const t=document.getElementById("text-input").value;let e=parseFloat(document.getElementById("output-size").value);const s=parseFloat(document.getElementById("char-spacing").value),n=parseFloat(document.getElementById("space-width").value),i=parseFloat(document.getElementById("line-spacing").value),o=parseFloat(document.getElementById("max-width").value),a=parseFloat(document.getElementById("max-height").value),r=document.getElementById("auto-fit").checked,h=parseFloat(document.getElementById("feed-rate").value),l=parseFloat(document.getElementById("plunge-rate").value),c=parseFloat(document.getElementById("safe-z").value),d=parseFloat(document.getElementById("engrave-depth").value),u=this.canvas.height;let m=e/u,g=e+i,x=[],p="";const f=t=>{t!==p&&(x.push(t),p=t)};x.push("; GCode Font Creator Output"),x.push(`; Font: ${document.getElementById("font-name").value}`);const y=t.split("\n");1===y.length?x.push(`; Text: ${t}`):(x.push("; Text:"),y.forEach(t=>x.push(`; ${t}`))),x.push(`; Generated: ${(new Date).toISOString()}`),x.push(""),x.push("G21 ; mm mode"),x.push("G90 ; Absolute positioning"),x.push("G17 ; XY plane"),x.push(`G0 Z${c} F${l} ; Move to safe Z`),p=`G0 Z${c} F${l} ; Move to safe Z`,x.push("");const v=t.split("\n");let b=[];if(o>0?v.forEach(t=>{const i=t.split(" ");let a="",r=0;i.forEach((t,i)=>{let h=0;for(let n=0;n<t.length;n++){const i=t[n],o=this.font[i];h+=o?o.bounds.width*m+s:.5*e+s}const l=n+s;a.length>0&&r+l+h>o?(b.push(a),a=t,r=h):a.length>0?(a+=" "+t,r+=l+h):(a=t,r=h)}),b.push(a)}):b.push(...v),r&&(o>0||a>0)){const t=parseFloat(document.getElementById("max-text-size").value),r=t=>{const e=t/u,a=t+i,r=[];o>0?v.forEach(i=>{const a=i.split(" ");let h="",l=0;a.forEach(i=>{let a=0;for(let n=0;n<i.length;n++){const o=i[n],r=this.font[o];a+=r?r.bounds.width*e+s:.5*t+s}const c=n+s;h.length>0&&l+c+a>o?(r.push(h),h=i,l=a):h.length>0?(h+=" "+i,l+=c+a):(h=i,l=a)}),r.push(h)}):r.push(...v);let h=0;r.forEach(i=>{let o=0;for(let a=0;a<i.length;a++){const r=i[a],h=this.font[r];o+=h?h.bounds.width*e+s:(" "===r?n:.5*t)+s}h=Math.max(h,o)});let l=t;for(let e=1;e<r.length;e++)l+=0===r[e].length?.5*t:a;return{width:h,height:l,wrappedLines:r}};let h=e,l=b;for(let s=e;s<=t;s+=.5){const t=r(s),e=o<=0||t.width<=o,n=a<=0||t.height<=a;if(!e||!n)break;h=s,l=t.wrappedLines}e=h,b=l,m=e/u,g=e+i}let C=e;for(let t=1;t<b.length;t++)C+=0===b[t].length?.5*e:g;let E=C;b.forEach((t,i)=>{let o=0;x.push(""),x.push(`; Line ${i+1}: "${t}"`);for(let i=0;i<t.length;i++){const a=t[i],r=this.font[a];if(!r){o+=(" "===a?n:.5*e)+s;continue}x.push(`; Character: '${a}'`);const u=r.bounds;let g=!0;r.strokes.forEach(t=>{const e=this.detectArcs(t);console.log(`Character '${a}' segments:`,e.map(t=>t.type));let s=!0;e.forEach(t=>{if("arc"===t.type){const e=(t.start.x-u.minX)*m+o,n=E-t.start.y*m,i=(t.end.x-u.minX)*m+o,a=E-t.end.y*m,r=(t.center.x-u.minX)*m+o,x=E-t.center.y*m;s&&(g||f(`G0 Z${c}`),f(`G0 X${e.toFixed(3)} Y${n.toFixed(3)} F${h}`),f(`G1 Z${d} F${l}`),s=!1,g=!1);const p=r-e,y=x-n,v=Math.sqrt(p*p+y*y),b=Math.sqrt((i-r)**2+(a-x)**2);Math.abs(v-b)>.01&&console.warn(`Arc validation failed: start radius ${v.toFixed(3)} != end radius ${b.toFixed(3)}`);const C=t.clockwise?"G3":"G2";f(`${C} X${i.toFixed(3)} Y${a.toFixed(3)} I${p.toFixed(3)} J${y.toFixed(3)} F${h}`)}else t.points.forEach((t,e)=>{const n=(t.x-u.minX)*m+o,i=E-t.y*m;s&&0===e?(g||f(`G0 Z${c}`),f(`G0 X${n.toFixed(3)} Y${i.toFixed(3)} F${h}`),f(`G1 Z${d} F${l}`),s=!1,g=!1):f(`G1 X${n.toFixed(3)} Y${i.toFixed(3)} F${h}`)})}),f(`G0 Z${c}`),g=!0});let p=s;if(i<t.length-1){const e=t[i+1],s=a+e;void 0!==this.kerning[s]&&(p+=this.kerning[s])}o+=u.width*m+p}const a=0===t.length?.5*e:g;E-=a}),x.push(""),f(`G0 Z${c} ; Return to safe Z`),f("G0 X0 Y0 ; Return to origin"),x.push("M2 ; End program"),this.generatedGCode=x.join("\n"),this.updateStatus("GCode generated!")}exportImage(){const t=document.getElementById("text-input").value;let e=parseFloat(document.getElementById("output-size").value);const s=parseFloat(document.getElementById("char-spacing").value),n=parseFloat(document.getElementById("space-width").value),i=parseFloat(document.getElementById("line-spacing").value),o=parseFloat(document.getElementById("max-width").value),a=parseFloat(document.getElementById("max-height").value),r=document.getElementById("auto-fit").checked;if(!t)return void alert("Please enter text to export");const h=this.canvas.height;let l=e/h,c=e+i;const d=t.split("\n");let u=[];if(o>0?d.forEach(t=>{const i=t.split(" ");let a="",r=0;i.forEach((t,i)=>{let h=0;for(let n=0;n<t.length;n++){const i=t[n],o=this.font[i];h+=o?o.bounds.width*l+s:.5*e+s}const c=n+s;a.length>0&&r+c+h>o?(u.push(a),a=t,r=h):a.length>0?(a+=" "+t,r+=c+h):(a=t,r=h)}),u.push(a)}):u.push(...d),r&&(o>0||a>0)){const t=parseFloat(document.getElementById("max-text-size").value),r=t=>{const e=t/h,a=t+i,r=[];o>0?d.forEach(i=>{const a=i.split(" ");let h="",l=0;a.forEach(i=>{let a=0;for(let n=0;n<i.length;n++){const o=i[n],r=this.font[o];a+=r?r.bounds.width*e+s:.5*t+s}const c=n+s;h.length>0&&l+c+a>o?(r.push(h),h=i,l=a):h.length>0?(h+=" "+i,l+=c+a):(h=i,l=a)}),r.push(h)}):r.push(...d);let l=0;r.forEach(i=>{let o=0;for(let a=0;a<i.length;a++){const r=i[a],h=this.font[r];o+=h?h.bounds.width*e+s:(" "===r?n:.5*t)+s}l=Math.max(l,o)});let c=t;for(let e=1;e<r.length;e++)c+=0===r[e].length?.5*t:a;return{width:l,height:c,wrappedLines:r}};let m=e,g=u;for(let s=e;s<=t;s+=.5){const t=r(s),e=o<=0||t.width<=o,n=a<=0||t.height<=a;if(!e||!n)break;m=s,g=t.wrappedLines}e=m,u=g,l=e/h,c=e+i}let m=0;u.forEach(t=>{let i=0;for(let o=0;o<t.length;o++){const a=t[o],r=this.font[a];i+=r?r.bounds.width*l+s:(" "===a?n:.5*e)+s}m=Math.max(m,i)});let g=e;for(let t=1;t<u.length;t++)g+=0===u[t].length?.5*e:c;const x=Math.ceil(m+40),p=Math.ceil(g+40),f=document.createElement("canvas");f.width=3*x,f.height=3*p;const y=f.getContext("2d");y.scale(3,3),y.fillStyle="#FFFFFF",y.fillRect(0,0,x,p),y.strokeStyle="#000000",y.lineWidth=.5,y.lineCap="round",y.lineJoin="round",y.imageSmoothingEnabled=!0,y.imageSmoothingQuality="high";let v=20;u.forEach(t=>{let i=20;for(let o=0;o<t.length;o++){const a=t[o],r=this.font[a];if(!r){i+=(" "===a?n:.5*e)+s;continue}const h=r.bounds;r.strokes.forEach(t=>{if(t.length<2)return;y.beginPath();const e=t[0],s=(e.x-h.minX)*l+i,n=e.y*l+v;y.moveTo(s,n);for(let e=1;e<t.length;e++){const s=(t[e].x-h.minX)*l+i,n=t[e].y*l+v;y.lineTo(s,n)}y.stroke()}),i+=h.width*l+s}const o=0===t.length?.5*e:c;v+=o}),f.toBlob(t=>{const e=URL.createObjectURL(t),s=document.createElement("a");s.href=e;const n=document.getElementById("font-name").value.replace(/\s+/g,"_");s.download=`${n}_text.png`,s.click(),URL.revokeObjectURL(e)}),this.updateStatus("Image exported!")}downloadGCode(){if(!this.generatedGCode)return void alert("Please generate GCode first");const t=new Blob([this.generatedGCode],{type:"text/plain"}),e=URL.createObjectURL(t),s=document.createElement("a");s.href=e,s.download="font_output.gcode",s.click(),URL.revokeObjectURL(e)}toggleGuides(){this.showGuides=!this.showGuides,this.render()}addKerning(){const t=document.getElementById("kerning-pair").value,e=parseFloat(document.getElementById("kerning-value").value);2===t.length?(this.kerning[t]=e,this.updateKerningList(),this.saveToLocalStorage(),document.getElementById("kerning-pair").value=""):alert("Please enter exactly 2 characters")}updateKerningList(){const t=document.getElementById("kerning-list");t.innerHTML="",Object.entries(this.kerning).forEach(([e,s])=>{const n=document.createElement("div");n.style.cssText="display: flex; justify-content: space-between; align-items: center; padding: 5px; border-bottom: 1px solid var(--border-color);",n.innerHTML=`\n <span><strong>${e}</strong>: ${s}mm</span>\n <button onclick="fontCreatorController.removeKerning('${e}')" style="padding: 2px 8px; font-size: 11px;">‚úñ</button>\n `,t.appendChild(n)})}removeKerning(t){delete this.kerning[t],this.updateKerningList(),this.saveToLocalStorage()}updateStatus(t){const e=document.getElementById("status");e&&(e.textContent=t)}}let fontCreatorController,previewController;async function loadGCodeIntoPreview(t){if(t&&previewController)try{await previewController.loadGCodeFromString(t)}catch(t){console.error("Error loading GCode into preview:",t)}}window.addEventListener("DOMContentLoaded",()=>{const t=localStorage.getItem("theme")||"light";document.documentElement.setAttribute("data-theme",t),fontCreatorController=new FontCreatorController,fontCreatorController.setupCanvas(),fontCreatorController.setupCharacterSet(),fontCreatorController.setupFontCreatorControls(),fontCreatorController.setupTextToGCodeControls(),fontCreatorController.loadFromLocalStorage(),fontCreatorController.render(),setTimeout(()=>{previewController=new Controller;const t=document.getElementById("download-gcode");t&&t.addEventListener("click",()=>{fontCreatorController&&fontCreatorController.downloadGCode&&fontCreatorController.downloadGCode()})},100),document.getElementById("theme-toggle").onclick=()=>{const t=document.documentElement,e=t.getAttribute("data-theme");t.setAttribute("data-theme","light"===e?"dark":"light"),localStorage.setItem("theme",t.getAttribute("data-theme")),fontCreatorController.render(),previewController&&previewController.is3DView?previewController.renderer3d.render():previewController&&previewController.renderer2d.render()}}),document.querySelectorAll(".tab-button").forEach(t=>{t.addEventListener("click",()=>{const e=t.dataset.tab;document.querySelectorAll(".tab-button").forEach(t=>t.classList.remove("active")),t.classList.add("active"),document.querySelectorAll(".tab-content").forEach(t=>t.classList.remove("active")),document.getElementById(e).classList.add("active"),"gcode-preview"===e&&fontCreatorController&&fontCreatorController.generatedGCode&&setTimeout(()=>{loadGCodeIntoPreview(fontCreatorController.generatedGCode)},50)})});</script></body></html>

